<!DOCTYPE html>

<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin - Gestione Sistema</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { 
      --primary: #2563eb; 
      --success: #16a34a; 
      --warning: #d97706; 
      --danger: #dc2626; 
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
    }

```
* { box-sizing: border-box; }

body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  margin: 0; 
  background: var(--gray-50); 
  color: var(--gray-900);
  line-height: 1.6;
}

/* Header - Ottimizzato per mobile */
.header {
  background: white;
  border-bottom: 1px solid var(--gray-200);
  padding: 0.5rem 0;
  position: sticky;
  top: 0;
  z-index: 50;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

.header h1 {
  margin: 0 0 0.25rem 0;
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--gray-900);
}

.status-bar {
  margin-bottom: 0.5rem;
  padding: 0.375rem 0.5rem;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  font-weight: 500;
}

.status-success { background: #ecfdf5; color: var(--success); border: 1px solid #bbf7d0; }
.status-warning { background: #fffbeb; color: var(--warning); border: 1px solid #fed7aa; }
.status-error { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }

.login-form {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.375rem;
  align-items: center;
}

.login-inputs {
  display: flex;
  gap: 0.375rem;
  grid-column: span 2;
}

.login-buttons {
  display: flex;
  gap: 0.375rem;
  grid-column: span 2;
}

/* Container principale */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 1rem 0.75rem;
}

/* Sezioni */
.section {
  background: white;
  border-radius: 0.75rem;
  padding: 1rem;
  margin-bottom: 1.5rem;
  border: 1px solid var(--gray-200);
}

.section-title {
  font-size: 1.125rem;
  font-weight: 600;
  margin: 0 0 1rem 0;
  color: var(--gray-900);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.section-subtitle {
  font-size: 0.9rem;
  font-weight: 500;
  margin: 1.25rem 0 0.75rem 0;
  color: var(--gray-700);
}

/* Cards */
.card {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: 0.5rem;
  padding: 0.875rem;
  margin-bottom: 0.75rem;
}

.card-header {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.card-info h3 {
  margin: 0 0 0.25rem 0;
  font-size: 0.95rem;
  font-weight: 500;
  line-height: 1.4;
}

.card-info p {
  margin: 0;
  font-size: 0.8rem;
  color: var(--gray-500);
  line-height: 1.3;
}

.card-actions {
  display: flex;
  gap: 0.375rem;
  flex-wrap: wrap;
}

/* Form elements */
input, textarea, select {
  width: 100%;
  padding: 0.625rem;
  border: 1px solid var(--gray-300);
  border-radius: 0.375rem;
  font-size: 0.8rem;
  transition: border-color 0.15s;
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
}

.form-row {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  font-size: 0.8rem;
  font-weight: 500;
  margin-bottom: 0.25rem;
  color: var(--gray-700);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  padding: 0.5rem 0.75rem;
  border: none;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  font-weight: 500;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.15s;
  gap: 0.25rem;
  min-height: 36px;
  justify-content: center;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: #1d4ed8; }

.btn-secondary { background: var(--gray-100); color: var(--gray-700); }
.btn-secondary:hover { background: var(--gray-200); }

.btn-success { background: var(--success); color: white; }
.btn-success:hover { background: #15803d; }

.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #b91c1c; }

.btn-sm {
  padding: 0.375rem 0.5rem;
  font-size: 0.7rem;
  min-height: 32px;
}

/* Badge */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.125rem 0.375rem;
  border-radius: 9999px;
  font-size: 0.7rem;
  font-weight: 500;
  min-width: 1rem;
  text-align: center;
  justify-content: center;
}

.badge-gray { background: var(--gray-100); color: var(--gray-700); }
.badge-red { background: #fee2e2; color: var(--danger); }

/* Grid layouts */
.users-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

/* Preview area */
.preview-area {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: 0.5rem;
  padding: 0.875rem;
  max-height: 250px;
  overflow-y: auto;
  margin: 1rem 0;
}

.preview-item {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 0.375rem;
  padding: 0.625rem;
  margin-bottom: 0.5rem;
  font-size: 0.8rem;
}

/* Empty states */
.empty-state {
  text-align: center;
  padding: 1.5rem;
  color: var(--gray-500);
  font-size: 0.8rem;
}

/* Mobile specific optimizations */
@media (max-width: 480px) {
  .header {
    padding: 0.375rem 0;
  }
  
  .header-content {
    padding: 0 0.75rem;
  }
  
  .header h1 {
    font-size: 1rem;
    margin-bottom: 0.25rem;
  }
  
  .status-bar {
    font-size: 0.7rem;
    padding: 0.25rem 0.375rem;
    margin-bottom: 0.375rem;
  }
  
  .login-inputs {
    flex-direction: column;
  }
  
  .login-inputs input {
    font-size: 0.8rem;
    padding: 0.5rem;
  }
  
  .login-buttons .btn {
    flex: 1;
    font-size: 0.7rem;
    padding: 0.5rem 0.25rem;
  }
  
  .container {
    padding: 0.75rem 0.5rem;
  }
  
  .section {
    padding: 0.875rem;
    margin-bottom: 1rem;
    border-radius: 0.5rem;
  }
  
  .section-title {
    font-size: 1rem;
  }
  
  .card {
    padding: 0.75rem;
  }
  
  .card-actions .btn {
    flex: 1;
  }
  
  .form-row {
    gap: 0.5rem;
  }
  
  input, textarea, select {
    padding: 0.5rem;
    font-size: 0.8rem;
  }
}

@media (min-width: 481px) and (max-width: 768px) {
  .login-form {
    grid-template-columns: 1fr 1fr;
  }
  
  .form-row {
    grid-template-columns: 1fr 1fr;
  }
  
  .users-grid {
    grid-template-columns: 1fr;
  }
}

@media (min-width: 769px) {
  .login-form {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  
  .login-inputs, .login-buttons {
    display: contents;
  }
  
  .users-grid {
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
  }
  
  .form-row {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
}

/* Chat panel ottimizzato per mobile */
.chat-panel {
  position: fixed;
  top: 0;
  right: 0;
  width: 100%;
  height: 100vh;
  background: white;
  border-left: 1px solid var(--gray-200);
  box-shadow: -10px 0 25px rgba(0, 0, 0, 0.1);
  transform: translateX(100%);
  transition: transform 0.3s ease;
  z-index: 100;
  display: flex;
  flex-direction: column;
}

.chat-panel.open {
  transform: translateX(0);
}

.chat-panel-header {
  padding: 0.75rem;
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 500;
  font-size: 0.9rem;
  background: var(--gray-50);
}

.chat-iframe {
  border: 0;
  width: 100%;
  height: calc(100vh - 50px);
  display: block;
}

@media (min-width: 769px) {
  .chat-panel {
    width: min(560px, 100%);
  }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
  .btn {
    min-height: 44px;
    font-size: 0.8rem;
  }
  
  .btn-sm {
    min-height: 36px;
  }
  
  input, textarea, select {
    min-height: 44px;
    font-size: 16px; /* Previene zoom su iOS */
  }
}

/* Priorit√† visiva per utenti approvati */
.approved-section {
  order: 1;
}

.pending-section {
  order: 2;
}
```

  </style>
</head>
<body>
  <!-- Header compatto per mobile -->
  <header class="header">
    <div class="header-content">
      <h1>Admin Panel</h1>

```
  <div id="status" class="status-bar status-warning">Accesso necessario</div>
  
  <div class="login-form">
    <div class="login-inputs">
      <input id="email" placeholder="Email" type="email">
      <input id="pass" placeholder="Password" type="password">
    </div>
    <div class="login-buttons">
      <button id="btn-login" class="btn btn-primary">Login</button>
      <button id="btn-logout" class="btn btn-secondary">Esci</button>
      <a href="console.html" class="btn btn-primary">Chat</a>
    </div>
  </div>
</div>
```

  </header>

  <div class="container">
    <!-- Gestione Utenti -->
    <div class="users-grid">
      <div class="section approved-section">
        <h2 class="section-title">
          Utenti Approvati  
          <span id="count-approved" class="badge badge-gray">0</span>
        </h2>
        <div id="approved" class="empty-state">
          Effettua il login per vedere gli utenti approvati
        </div>
      </div>

```
  <div class="section pending-section">
    <h2 class="section-title">
      In Attesa
      <span id="count-pending" class="badge badge-gray">0</span>
    </h2>
    <div id="pending" class="empty-state">
      Effettua il login per vedere gli utenti in attesa
    </div>
  </div>
</div>

<!-- Gestione Rubrica -->
<div id="rubrica-section" class="section" style="display:none;">
  <h2 class="section-title">Rubrica Aziendale</h2>
  
  <h3 class="section-subtitle">Nuovo Contatto</h3>
  <div class="form-row">
    <input id="rubrica-nome" placeholder="Nome/Azienda">
    <input id="rubrica-telefono" placeholder="Telefono">
  </div>
  
  <div class="form-row">
    <input id="rubrica-email" placeholder="Email">
  </div>
  
  <div class="form-group">
    <textarea id="rubrica-note" placeholder="Note" rows="2"></textarea>
  </div>
  
  <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
    <button id="btn-add-contact" class="btn btn-success">Aggiungi</button>
    <button id="btn-cancel-contact" class="btn btn-secondary" style="display:none;">Annulla</button>
  </div>

  <h3 class="section-subtitle">
    Contatti 
    <span id="count-contacts" class="badge badge-gray">0</span>
  </h3>
  <div id="contacts-list"></div>
</div>

<!-- Importazione Clienti -->
<div id="import-section" class="section" style="display:none;">
  <h2 class="section-title">Import Clienti</h2>
  
  <div class="form-group">
    <label>File Clienti</label>
    <input type="file" id="clientFile" accept=".csv,.xlsx,.xls,.json">
    <div style="font-size: 0.7rem; color: var(--gray-500); margin-top: 0.25rem;">
      CSV, Excel, JSON/GeoJSON
    </div>
  </div>
  
  <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
    <button id="btn-load-file" class="btn btn-primary">Analizza</button>
    <button id="btn-import-sample" class="btn btn-secondary">Esempio</button>
  </div>
  
  <div id="import-status" style="display: none;"></div>
  
  <div id="import-preview" style="display: none;">
    <h3 class="section-subtitle">Anteprima</h3>
    <div id="preview-content" class="preview-area"></div>
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
      <button id="btn-confirm-import" class="btn btn-success">Conferma</button>
      <button id="btn-cancel-import" class="btn btn-secondary">Annulla</button>
    </div>
  </div>
</div>
```

  </div>

  <!-- Chat Panel -->

  <div id="chatPanel" class="chat-panel">
    <div class="chat-panel-header">
      <strong id="chatTitle">Chat</strong>
      <button id="closeChat" class="btn btn-secondary btn-sm">√ó</button>
    </div>
    <iframe id="chatFrame" class="chat-iframe" src="about:blank" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBbjK5sgQ70-p8jODaK_PnLIzPxgfrqQ34",
      authDomain: "archivio-clienti-trasporti.firebaseapp.com",
      projectId: "archivio-clienti-trasporti",
      storageBucket: "archivio-clienti-trasporti.firebasestorage.app",
      messagingSenderId: "773533170263",
      appId: "1:773533170263:web:d05e2b00e991b0294c0112"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, query, where, onSnapshot, updateDoc, doc, deleteDoc,
      orderBy, limit, addDoc, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig, "adminApp");
    const db = getFirestore(app);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);

    const ADMIN_UID = "0dCvHDcVp1PHuWVNIN9i6ZvEVBt2";

    const $ = id => document.getElementById(id);
    
    const setStatus = (type, msg) => {
      const status = $("status");
      status.className = `status-bar status-${type}`;
      status.textContent = msg;
    };

    // Chat panel
    const chatPanel = $("chatPanel");
    const chatFrame = $("chatFrame");
    const chatTitle = $("chatTitle");

    $("closeChat").addEventListener("click", () => {
      chatPanel.classList.remove("open");
      chatFrame.src = "about:blank";
    });

    // Login/Logout
    $("btn-login").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const pass = $("pass").value;
      
      if (!email || !pass) {
        setStatus("error", "Inserisci email e password");
        return;
      }
      
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        setStatus("error", "Login fallito: " + (e.code || e.message));
      }
    });

    $("btn-logout").addEventListener("click", () => signOut(auth));

    // Variabili globali
    let pendingUnsub = null, approvedUnsub = null, contactsUnsub = null;
    let editingContactId = null;
    let parsedClienti = [];
    let validClienti = [];

    // Funzioni per badge messaggi non letti
    function watchUnreadBadgeForDriver(uid) {
      const msgsRef = collection(db, "threads", uid, "messages");
      const qRecent = query(msgsRef, orderBy("createdAt", "desc"), limit(50));
      
      return onSnapshot(qRecent, (snap) => {
        let count = 0;
        snap.forEach(d => {
          const m = d.data();
          const rb = Array.isArray(m.readBy) ? m.readBy : [];
          if (!rb.includes(ADMIN_UID) && m.sender !== ADMIN_UID) count++;
        });
        
        const badge = document.querySelector(`.badge-unread[data-uid="${uid}"]`);
        if (badge) {
          if (count > 0) {
            badge.textContent = String(count);
            badge.className = "badge badge-red badge-unread";
          } else {
            badge.textContent = "0";
            badge.className = "badge badge-gray badge-unread";
          }
        }
      });
    }

    // Gestione chat inline
    function attachInlineChatHandlers(container) {
      container.querySelectorAll(".open-inline").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const uid = e.currentTarget.dataset.uid;
          const name = e.currentTarget.dataset.name || uid;
          
          if (!uid) {
            alert("Impossibile aprire la chat: UID mancante");
            return;
          }
          
          chatTitle.textContent = `Chat: ${name}`;
          chatFrame.src = `chat.html?uid=${encodeURIComponent(uid)}&iframe=1`;
          chatPanel.classList.add("open");
        });
      });
    }

    // Aggiornamento nome driver
    window.updateDriverName = async function(uid) {
      const input = document.getElementById(`name-input-${uid}`);
      if (!input) return;
      
      const newName = input.value.trim();
      if (!newName) {
        alert("Inserisci un nome valido");
        return;
      }
      
      try {
        await updateDoc(doc(db, "users", uid), { name: newName });
        setStatus("success", `Nome aggiornato per ${newName}`);
      } catch (error) {
        setStatus("error", "Errore nell'aggiornamento del nome");
      }
    };

    // Gestione rubrica
    async function addOrEditContact() {
      const nome = $("rubrica-nome").value.trim();
      const telefono = $("rubrica-telefono").value.trim();
      const email = $("rubrica-email").value.trim();
      const note = $("rubrica-note").value.trim();

      if (!nome) {
        alert("Inserisci almeno il nome/azienda");
        return;
      }

      const contactData = { nome, telefono, email, note, updatedAt: serverTimestamp() };

      try {
        if (editingContactId) {
          await updateDoc(doc(db, "rubrica", editingContactId), contactData);
          setStatus("success", "Contatto aggiornato");
          cancelEditContact();
        } else {
          await addDoc(collection(db, "rubrica"), {
            ...contactData,
            createdAt: serverTimestamp(),
            createdBy: "admin"
          });
          setStatus("success", "Contatto aggiunto");
        }
        clearContactForm();
      } catch (error) {
        setStatus("error", "Errore nella gestione del contatto");
      }
    }

    function clearContactForm() {
      $("rubrica-nome").value = "";
      $("rubrica-telefono").value = "";
      $("rubrica-email").value = "";
      $("rubrica-note").value = "";
    }

    function editContact(id, contact) {
      editingContactId = id;
      $("rubrica-nome").value = contact.nome || "";
      $("rubrica-telefono").value = contact.telefono || "";
      $("rubrica-email").value = contact.email || "";
      $("rubrica-note").value = contact.note || "";
      $("btn-add-contact").textContent = "Aggiorna";
      $("btn-cancel-contact").style.display = "inline-block";
    }

    function cancelEditContact() {
      editingContactId = null;
      $("btn-add-contact").textContent = "Aggiungi";
      $("btn-cancel-contact").style.display = "none";
      clearContactForm();
    }

    async function deleteContact(id, nome) {
      if (!confirm(`Eliminare "${nome}"?`)) return;
      
      try {
        await deleteDoc(doc(db, "rubrica", id));
        setStatus("success", "Contatto eliminato");
      } catch (error) {
        setStatus("error", "Errore nell'eliminazione del contatto");
      }
    }

    // Render functions
    function renderContacts(snapshot) {
      const container = $("contacts-list");
      const count = $("count-contacts");
      
      container.innerHTML = "";
      count.textContent = String(snapshot.size);

      if (snapshot.empty) {
        container.innerHTML = '<div class="empty-state">Nessun contatto</div>';
        return;
      }

      snapshot.forEach(docSnap => {
        const contact = docSnap.data();
        const id = docSnap.id;
        
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header">
            <div class="card-info">
              <h3>${contact.nome || "(senza nome)"}</h3>
              <p>
                ${contact.telefono ? `üìû ${contact.telefono}` : ""}
                ${contact.telefono && contact.email ? " ‚Ä¢ " : ""}
                ${contact.email ? `üìß ${contact.email}` : ""}
              </p>
              ${contact.note ? `<p><em>${contact.note}</em></p>` : ""}
            </div>
          </div>
          <div class="card-actions">
            <button onclick="editContact('${id}', ${JSON.stringify(contact).replace(/"/g, '&quot;')})" 
                    class="btn btn-secondary btn-sm">Edit</button>
            <button onclick="deleteContact('${id}', '${contact.nome || 'Contatto'}')" 
                    class="btn btn-danger btn-sm">Del</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderUsers(containerId, countId, snap, type) {
      const container = $(containerId);
      const count = $(countId);
      
      container.innerHTML = "";
      count.textContent = String(snap.size);

      if (snap.empty) {
        container.innerHTML = `<div class="empty-state">Nessun utente ${type}</div>`;
        return;
      }

      snap.forEach(d => {
        const u = d.data();
        const uid = d.id;
        
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header">
            <div class="card-info">
              <h3>
                ${u.name || "(senza nome)"}
                ${type !== "in attesa" ? `<span class="badge badge-gray badge-unread" data-uid="${uid}">0</span>` : ""}
              </h3>
              <p>${u.email || ""}</p>
              ${type !== "in attesa" ? `
                <div style="display: flex; gap: 0.375rem; margin-top: 0.5rem;">
                  <input type="text" placeholder="Nome" value="${u.name || ""}" 
                         style="flex: 1; font-size: 0.75rem;" id="name-input-${uid}">
                  <button onclick="updateDriverName('${uid}')" class="btn btn-secondary btn-sm">
                    ‚úì
                  </button>
                </div>
              ` : ""}
            </div>
          </div>
          <div class="card-actions">
            ${type === "in attesa" 
              ? `<button data-uid="${uid}" class="approve btn btn-success btn-sm">Approva</button>`
              : `
                <button data-uid="${uid}" class="revoke btn btn-secondary btn-sm">Revoca</button>
                <button data-uid="${uid}" class="remove btn btn-danger btn-sm">Del</button>
                <a class="btn btn-primary btn-sm" href="chat.html?uid=${uid}" target="_blank">Chat</a>
                <button data-uid="${uid}" data-name="${u.name || uid}" class="open-inline btn btn-secondary btn-sm">Chat qui</button>
              `
            }
          </div>
        `;
        container.appendChild(card);

        if (type !== "in attesa") {
          watchUnreadBadgeForDriver(uid);
        }
      });

      // Attach event handlers
      attachInlineChatHandlers(container);

      container.querySelectorAll(".approve").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const uid = e.currentTarget.getAttribute("data-uid");
          await updateDoc(doc(db, "users", uid), { approved: true, role: "driver" });
          setStatus("success", "Utente approvato");
        });
      });

      container.querySelectorAll(".revoke").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const uid = e.currentTarget.getAttribute("data-uid");
          if (!confirm("Revocare l'accesso?")) return;
          
          await updateDoc(doc(db, "users", uid), { approved: false });
          setStatus("success", "Accesso revocato");
        });
      });

      container.querySelectorAll(".remove").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const uid = e.currentTarget.getAttribute("data-uid");
          if (!confirm("Eliminare il record utente?")) return;
          
          await deleteDoc(doc(db, "users", uid));
          setStatus("success", "Record utente eliminato");
        });
      });
    }

    // Importazione clienti
    $("btn-load-file").addEventListener("click", async () => {
      const fileInput = $("clientFile");
      const file = fileInput.files[0];

      if (!file) {
        showImportStatus("Seleziona un file", "error");
        return;
      }

      showImportStatus("Analisi in corso...", "");

      try {
        if (file.name.endsWith('.json')) {
          await parseJSONFile(file);
        } else if (file.name.endsWith('.csv')) {
          await parseCSVFile(file);
        } else {
          showImportStatus("Formato non supportato", "error");
          return;
        }

        validateAndShowPreview();
      } catch (error) {
        showImportStatus(`Errore: ${error.message}`, "error");
      }
    });

    $("btn-import-sample").addEventListener("click", () => {
      parsedClienti = [
        {
          nome: "Casa", indirizzo: "Vicolo Mercanti, 50B/1, 46019 Viadana MN",
          coordinate: "44.932604, 10.531342", note: "Residenza principale"
        },
        {
          nome: "Lavoro", indirizzo: "Via Werter Asseverati, 1, 42122 Reggio nell'Emilia RE",
          coordinate: "44.67239, 10.71315", note: "Ufficio"
        },
        {
          nome: "Bignotti", indirizzo: "Localita' Casa Nuova, 51, 43039 Salsominore PR",
          coordinate: "44.79644, 9.93591", note: "Cliente agricolo"
        }
      ];
      validateAndShowPreview();
    });

    $("btn-confirm-import").addEventListener("click", async () => {
      if (validClienti.length === 0) return;

      showImportStatus(`Importazione ${validClienti.length} clienti...`, "");

      try {
        const clientiRef = collection(db, "clienti");
        let imported = 0;

        for (const cliente of validClienti) {
          await addDoc(clientiRef, {
            ...cliente,
            createdAt: serverTimestamp(),
            createdBy: { uid: "admin", name: "Amministratore", email: "admin@sistema.com" }
          });
          imported++;
        }

        showImportStatus(`Importati ${imported} clienti`, "success");
        resetImportForm();
      } catch (error) {
        showImportStatus(`Errore importazione: ${error.message}`, "error");
      }
    });

    $("btn-cancel-import").addEventListener("click", resetImportForm);

    // Parser functions
    async function parseJSONFile(file) {
      const text = await file.text();
      const data = JSON.parse(text);

      if (data.features && Array.isArray(data.features)) {
        parsedClienti = data.features.map(feature => ({
          nome: feature.properties.name || feature.properties.nome || 'Cliente senza nome',
          indirizzo: feature.properties.address || feature.properties.indirizzo || '',
          coordinate: feature.geometry.coordinates && feature.geometry.coordinates.length >= 2 ?
            `${feature.geometry.coordinates[1]}, ${feature.geometry.coordinates[0]}` : '',
          note: feature.properties.note || ''
        }));
      } else if (Array.isArray(data)) {
        parsedClienti = data.map(item => ({
          nome: item.nome || item.name || 'Cliente senza nome',
          indirizzo: item.indirizzo || item.address || '',
          coordinate: item.coordinate || item.coordinates || '',
          note: item.note || item.notes || ''
        }));
      } else {
        throw new Error('Formato JSON non riconosciuto');
      }
    }

    async function parseCSVFile(file) {
      const text = await file.text();
      const lines = text.split('\n').filter(line => line.trim());

      if (lines.length < 2) {
        throw new Error('File CSV vuoto');
      }

      const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));

      parsedClienti = lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim().replace(/['"]/g, ''));
        const obj = {};

        headers.forEach((header, index) => {
          obj[header.toLowerCase()] = values[index] || '';
        });

        return {
          nome: obj.nome || obj.name || 'Cliente senza nome',
          indirizzo: obj.indirizzo || obj.address || '',
          coordinate: obj.coordinate || obj.coordinates || '',
          note: obj.note || obj.notes || ''
        };
      });
    }

    function validateAndShowPreview() {
      validClienti = [];
      const errors = [];

      parsedClienti.forEach((item, index) => {
        if (!item.nome || item.nome.trim() === '') {
          errors.push(`Riga ${index + 1}: Nome mancante`);
          return;
        }

        validClienti.push({
          nome: item.nome.trim(),
          indirizzo: (item.indirizzo || '').trim(),
          coordinate: (item.coordinate || '').trim(),
          note: (item.note || '').trim()
        });
      });

      if (validClienti.length > 0) {
        showImportStatus(`Trovati ${validClienti.length} clienti validi`, "success");
        showPreview(validClienti.slice(0, 5));
      } else {
        showImportStatus("Nessun cliente valido trovato", "error");
      }
    }

    function showPreview(clienti) {
      const preview = $("import-preview");
      const content = $("preview-content");

      let html = `<div><strong>Preview ${validClienti.length} clienti:</strong></div>`;

      clienti.forEach(cliente => {
        html += `
          <div class="preview-item">
            <strong>${cliente.nome}</strong><br>
            <small style="color: var(--gray-500);">${cliente.indirizzo || 'Nessun indirizzo'}</small><br>
            ${cliente.coordinate ? `<small>üìç ${cliente.coordinate}</small><br>` : ''}
            ${cliente.note ? `<em><small>${cliente.note}</small></em>` : ''}
          </div>
        `;
      });

      if (validClienti.length > 5) {
        html += `<div style="text-align: center; color: var(--gray-500); margin-top: 0.75rem;">...e altri ${validClienti.length - 5} clienti</div>`;
      }

      content.innerHTML = html;
      preview.style.display = "block";
    }

    function showImportStatus(message, type) {
      const status = $("import-status");
      status.textContent = message;
      status.style.display = "block";

      status.className = `status-bar status-${type}`;
    }

    function resetImportForm() {
      $("clientFile").value = '';
      $("import-preview").style.display = "none";
      $("import-status").style.display = "none";
      parsedClienti = [];
      validClienti = [];
    }

    // Event listeners
    $("btn-add-contact").addEventListener("click", addOrEditContact);
    $("btn-cancel-contact").addEventListener("click", cancelEditContact);

    // Global functions
    window.editContact = editContact;
    window.deleteContact = deleteContact;

    // Main listeners management
    function startListeners() {
      if (!pendingUnsub) {
        const qPending = query(collection(db, "users"),
          where("role", "==", "driver"),
          where("approved", "==", false));
        pendingUnsub = onSnapshot(qPending, (snap) => renderUsers("pending", "count-pending", snap, "in attesa"));
      }

      if (!approvedUnsub) {
        const qApproved = query(collection(db, "users"),
          where("role", "==", "driver"),
          where("approved", "==", true));
        approvedUnsub = onSnapshot(qApproved, (snap) => renderUsers("approved", "count-approved", snap, "approvati"));
      }

      if (!contactsUnsub) {
        const qContacts = query(collection(db, "rubrica"), orderBy("nome", "asc"));
        contactsUnsub = onSnapshot(qContacts, renderContacts);
      }

      $("rubrica-section").style.display = "block";
      $("import-section").style.display = "block";
    }

    function stopListeners() {
      if (pendingUnsub) { pendingUnsub(); pendingUnsub = null; }
      if (approvedUnsub) { approvedUnsub(); approvedUnsub = null; }
      if (contactsUnsub) { contactsUnsub(); contactsUnsub = null; }

      $("count-pending").textContent = "0";
      $("count-approved").textContent = "0";
      $("count-contacts").textContent = "0";
      $("pending").innerHTML = '<div class="empty-state">Effettua il login per vedere gli utenti in attesa</div>';
      $("approved").innerHTML = '<div class="empty-state">Effettua il login per vedere gli utenti approvati</div>';
      $("contacts-list").innerHTML = "";

      $("rubrica-section").style.display = "none";
      $("import-section").style.display = "none";
      cancelEditContact();
      resetImportForm();
    }

    // Auth state changes
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        setStatus("warning", "Accesso necessario");
        stopListeners();
        $("email").disabled = false;
        $("pass").disabled = false;
        $("btn-login").disabled = false;
        return;
      }

      $("email").disabled = true;
      $("pass").disabled = true;
      $("btn-login").disabled = true;

      if (user.uid === ADMIN_UID) {
        setStatus("success", `Benvenuto ${user.email}`);
        startListeners();
      } else {
        setStatus("warning", `${user.email} - Non hai permessi admin`);
        stopListeners();
      }
    });

    // Test function for deleting admin clients
    window.eliminaClientiTest = async function() {
      const conferma = confirm("Eliminare tutti i clienti importati dall'admin?");
      if (!conferma) return;

      try {
        const clientiRef = collection(db, "clienti");
        const snapshot = await getDocs(clientiRef);

        let eliminati = 0;
        for (const docSnap of snapshot.docs) {
          const cliente = docSnap.data();
          if (cliente.createdBy?.uid === "admin" || cliente.createdBy?.name === "Amministratore") {
            await deleteDoc(doc(db, "clienti", docSnap.id));
            eliminati++;
          }
        }

        alert(`Eliminati ${eliminati} clienti!`);
        setStatus("success", `Eliminati ${eliminati} clienti importati`);
      } catch (error) {
        alert("Errore: " + error.message);
      }
    };
  </script>

</body>
</html>
