<!DOCTYPE html>

<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin - Gestione Sistema</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { 
      --primary: #2563eb; 
      --success: #16a34a; 
      --warning: #d97706; 
      --danger: #dc2626; 
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
    }

    * { box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0; 
      background: var(--gray-50); 
      color: var(--gray-900);
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 0.25rem 0;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .status-bar {
      margin-bottom: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-success { background: #ecfdf5; color: var(--success); border: 1px solid #bbf7d0; }
    .status-warning { background: #fffbeb; color: var(--warning); border: 1px solid #fed7aa; }
    .status-error { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }

    .login-form {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
      align-items: center;
    }

    /* Container principale */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Sezioni */
    .section {
      background: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--gray-200);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 1rem 0;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .section-subtitle {
      font-size: 1rem;
      font-weight: 500;
      margin: 1.5rem 0 0.75rem 0;
      color: var(--gray-700);
    }

    /* Cards */
    .card {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    .card-info h3 {
      margin: 0 0 0.25rem 0;
      font-size: 1rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .card-info p {
      margin: 0 0 0.5rem 0;
      font-size: 0.875rem;
      color: var(--gray-500);
    }

    .card-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .name-update {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .name-update input {
      flex: 1;
      min-width: 150px;
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }

    /* Form elements */
    input, textarea, select {
      width: 100%;
      padding: 0.4rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.25rem;
      font-size: 0.75rem;
      transition: border-color 0.15s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: var(--gray-700);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      padding: 0.625rem 1rem;
      border: none;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.15s;
      gap: 0.25rem;
      text-align: center;
      justify-content: center;
      white-space: nowrap;
      min-height: 44px; /* Miglior tocco su mobile */
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: #1d4ed8; }

    .btn-secondary { background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--gray-300); }
    .btn-secondary:hover { background: var(--gray-200); }

    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #15803d; }

    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #b91c1c; }

    .btn-sm {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      min-height: 36px;
    }

    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      min-width: 1.25rem;
      text-align: center;
      justify-content: center;
    }

    .badge-gray { background: var(--gray-100); color: var(--gray-700); }
    .badge-red { background: #fee2e2; color: var(--danger); }
    .badge-green { background: #dcfce7; color: var(--success); }

    /* Grid layouts - mobile first */
    .users-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    /* Preview area */
    .preview-area {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 0.5rem;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      margin: 1rem 0;
    }

    .preview-item {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }

    /* Empty states */
    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    /* Toast notifiche */
    .toast-container { 
      position: fixed; 
      top: 20px; 
      right: 20px; 
      z-index: 10000; 
      max-width: 320px; 
    }
    
    .toast {
      background:#fff; border:1px solid #e0e0e0; border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.15);
      padding:16px; margin-bottom:12px;
      transform:translateX(100%); transition:all .3s cubic-bezier(.4,0,.2,1);
      cursor:pointer; position:relative; overflow:hidden;
    }
    .toast.show { transform:translateX(0); }
    .toast.hide { transform:translateX(100%); opacity:0; }
    .toast::before { content:""; position:absolute; top:0; left:0; width:4px; height:100%; background:var(--primary); }
    .toast-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; font-weight:600; font-size:14px; color:var(--primary); }
    .toast-body { color:#333; font-size:14px; line-height:1.4; margin-left:24px; }
    .toast-close {
      position:absolute; top:8px; right:8px; width:24px; height:24px;
      background:none; border:none; font-size:18px; color:#999; cursor:pointer;
      display:flex; align-items:center; justify-content:center; border-radius:50%;
      transition: background-color .2s;
    }
    .toast-close:hover { background-color:#f0f0f0; }

    /* Advanced toast */
    .advanced-toast {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-left: 4px solid var(--primary);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.15);
      padding: 0;
      margin-bottom: 12px;
      transform: translateX(100%);
      transition: all .3s cubic-bezier(.4,0,.2,1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      min-width: 320px;
      max-width: 400px;
    }

    .advanced-toast.show { transform: translateX(0); }
    .advanced-toast.hide { transform: translateX(100%); opacity: 0; }

    .advanced-toast .toast-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--primary);
      border-bottom: 1px solid #f0f0f0;
    }

    .advanced-toast .toast-body {
      color: #333;
      font-size: 14px;
      line-height: 1.4;
      padding: 8px 16px;
    }

    .advanced-toast .toast-actions {
      padding: 8px 16px 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .advanced-toast .toast-action-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .advanced-toast .toast-action-btn:hover {
      background: #1d4ed8;
    }

    .advanced-toast .toast-close {
      position: absolute;
      top: 8px;
      right: 12px;
      width: 20px;
      height: 20px;
      background: none;
      border: none;
      font-size: 16px;
      color: #999;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color .2s;
    }

    .advanced-toast .toast-close:hover {
      background-color: #f0f0f0;
    }

    /* Chat panel */
    .chat-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: min(560px, 100%);
      height: 100vh;
      background: white;
      border-left: 1px solid var(--gray-200);
      box-shadow: -10px 0 25px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .chat-panel.open {
      transform: translateX(0);
    }

    .chat-panel-header {
      padding: 1rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 500;
    }

    .chat-iframe {
      border: 0;
      width: 100%;
      height: calc(100vh - 60px);
      display: block;
    }

    /* Desktop media query */
    @media (min-width: 768px) {
      .header-content {
        padding: 0 1.5rem;
      }
      
      .container {
        padding: 1.5rem;
      }
      
      .section {
        padding: 2rem;
      }

      .users-grid {
        grid-template-columns: 2fr 1fr;
      }

      .form-row {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .card-header {
        flex-direction: row;
        align-items: flex-start;
      }

      .card-actions {
        justify-content: flex-start;
      }

      .name-update {
        flex-wrap: nowrap;
      }

      .name-update input {
        min-width: 200px;
      }
    }

    /* Large desktop */
    @media (min-width: 1024px) {
      .section-title {
        flex-wrap: nowrap;
      }
      
      .btn {
        white-space: nowrap;
      }
    }

    /* Mobile-specific improvements */
    @media (max-width: 767px) {
      .login-form {
        flex-direction: column;
        align-items: stretch;
      }

      .login-form input {
        margin-bottom: 0.25rem;
      }

      .login-form button {
        width: 100%;
      }

      .section-title {
        font-size: 0,5rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }

      .section-title .btn {
        width: 100%;
      }

      .card-actions {
        flex-direction: column;
      }

      .card-actions .btn {
        width: 100%;
      }

      .name-update {
        flex-direction: column;
      }

      .name-update input {
        min-width: unset;
      }

      .toast-container {
        left: 10px;
        right: 10px;
        top: 10px;
        max-width: unset;
      }

      .advanced-toast {
        min-width: unset;
        max-width: unset;
      }
    }

    /* Toast su mobile */
    @media (max-width: 480px) {
      .toast-container {
        left: 10px;
        right: 10px;
        top: 80px; /* Sotto l'header sticky */
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1>Pannello Amministratore</h1>
      
      <div id="status" class="status-bar status-warning">Accesso necessario</div>
      
      <div class="login-form">
        <input id="email" placeholder="Email admin" type="email">
        <input id="pass" placeholder="Password" type="password">
        <button id="btn-login" class="btn btn-primary">Accedi</button>
        <button id="btn-logout" class="btn btn-secondary">Esci</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Gestione Utenti -->
    <div class="users-grid">
      <div class="section approved-section">
        <h2 class="section-title">
          Utenti Approvati  
          <span id="count-approved" class="badge badge-green">0</span>
          <a href="console.html" class="btn btn-primary btn-sm">Apri Chat Driver</a>
        </h2>
        <div id="approved" class="empty-state">
          Effettua il login per vedere gli utenti approvati
        </div>
      </div>

      <div class="section pending-section">
        <h2 class="section-title">
          In Attesa di Approvazione
          <span id="count-pending" class="badge badge-gray">0</span>
        </h2>
        <div id="pending" class="empty-state">
          Effettua il login per vedere gli utenti in attesa
        </div>
      </div>
    </div>

    <!-- Gestione Rubrica -->
    <div id="rubrica-section" class="section" style="display:none;">
      <h2 class="section-title">Gestione Rubrica Aziendale</h2>
      
      <h3 class="section-subtitle">Aggiungi Nuovo Contatto</h3>
      <div class="form-row">
        <input id="rubrica-nome" placeholder="Nome/Azienda">
        <input id="rubrica-telefono" placeholder="Telefono">
        <input id="rubrica-email" placeholder="Email">
      </div>
      
      <div class="form-group">
        <textarea id="rubrica-note" placeholder="Note aggiuntive" rows="3"></textarea>
      </div>
      
      <div style="display: flex; gap: 0.75rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <button id="btn-add-contact" class="btn btn-success">Aggiungi Contatto</button>
        <button id="btn-cancel-contact" class="btn btn-secondary" style="display:none;">Annulla</button>
      </div>

      <h3 class="section-subtitle">
        Contatti Esistenti 
        <span id="count-contacts" class="badge badge-gray">0</span>
      </h3>
      <div id="contacts-list"></div>
    </div>

    <!-- Importazione Clienti -->
    <div id="import-section" class="section" style="display:none;">
      <h2 class="section-title">Importazione Clienti</h2>
      
      <div class="form-group">
        <label>File Clienti</label>
        <input type="file" id="clientFile" accept=".csv,.xlsx,.xls,.json">
        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">
          Formati supportati: CSV, Excel, JSON/GeoJSON
        </div>
      </div>
      
      <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <button id="btn-load-file" class="btn btn-primary">Analizza File</button>
        <button id="btn-import-sample" class="btn btn-secondary">Usa Dati Esempio</button>
      </div>
      
      <div id="import-status" style="display: none;"></div>
      
      <div id="import-preview" style="display: none;">
        <h3 class="section-subtitle">Anteprima Importazione</h3>
        <div id="preview-content" class="preview-area"></div>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
          <button id="btn-confirm-import" class="btn btn-success">Conferma Importazione</button>
          <button id="btn-cancel-import" class="btn btn-secondary">Annulla</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Panel -->
  <div id="chatPanel" class="chat-panel">
    <div class="chat-panel-header">
      <strong id="chatTitle">Chat</strong>
      <button id="closeChat" class="btn btn-secondary btn-sm">Chiudi</button>
    </div>
    <iframe id="chatFrame" class="chat-iframe" src="about:blank" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
  </div>

  <!-- Container toast -->
  <div id="toast-container" class="toast-container"></div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBbjK5sgQ70-p8jODaK_PnLIzPxgfrqQ34",
      authDomain: "archivio-clienti-trasporti.firebaseapp.com",
      projectId: "archivio-clienti-trasporti",
      storageBucket: "archivio-clienti-trasporti.firebasestorage.app",
      messagingSenderId: "773533170263",
      appId: "1:773533170263:web:d05e2b00e991b0294c0112"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, query, where, onSnapshot, updateDoc, doc, deleteDoc,
      orderBy, limit, addDoc, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig, "adminApp");
    const db = getFirestore(app);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);

    const ADMIN_UID = "0dCvHDcVp1PHuWVNIN9i6ZvEVBt2";

    const $ = id => document.getElementById(id);
    
    const setStatus = (type, msg) => {
      const status = $("status");
      status.className = `status-bar status-${type}`;
      status.textContent = msg;
    };

    // ======= FUNZIONI NOTIFICHE ADMIN =======
    
    function createToast(title, message, onClick) {
      const container = document.getElementById('toast-container') || createToastContainer();
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        <div class="toast-header"><span>üí¨</span>${title}</div>
        <div class="toast-body">${message}</div>
      `;
      if (onClick) {
        toast.addEventListener('click', (e) => {
          if (e.target.classList.contains('toast-close')) return;
          onClick(); hideToast(toast);
        });
      }
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => hideToast(toast), 6000);
      return toast;
    }

    function hideToast(toast) { 
      toast.classList.add('hide'); 
      setTimeout(() => { if(toast.parentElement) toast.remove(); }, 300); 
    }

    function createAdvancedToast(title, message, onClick) {
      const container = document.getElementById('toast-container') || createToastContainer();
      
      const toast = document.createElement('div');
      toast.className = 'toast advanced-toast';
      toast.innerHTML = `
        <div class="toast-header">
          <span>üîî</span>
          <strong>${title}</strong>
          <button class="toast-close">√ó</button>
        </div>
        <div class="toast-body">${message.length > 150 ? message.substring(0, 147) + '...' : message}</div>
        <div class="toast-actions">
          <button class="toast-action-btn">Apri Chat</button>
        </div>
      `;
      
      const closeBtn = toast.querySelector('.toast-close');
      const actionBtn = toast.querySelector('.toast-action-btn');
      
      closeBtn.onclick = () => hideAdvancedToast(toast);
      actionBtn.onclick = () => { if (onClick) onClick(); hideAdvancedToast(toast); };
      
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => hideAdvancedToast(toast), 10000);
      
      return toast;
    }

    function createToastContainer() {
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container';
        document.body.appendChild(container);
      }
      return container;
    }

    function hideAdvancedToast(toast) {
      toast.classList.remove('show');
      toast.classList.add('hide');
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 300);
    }

    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (error) {
        console.log('Suono notifica non disponibile');
      }
    }

    function showNewMessageNotification(senderName, messageText, driverUid) {
      // Notifica browser nativa
      if (Notification.permission === 'granted' && (document.hidden || !document.hasFocus())) {
        const notification = new Notification(`Nuovo messaggio da ${senderName}`, {
          body: messageText.length > 100 ? messageText.substring(0, 97) + '...' : messageText,
          icon: './icon192.png',
          tag: 'new-admin-message',
          requireInteraction: false,
          silent: false
        });
        
        notification.onclick = () => {
          window.focus();
          openInlineChat(driverUid, senderName);
          notification.close();
        };
        
        setTimeout(() => notification.close(), 8000);
      }
      
      // Toast visivo sempre
      createAdvancedToast(
        `üí¨ Nuovo messaggio da ${senderName}`, 
        messageText, 
        () => { openInlineChat(driverUid, senderName); }
      );
      
      // Suono notifica
      playNotificationSound();
    }

    function requestNotificationPermissionForAdmin() {
      if (Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            console.log('‚úÖ Notifiche admin autorizzate');
            createToast('üîî Notifiche attivate', 'Riceverai notifiche per i nuovi messaggi dai driver');
          }
        });
      }
    }

    // ======= SISTEMA BADGE POLLING PER SAFARI MOBILE =======
    let pollingInterval = null;
    let lastBadgeCounts = new Map();

    // Sistema di polling che controlla ogni 10 secondi
    function startBadgePollingForSafari() {
      if (pollingInterval) return; // Gi√† attivo
      
      console.log('üçé Avviato polling badge per Safari mobile');
      
      pollingInterval = setInterval(async () => {
        // Trova tutti i badge nella pagina
        const badges = document.querySelectorAll('.badge-unread[data-uid]');
        
        for (const badge of badges) {
          const uid = badge.dataset.uid;
          if (!uid) continue;
          
          try {
            // Controlla manualmente i messaggi non letti per questo driver
            const unreadCount = await getUnreadCountForDriver(uid);
            const previousCount = lastBadgeCounts.get(uid) || 0;
            
            // Aggiorna il badge
            updateBadgeVisually(badge, unreadCount);
            
            // Se ci sono nuovi messaggi, evidenzia
            if (unreadCount > previousCount && previousCount >= 0) {
              highlightNewMessage(badge, uid, unreadCount);
            }
            
            lastBadgeCounts.set(uid, unreadCount);
            
          } catch (error) {
            console.warn(`Errore polling per ${uid}:`, error);
          }
        }
      }, 10000); // Controlla ogni 10 secondi
    }

    function stopBadgePolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        lastBadgeCounts.clear();
        console.log('‚ùå Polling badge fermato');
      }
    }

    // Funzione per contare messaggi non letti
    async function getUnreadCountForDriver(uid) {
      try {
        const msgsRef = collection(db, "threads", uid, "messages");
        const q = query(msgsRef, orderBy("createdAt", "desc"), limit(50));
        const snapshot = await getDocs(q);
        
        let count = 0;
        let latestMessage = null;
        snapshot.forEach(doc => {
          const msg = doc.data();
          const readBy = Array.isArray(msg.readBy) ? msg.readBy : [];
          if (!readBy.includes(ADMIN_UID) && msg.sender !== ADMIN_UID) {
            count++;
            if (!latestMessage) {
              latestMessage = msg;
            }
          }
        });
        
        // Salva ultimo messaggio per notifiche
        if (latestMessage) {
          lastBadgeCounts.set(`${uid}_lastMsg`, latestMessage.text || '');
        }
        
        return count;
      } catch (error) {
        console.warn('Errore conteggio messaggi:', error);
        return 0;
      }
    }

    // Aggiorna visivamente il badge
    function updateBadgeVisually(badge, count) {
      if (count > 0) {
        badge.textContent = String(count);
        badge.className = "badge badge-red badge-unread";
        badge.style.display = "inline-flex";
      } else {
        badge.textContent = "0";
        badge.className = "badge badge-gray badge-unread";
      }
    }

    // Evidenzia nuovo messaggio con animazione
    function highlightNewMessage(badge, uid, newCount) {
      const card = badge.closest('.card');
      if (card) {
        // Animazione lampeggio
        card.style.border = '2px solid #ff4757';
        card.style.boxShadow = '0 0 10px rgba(255, 71, 87, 0.5)';
        
        setTimeout(() => {
          card.style.border = '';
          card.style.boxShadow = '';
        }, 3000);
        
        // Nome del driver
        const driverName = card.querySelector('h3').textContent.split('\n')[0].trim();
        const lastMsg = lastBadgeCounts.get(`${uid}_lastMsg`) || 'Nuovo messaggio';
        
        // Su Safari mobile usa confirm invece dei toast
        setTimeout(() => {
          if (confirm(`üì± Nuovo messaggio da ${driverName}: "${lastMsg}". Aprire chat?`)) {
            openInlineChat(uid, driverName);
          }
        }, 500);
      }
    }

    // Auto-avvio quando la pagina torna in primo piano (per Safari mobile)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && auth.currentUser?.uid === ADMIN_UID) {
        // Forza un controllo immediato quando torni sulla pagina
        setTimeout(() => {
          document.querySelectorAll('.badge-unread[data-uid]').forEach(badge => {
            const uid = badge.dataset.uid;
            getUnreadCountForDriver(uid).then(count => {
              updateBadgeVisually(badge, count);
              lastBadgeCounts.set(uid, count);
            });
          });
        }, 1000);
      }
    });

    // Controllo immediato all'avvio per caricare i badge
    function loadInitialBadgeCounts() {
      setTimeout(() => {
        document.querySelectorAll('.badge-unread[data-uid]').forEach(badge => {
          const uid = badge.dataset.uid;
          getUnreadCountForDriver(uid).then(count => {
            updateBadgeVisually(badge, count);
            lastBadgeCounts.set(uid, count);
          });
        });
      }, 2000);
    }

    // ======= FINE SISTEMA BADGE POLLING =======

    // Chat panel
    const chatPanel = $("chatPanel");
    const chatFrame = $("chatFrame");
    const chatTitle = $("chatTitle");

    $("closeChat").addEventListener("click", () => {
      chatPanel.classList.remove("open");
      chatFrame.src = "about:blank";
    });

    function openInlineChat(uid, name) {
      if (!uid) {
        alert("Impossibile aprire la chat: UID mancante");
        return;
      }
      
      chatTitle.textContent = `Chat con: ${name}`;
      chatFrame.src = `chat.html?uid=${encodeURIComponent(uid)}&iframe=1`;
      chatPanel.classList.add("open");
    }

    // Login/Logout
    $("btn-login").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const pass = $("pass").value;
      
      if (!email || !pass) {
        setStatus("error", "Inserisci email e password");
        return;
      }
      
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        setStatus("error", "Login fallito: " + (e.code || e.message));
      }
    });

    $("btn-logout").addEventListener("click", () => signOut(auth));

    // Variabili globali
    let pendingUnsub = null, approvedUnsub = null, contactsUnsub = null;
    let editingContactId = null;
    let parsedClienti = [];
    let validClienti = [];

    // Gestione chat inline
    function attachInlineChatHandlers(container) {
      container.querySelectorAll(".open-inline").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const uid = e.currentTarget.dataset.uid;
          const name = e.currentTarget.dataset.name || uid;
          openInlineChat(uid, name);
        });
      });
    }

    // Aggiornamento nome driver
    window.updateDriverName = async function(uid) {
      const input = document.getElementById(`name-input-${uid}`);
      if (!input) return;
      
      const newName = input.value.trim();
      if (!newName) {
        alert("Inserisci un nome valido");
        return;
      }
      
      try {
        await updateDoc(doc(db, "users", uid), { name: newName });
        setStatus("success", `Nome aggiornato per ${newName}`);
      } catch (error) {
        setStatus("error", "Errore nell'aggiornamento del nome");
      }
    };

    // Gestione rubrica
    async function addOrEditContact() {
      const nome = $("rubrica-nome").value.trim();
      const telefono = $("rubrica-telefono").value.trim();
      const email = $("rubrica-email").value.trim();
      const note = $("rubrica-note").value.trim();

      if (!nome) {
        alert("Inserisci almeno il nome/azienda");
        return;
      }

      const contactData = { nome, telefono, email, note, updatedAt: serverTimestamp() };

      try {
        if (editingContactId) {
          await updateDoc(doc(db, "rubrica", editingContactId), contactData);
          setStatus("success", "Contatto aggiornato");
          cancelEditContact();
        } else {
          await addDoc(collection(db, "rubrica"), {
            ...contactData,
            createdAt: serverTimestamp(),
            createdBy: "admin"
          });
          setStatus("success", "Contatto aggiunto");
        }
        clearContactForm();
      } catch (error) {
        setStatus("error", "Errore nella gestione del contatto");
      }
    }

    function clearContactForm() {
      $("rubrica-nome").value = "";
      $("rubrica-telefono").value = "";
      $("rubrica-email").value = "";
      $("rubrica-note").value = "";
    }

    function editContact(id, contact) {
      editingContactId = id;
      $("rubrica-nome").value = contact.nome || "";
      $("rubrica-telefono").value = contact.telefono || "";
      $("rubrica-email").value = contact.email || "";
      $("rubrica-note").value = contact.note || "";
      $("btn-add-contact").textContent = "Aggiorna Contatto";
      $("btn-cancel-contact").style.display = "inline-block";
    }

    function cancelEditContact() {
      editingContactId = null;
      $("btn-add-contact").textContent = "Aggiungi Contatto";
      $("btn-cancel-contact").style.display = "none";
      clearContactForm();
    }

    async function deleteContact(id, nome) {
      if (!confirm(`Eliminare il contatto "${nome}"?`)) return;
      
      try {
        await deleteDoc(doc(db, "rubrica", id));
        setStatus("success", "Contatto eliminato");
      } catch (error) {
        setStatus("error", "Errore nell'eliminazione del contatto");
      }
    }

    // Render functions
    function renderContacts(snapshot) {
      const container = $("contacts-list");
      const count = $("count-contacts");
      
      container.innerHTML = "";
      count.textContent = String(snapshot.size);

      if (snapshot.empty) {
        container.innerHTML = '<div class="empty-state">Nessun contatto in rubrica</div>';
        return;
      }

      snapshot.forEach(docSnap => {
        const contact = docSnap.data();
        const id = docSnap.id;
        
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header">
            <div class="card-info">
              <h3>${contact.nome || "(senza nome)"}</h3>
              <p>
                ${contact.telefono ? `üìû ${contact.telefono}` : ""}
                ${contact.telefono && contact.email ? " ‚Ä¢ " : ""}
                ${contact.email ? `üìß ${contact.email}` : ""}
              </p>
              ${contact.note ? `<p><em>${contact.note}</em></p>` : ""}
            </div>
          </div>
          <div class="card-actions">
            <button onclick="editContact('${id}', ${JSON.stringify(contact).replace(/"/g, '&quot;')})" 
                    class="btn btn-secondary btn-sm">Modifica</button>
            <button onclick="deleteContact('${id}', '${contact.nome || 'Contatto'}')" 
                    class="btn btn-danger btn-sm">Elimina</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderUsers(containerId, countId, snap, type) {
      const container = $(containerId);
      const count = $(countId);
      
      container.innerHTML = "";
      count.textContent = String(snap.size);

      if (snap.empty) {
        container.innerHTML = `<div class="empty-state">Nessun utente ${type}</div>`;
        return;
      }

      snap.forEach(d => {
        const u = d.data();
        const uid = d.id;
        
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header">
            <div class="card-info">
              <h3>
                ${u.name || "(senza nome)"}
                ${type !== "in attesa" ? `<span class="badge badge-gray badge-unread" data-uid="${uid}">0</span>` : ""}
              </h3>
              <p>${u.email || ""}</p>
              ${type !== "in attesa" ? `
                <div class="name-update">
                  <input type="text" placeholder="Nuovo nome" value="${u.name || ""}" 
                         id="name-input-${uid}">
                  <button onclick="updateDriverName('${uid}')" class="btn btn-secondary btn-sm">
                    Aggiorna
                  </button>
                </div>
              ` : ""}
            </div>
          </div>
          <div class="card-actions">
            ${type === "in attesa" 
              ? `<button data-uid="${uid}" class="approve btn btn-success">Approva</button>`
              : `
                <button data-uid="${uid}" class="revoke btn btn-secondary btn-sm">Revoca</button>
                <button data-uid="${uid}" class="remove btn btn-danger btn-sm">Elimina</button>
                <a class="btn btn-primary btn-sm" href="chat.html?uid=${uid}" target="_blank">Chat</a>
                <button data-uid="${uid}" data-name="${u.name || uid}" class="open-inline btn btn-secondary btn-sm">Chat qui</button>
              `
            }
          </div>
        `;
        container.appendChild(card);
      });

      // Attach event handlers
      attachInlineChatHandlers(container);

      container.querySelectorAll(".approve").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const uid = e.currentTarget.getAttribute("data-uid");
          await updateDoc(doc(db, "users", uid), { approved: true, role: "driver" });
          setStatus("success", "Utente approvato");
        });
      });

      container.querySelectorAll(".revoke").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const uid = e.currentTarget.getAttribute("data-uid");
          if (!confirm("Revocare l'accesso?")) return;
          
          await updateDoc(doc(db, "users", uid), { approved: false });
          setStatus("success", "Accesso revocato");
        });
      });

      container.querySelectorAll(".remove").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const uid = e.currentTarget.getAttribute("data-uid");
          if (!confirm("Eliminare il record utente?")) return;
          
          await deleteDoc(doc(db, "users", uid));
          setStatus("success", "Record utente eliminato");
        });
      });

      // Carica badge iniziali per i nuovi utenti
      if (type !== "in attesa") {
        setTimeout(loadInitialBadgeCounts, 1000);
      }
    }

    // Importazione clienti (codice esistente...)
    $("btn-load-file").addEventListener("click", async () => {
      const fileInput = $("clientFile");
      const file = fileInput.files[0];

      if (!file) {
        showImportStatus("Seleziona un file", "error");
        return;
      }

      showImportStatus("Analisi in corso...", "");

      try {
        if (file.name.endsWith('.json')) {
          await parseJSONFile(file);
        } else if (file.name.endsWith('.csv')) {
          await parseCSVFile(file);
        } else {
          showImportStatus("Formato non supportato", "error");
          return;
        }

        validateAndShowPreview();
      } catch (error) {
        showImportStatus(`Errore: ${error.message}`, "error");
      }
    });

    $("btn-import-sample").addEventListener("click", () => {
      parsedClienti = [
        {
          nome: "Casa", indirizzo: "Vicolo Mercanti, 50B/1, 46019 Viadana MN",
          coordinate: "44.932604, 10.531342", note: "Residenza principale"
        },
        {
          nome: "Lavoro", indirizzo: "Via Werter Asseverati, 1, 42122 Reggio nell'Emilia RE",
          coordinate: "44.67239, 10.71315", note: "Ufficio"
        },
        {
          nome: "Bignotti", indirizzo: "Localita' Casa Nuova, 51, 43039 Salsominore PR",
          coordinate: "44.79644, 9.93591", note: "Cliente agricolo"
        }
      ];
      validateAndShowPreview();
    });

    $("btn-confirm-import").addEventListener("click", async () => {
      if (validClienti.length === 0) return;

      showImportStatus(`Importazione ${validClienti.length} clienti...`, "");

      try {
        const clientiRef = collection(db, "clienti");
        let imported = 0;

        for (const cliente of validClienti) {
          await addDoc(clientiRef, {
            ...cliente,
            createdAt: serverTimestamp(),
            createdBy: { uid: "admin", name: "Amministratore", email: "admin@sistema.com" }
          });
          imported++;
        }

        showImportStatus(`Importati ${imported} clienti`, "success");
        resetImportForm();
      } catch (error) {
        showImportStatus(`Errore importazione: ${error.message}`, "error");
      }
    });

    $("btn-cancel-import").addEventListener("click", resetImportForm);

    // Parser functions (codice esistente...)
    async function parseJSONFile(file) {
      const text = await file.text();
      const data = JSON.parse(text);

      if (data.features && Array.isArray(data.features)) {
        parsedClienti = data.features.map(feature => ({
          nome: feature.properties.name || feature.properties.nome || 'Cliente senza nome',
          indirizzo: feature.properties.address || feature.properties.indirizzo || '',
          coordinate: feature.geometry.coordinates && feature.geometry.coordinates.length >= 2 ?
            `${feature.geometry.coordinates[1]}, ${feature.geometry.coordinates[0]}` : '',
          note: feature.properties.note || ''
        }));
      } else if (Array.isArray(data)) {
        parsedClienti = data.map(item => ({
          nome: item.nome || item.name || 'Cliente senza nome',
          indirizzo: item.indirizzo || item.address || '',
          coordinate: item.coordinate || item.coordinates || '',
          note: item.note || item.notes || ''
        }));
      } else {
        throw new Error('Formato JSON non riconosciuto');
      }
    }

    async function parseCSVFile(file) {
      const text = await file.text();
      const lines = text.split('\n').filter(line => line.trim());

      if (lines.length < 2) {
        throw new Error('File CSV vuoto');
      }

      const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));

      parsedClienti = lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim().replace(/['"]/g, ''));
        const obj = {};

        headers.forEach((header, index) => {
          obj[header.toLowerCase()] = values[index] || '';
        });

        return {
          nome: obj.nome || obj.name || 'Cliente senza nome',
          indirizzo: obj.indirizzo || obj.address || '',
          coordinate: obj.coordinate || obj.coordinates || '',
          note: obj.note || obj.notes || ''
        };
      });
    }

    function validateAndShowPreview() {
      validClienti = [];
      const errors = [];

      parsedClienti.forEach((item, index) => {
        if (!item.nome || item.nome.trim() === '') {
          errors.push(`Riga ${index + 1}: Nome mancante`);
          return;
        }

        validClienti.push({
          nome: item.nome.trim(),
          indirizzo: (item.indirizzo || '').trim(),
          coordinate: (item.coordinate || '').trim(),
          note: (item.note || '').trim()
        });
      });

      if (validClienti.length > 0) {
        showImportStatus(`Trovati ${validClienti.length} clienti validi`, "success");
        showPreview(validClienti.slice(0, 10));
      } else {
        showImportStatus("Nessun cliente valido trovato", "error");
      }
    }

    function showPreview(clienti) {
      const preview = $("import-preview");
      const content = $("preview-content");

      let html = `<div><strong>Anteprima ${validClienti.length} clienti:</strong></div>`;

      clienti.forEach(cliente => {
        html += `
          <div class="preview-item">
            <strong>${cliente.nome}</strong><br>
            <small style="color: var(--gray-500);">${cliente.indirizzo || 'Nessun indirizzo'}</small><br>
            ${cliente.coordinate ? `<small>üìç ${cliente.coordinate}</small><br>` : ''}
            ${cliente.note ? `<em><small>${cliente.note}</small></em>` : ''}
          </div>
        `;
      });

      if (validClienti.length > 10) {
        html += `<div style="text-align: center; color: var(--gray-500); margin-top: 1rem;">...e altri ${validClienti.length - 10} clienti</div>`;
      }

      content.innerHTML = html;
      preview.style.display = "block";
    }

    function showImportStatus(message, type) {
      const status = $("import-status");
      status.textContent = message;
      status.style.display = "block";

      status.className = `status-bar status-${type}`;
    }

    function resetImportForm() {
      $("clientFile").value = '';
      $("import-preview").style.display = "none";
      $("import-status").style.display = "none";
      parsedClienti = [];
      validClienti = [];
    }

    // Event listeners
    $("btn-add-contact").addEventListener("click", addOrEditContact);
    $("btn-cancel-contact").addEventListener("click", cancelEditContact);

    // Global functions
    window.editContact = editContact;
    window.deleteContact = deleteContact;

    // Main listeners management
    function startListeners() {
      if (!pendingUnsub) {
        const qPending = query(collection(db, "users"),
          where("role", "==", "driver"),
          where("approved", "==", false));
        pendingUnsub = onSnapshot(qPending, (snap) => renderUsers("pending", "count-pending", snap, "in attesa"));
      }

      if (!approvedUnsub) {
        const qApproved = query(collection(db, "users"),
          where("role", "==", "driver"),
          where("approved", "==", true));
        approvedUnsub = onSnapshot(qApproved, (snap) => renderUsers("approved", "count-approved", snap, "approvati"));
      }

      if (!contactsUnsub) {
        const qContacts = query(collection(db, "rubrica"), orderBy("nome", "asc"));
        contactsUnsub = onSnapshot(qContacts, renderContacts);
      }

      // AVVIA IL POLLING PER SAFARI MOBILE
      startBadgePollingForSafari();

      $("rubrica-section").style.display = "block";
      $("import-section").style.display = "block";
    }

    function stopListeners() {
      if (pendingUnsub) { pendingUnsub(); pendingUnsub = null; }
      if (approvedUnsub) { approvedUnsub(); approvedUnsub = null; }
      if (contactsUnsub) { contactsUnsub(); contactsUnsub = null; }

      // FERMA IL POLLING
      stopBadgePolling();

      $("count-pending").textContent = "0";
      $("count-approved").textContent = "0";
      $("count-contacts").textContent = "0";
      $("pending").innerHTML = '<div class="empty-state">Effettua il login per vedere gli utenti in attesa</div>';
      $("approved").innerHTML = '<div class="empty-state">Effettua il login per vedere gli utenti approvati</div>';
      $("contacts-list").innerHTML = "";

      $("rubrica-section").style.display = "none";
      $("import-section").style.display = "none";
      cancelEditContact();
      resetImportForm();
    }

    // Auth state changes
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        setStatus("warning", "Accesso necessario");
        stopListeners();
        $("email").disabled = false;
        $("pass").disabled = false;
        $("btn-login").disabled = false;
        return;
      }

      $("email").disabled = true;
      $("pass").disabled = true;
      $("btn-login").disabled = true;

      if (user.uid === ADMIN_UID) {
        setStatus("success", `Benvenuto ${user.email}`);
        startListeners();
        // Richiedi permessi notifiche per admin
        requestNotificationPermissionForAdmin();
      } else {
        setStatus("warning", `${user.email} - Non hai permessi admin`);
        stopListeners();
      }
    });

    // Test function for deleting admin clients
    window.eliminaClientiTest = async function() {
      const conferma = confirm("Eliminare tutti i clienti importati dall'admin?");
      if (!conferma) return;

      try {
        const clientiRef = collection(db, "clienti");
        const snapshot = await getDocs(clientiRef);

        let eliminati = 0;
        for (const docSnap of snapshot.docs) {
          const cliente = docSnap.data();
          if (cliente.createdBy?.uid === "admin" || cliente.createdBy?.name === "Amministratore") {
            await deleteDoc(doc(db, "clienti", docSnap.id));
            eliminati++;
          }
        }

        alert(`Eliminati ${eliminati} clienti!`);
        setStatus("success", `Eliminati ${eliminati} clienti importati`);
      } catch (error) {
        alert("Errore: " + error.message);
      }
    };
  </script>
</body>

</html>


