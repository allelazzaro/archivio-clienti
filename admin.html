<!DOCTYPE html>

<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin - Approvazione Utenti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{ --bg:#f6f8fa; --card:#fff; --muted:#666; --b:#ddd; --pri:#0b5; --danger:#b02a37; }
    body { font-family: Arial, sans-serif; margin:0; background: var(--bg); }
    header { padding:12px 16px; background:#fff; border-bottom:1px solid #eee; position:sticky; top:0; z-index:10; }
    h1 { margin:0 0 8px; font-size:20px; }
    .container { padding:16px; max-width:1200px; margin:0 auto; }
    .status { margin: 8px 0 12px; padding:8px 12px; border-radius:6px; font-size:14px; }
    .ok { background:#e7f7ec; border:1px solid #33a35c; color:#0b5; }
    .warn { background:#fff7e6; border:1px solid #f0ad4e; color:#c77c11; }
    .err { background:#fdecea; border:1px solid #f5c2c7; color:#b02a37; }

```
.login-row { display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-top:8px; }
input, button, a.btn { padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; text-decoration:none; color:#000; font-size:14px; }
button { cursor:pointer; }
button:disabled{ opacity:.6; cursor:not-allowed; }
.btn-danger{ background:#b02a37; border-color:#b02a37; color:#fff; }
.btn-secondary{ background:#eee; }
.btn-primary{ background:#0b5; color:#fff; border-color:#0b5; }

.cols { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:24px; }
@media (max-width: 768px){ 
  .cols { grid-template-columns: 1fr; gap:12px; }
  .login-row { gap:4px; }
  input, button, a.btn { padding:8px 12px; font-size:16px; } /* Migliore touch target su mobile */
  h1 { font-size:18px; }
  .container { padding:12px; }
}

.card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:8px; }
.row { display:flex; gap:8px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
.muted { color:#666; font-size:13px; }
.badge{ display:inline-block; min-width:16px; padding:2px 6px; border-radius:999px; font-size:11px; text-align:center; }
.badge-gray{ background:#eee; color:#333; }
.badge-red{ background:#ff4757; color:#fff; }

/* Stili per la modifica nome */
.name-edit-row {
  margin-top: 8px;
  display: flex;
  gap: 4px;
  align-items: center;
  flex-wrap: wrap;
}
.name-input {
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 12px;
  min-width: 120px;
  flex: 1;
}
.name-btn {
  padding: 4px 8px;
  background: #0b5;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  white-space: nowrap;
}
.name-btn:hover {
  background: #096;
}

/* Bottoni azioni - meglio su mobile */
.action-buttons {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.action-buttons button,
.action-buttons a {
  padding: 4px 8px;
  font-size: 12px;
  white-space: nowrap;
}

/* Rubrica */
.rubrica-form {
  background:#fff; 
  border:1px solid #ddd; 
  border-radius:8px; 
  padding:16px; 
  margin-bottom:16px;
}
.rubrica-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 8px;
  margin-bottom: 12px;
}
@media (max-width: 768px) {
  .rubrica-grid {
    grid-template-columns: 1fr;
  }
}

/* Pannello chat laterale - SOLUZIONE DEFINITIVA */
.chat-panel {
  position: fixed; 
  top:0; 
  right:0; 
  width: min(560px, 100%); 
  height: 100vh;
  background:#fff; 
  border-left:1px solid #ddd; 
  box-shadow: -6px 0 18px rgba(0,0,0,.08);
  transform: translateX(100%); 
  transition: transform .25s ease; 
  z-index: 50; 
  display:flex; 
  flex-direction:column;
}
.chat-panel.open { 
  transform: translateX(0); 
}
.chat-panel header { 
  padding:12px 14px; 
  border-bottom:1px solid #eee; 
  display:flex; 
  align-items:center; 
  justify-content:space-between;
  flex-shrink: 0;
  min-height: 48px;
}
.chat-iframe { 
  border:0; 
  width:100%; 
  height: calc(100vh - 48px); /* Altezza esplicita */
  display: block;
}
```

  </style>
</head>
<body>
  <header>
    <h1>üëë Admin ‚Äî Approvazione Utenti</h1>
    <div id="status" class="status warn">üîí Non loggato.</div>
    <div class="login-row">
      <input id="email" placeholder="Email admin">
      <input id="pass" placeholder="Password" type="password">
      <button id="btn-login">Accedi</button>
      <button id="btn-logout">Esci</button>
      <a href="console.html" class="btn btn-primary">üí¨ Console chat (tutte)</a>
    </div>
  </header>

  <div class="container">
    <div class="cols">
      <div>
        <h2>In attesa di approvazione <span id="count-pending" class="badge badge-gray">0</span></h2>
        <div id="pending" class="muted">Effettua il login come admin per vedere gli utenti in attesa.</div>
      </div>

```
  <div>
    <h2>Utenti approvati <span id="count-approved" class="badge badge-gray">0</span></h2>
    <div id="approved" class="muted">Effettua il login come admin per vedere gli utenti approvati.</div>
  </div>
</div>

<hr style="margin: 32px 0; border: none; border-top: 1px solid #ddd;">

<!-- GESTIONE RUBRICA -->
<div id="rubrica-section" style="display:none;">
  <h2>üìû Gestione Rubrica</h2>
  <div class="rubrica-form">
    <h3 style="margin-top:0;">Aggiungi nuovo contatto</h3>
    <div class="rubrica-grid">
      <input id="rubrica-nome" placeholder="Nome/Azienda">
      <input id="rubrica-telefono" placeholder="Telefono">
      <input id="rubrica-email" placeholder="Email">
      <select id="rubrica-tipo">
        <option value="cliente">Cliente</option>
        <option value="fornitore">Fornitore</option>
        <option value="partner">Partner</option>
        <option value="altro">Altro</option>
      </select>
    </div>
    <textarea id="rubrica-note" placeholder="Note aggiuntive" style="width:100%; margin-bottom:12px; min-height:60px; box-sizing:border-box;"></textarea>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btn-add-contact" class="btn-primary">Aggiungi contatto</button>
      <button id="btn-cancel-contact" class="btn-secondary" style="display:none;">Annulla modifica</button>
    </div>
  </div>

  <h3>Contatti esistenti <span id="count-contacts" class="badge badge-gray">0</span></h3>
  <div id="contacts-list"></div>
</div>
```

  </div>

  <!-- pannello chat inline -->

  <aside id="chatPanel" class="chat-panel" aria-hidden="true">
    <header>
      <strong id="chatTitle">Chat</strong>
      <button id="closeChat" class="btn-secondary">‚úñ Chiudi</button>
    </header>
    <iframe id="chatFrame" class="chat-iframe" src="about:blank" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
  </aside>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBbjK5sgQ70-p8jODaK_PnLIzPxgfrqQ34",
      authDomain: "archivio-clienti-trasporti.firebaseapp.com",
      projectId: "archivio-clienti-trasporti",
      storageBucket: "archivio-clienti-trasporti.firebasestorage.app",
      messagingSenderId: "773533170263",
      appId: "1:773533170263:web:d05e2b00e991b0294c0112"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, query, where, onSnapshot, updateDoc, doc, deleteDoc,
      orderBy, limit, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const adminApp = initializeApp(firebaseConfig, "adminApp");
    const db = getFirestore(adminApp);
    const auth = getAuth(adminApp);
    await setPersistence(auth, browserLocalPersistence); // persistenza condivisa con altre pagine

    // ‚ö†Ô∏è METTI QUI IL TUO UID ADMIN REALE
    const ADMIN_UID = "0dCvHDcVp1PHuWVNIN9i6ZvEVBt2";

    const $ = id => document.getElementById(id);
    const setStatus = (type, msg) => { const s=$("status"); s.className="status "+type; s.textContent=msg; };
    const setLoginDisabled = d => { $("email").disabled=d; $("pass").disabled=d; $("btn-login").disabled=d; };

    // pannello chat inline
    const chatPanel = $("chatPanel"), chatFrame = $("chatFrame"), chatTitle = $("chatTitle");
    $("closeChat").addEventListener("click", () => { 
      chatPanel.classList.remove("open"); 
      chatPanel.setAttribute("aria-hidden","true"); 
      chatFrame.src="about:blank"; 
    });

    // ---- Login/Logout
    $("btn-login").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const pass  = $("pass").value;
      if (!email || !pass) { setStatus("err","‚ùå Inserisci email e password."); return; }
      try { await signInWithEmailAndPassword(auth, email, pass); }
      catch(e){ setStatus("err","‚ùå Login fallito: " + (e.code || e.message)); }
    });
    $("btn-logout").addEventListener("click", () => signOut(auth));

    let pendingUnsub = null, approvedUnsub = null, contactsUnsub = null;
    let editingContactId = null;

    // --------- Badge non letti per un driver (ultimi 50 msg) ----------
    function watchUnreadBadgeForDriver(uid){
      const msgsRef = collection(db, "threads", uid, "messages");
      const qRecent = query(msgsRef, orderBy("createdAt","desc"), limit(50));
      return onSnapshot(qRecent, (snap) => {
        let count = 0;
        snap.forEach(d => {
          const m = d.data();
          const rb = Array.isArray(m.readBy) ? m.readBy : [];
          if (!rb.includes(ADMIN_UID) && m.sender !== ADMIN_UID) count++;
        });
        const badge = document.querySelector(`.badge-unread[data-uid="${uid}"]`);
        if (badge) {
          if (count > 0) { badge.textContent = String(count); badge.className = "badge badge-red badge-unread"; }
          else { badge.textContent = "0"; badge.className = "badge badge-gray badge-unread"; }
        }
      });
    }

    // (opzionale) warm-up; se vuoi creare al volo il thread fallo in chat.html
    async function ensureThreadForDriver(uid, name, email){
      await getDocs(query(collection(db,"threads"))); // no-op warm
    }

    function attachInlineChatHandlers(container){
      container.querySelectorAll(".open-inline").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const uid  = e.currentTarget.dataset.uid;
          const name = e.currentTarget.dataset.name || uid;
          if (!uid) { alert("Impossibile aprire la chat: UID mancante."); return; }
          console.log("[ADMIN] Apri chat inline ‚Üí uid:", uid, "name:", name);
          chatTitle.textContent = `Chat con: ${name} (${uid})`;
          // Aggiungi parametro per indicare che √® in iframe
          chatFrame.src = `chat.html?uid=${encodeURIComponent(uid)}&iframe=1`;
          chatPanel.classList.add("open");
          chatPanel.setAttribute("aria-hidden","false");
        });
      });
    }

    // Funzione per aggiornare il nome del driver
    window.updateDriverName = async function(uid) {
      const input = document.getElementById(`name-input-${uid}`);
      if (!input) {
        console.error(`Input con id name-input-${uid} non trovato`);
        return;
      }
      
      const newName = input.value.trim();
      
      if (!newName) {
        alert("Inserisci un nome valido.");
        return;
      }
      
      try {
        await updateDoc(doc(db, "users", uid), { name: newName });
        setStatus("ok", `‚úÖ Nome aggiornato per ${newName}`);
      } catch (error) {
        console.error("Errore nell'aggiornamento del nome:", error);
        setStatus("err", "‚ùå Errore nell'aggiornamento del nome.");
      }
    };

    // ========== GESTIONE RUBRICA ==========
    
    // Funzioni per gestire i contatti della rubrica
    async function addOrEditContact() {
      const nome = $("rubrica-nome").value.trim();
      const telefono = $("rubrica-telefono").value.trim();
      const email = $("rubrica-email").value.trim();
      const tipo = $("rubrica-tipo").value;
      const note = $("rubrica-note").value.trim();

      if (!nome) {
        alert("Inserisci almeno il nome/azienda.");
        return;
      }

      const contactData = {
        nome,
        telefono,
        email,
        tipo,
        note,
        updatedAt: serverTimestamp()
      };

      try {
        if (editingContactId) {
          // Modifica contatto esistente
          await updateDoc(doc(db, "rubrica", editingContactId), contactData);
          setStatus("ok", "‚úÖ Contatto aggiornato.");
          cancelEditContact();
        } else {
          // Aggiungi nuovo contatto
          await addDoc(collection(db, "rubrica"), {
            ...contactData,
            createdAt: serverTimestamp(),
            createdBy: "admin"
          });
          setStatus("ok", "‚úÖ Contatto aggiunto alla rubrica.");
        }
        clearContactForm();
      } catch (error) {
        console.error("Errore nella gestione del contatto:", error);
        setStatus("err", "‚ùå Errore nella gestione del contatto.");
      }
    }

    function clearContactForm() {
      $("rubrica-nome").value = "";
      $("rubrica-telefono").value = "";
      $("rubrica-email").value = "";
      $("rubrica-tipo").value = "cliente";
      $("rubrica-note").value = "";
    }

    function editContact(id, contact) {
      editingContactId = id;
      $("rubrica-nome").value = contact.nome || "";
      $("rubrica-telefono").value = contact.telefono || "";
      $("rubrica-email").value = contact.email || "";
      $("rubrica-tipo").value = contact.tipo || "cliente";
      $("rubrica-note").value = contact.note || "";
      $("btn-add-contact").textContent = "Aggiorna contatto";
      $("btn-cancel-contact").style.display = "inline-block";
    }

    function cancelEditContact() {
      editingContactId = null;
      $("btn-add-contact").textContent = "Aggiungi contatto";
      $("btn-cancel-contact").style.display = "none";
      clearContactForm();
    }

    async function deleteContact(id, nome) {
      if (!confirm(`Eliminare il contatto "${nome}"?`)) return;
      try {
        await deleteDoc(doc(db, "rubrica", id));
        setStatus("ok", "üóëÔ∏è Contatto eliminato.");
      } catch (error) {
        console.error("Errore nell'eliminazione del contatto:", error);
        setStatus("err", "‚ùå Errore nell'eliminazione del contatto.");
      }
    }

    function renderContacts(snapshot) {
      const container = $("contacts-list");
      const count = $("count-contacts");
      container.innerHTML = "";
      count.textContent = String(snapshot.size);

      if (snapshot.empty) {
        container.innerHTML = "<div class='muted'>Nessun contatto in rubrica.</div>";
        return;
      }

      snapshot.forEach(docSnap => {
        const contact = docSnap.data();
        const id = docSnap.id;
        const card = document.createElement("div");
        card.className = "card";
        
        const tipoColors = {
          cliente: "#0b5",
          fornitore: "#f39c12",
          partner: "#9b59b6",
          altro: "#95a5a6"
        };

        card.innerHTML = `
          <div class="row">
            <div>
              <strong>${contact.nome || "(senza nome)"}</strong>
              <span class="badge" style="background:${tipoColors[contact.tipo] || '#95a5a6'}; color:#fff; margin-left:8px;">${contact.tipo}</span>
              <br>
              ${contact.telefono ? `üìû ${contact.telefono}` : ""}
              ${contact.telefono && contact.email ? " ‚Ä¢ " : ""}
              ${contact.email ? `üìß ${contact.email}` : ""}
              ${contact.note ? `<br><em style="color:#666; font-size:13px;">${contact.note}</em>` : ""}
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button onclick="editContact('${id}', ${JSON.stringify(contact).replace(/"/g, '&quot;')})" 
                      class="btn-secondary">‚úèÔ∏è Modifica</button>
              <button onclick="deleteContact('${id}', '${contact.nome || 'Contatto'}')" 
                      class="btn-danger">üóëÔ∏è Elimina</button>
            </div>
          </div>`;
        container.appendChild(card);
      });
    }

    // Event listeners per la rubrica
    $("btn-add-contact").addEventListener("click", addOrEditContact);
    $("btn-cancel-contact").addEventListener("click", cancelEditContact);

    // Espone le funzioni globalmente per i bottoni inline
    window.editContact = editContact;
    window.deleteContact = deleteContact;

    function renderUsers(containerId, countId, snap, type){
      const container = $(containerId);
      const count = $(countId);
      container.innerHTML = ""; count.textContent = String(snap.size);
      if (snap.empty) { container.innerHTML = `<div class='muted'>Nessun utente ${type}.</div>`; return; }

      snap.forEach(d => {
        const u = d.data();
        const uid = d.id;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="row">
            <div>
              <strong>${u.name || "(senza nome)"} </strong>
              ${ type !== "in attesa" ? `<span class="badge badge-gray badge-unread" data-uid="${uid}" title="Messaggi non letti">0</span>` : "" }
              <br><span class="muted">${u.email || ""}</span>
              ${ type !== "in attesa" ? `
                <div class="name-edit-row">
                  <input type="text" placeholder="Modifica nome" value="${u.name || ""}" 
                         class="name-input" id="name-input-${uid}">
                  <button onclick="updateDriverName('${uid}')" class="name-btn">
                    Aggiorna nome
                  </button>
                </div>
              ` : "" }
            </div>
            <div class="action-buttons">
              ${
                type === "in attesa"
                ? `<button data-uid="${uid}" class="approve btn-primary">Approva</button>`
                : `
                  <button data-uid="${uid}" class="revoke btn-secondary">Revoca accesso</button>
                  <button data-uid="${uid}" class="remove btn-danger">Elimina record</button>
                  <a class="btn-secondary" href="chat.html?uid=${uid}" target="_blank" title="Apri chat in nuova pagina">üîó Chat</a>
                  <button data-uid="${uid}" data-name="${u.name || uid}" class="open-inline btn-secondary" title="Apri chat nel pannello">üóÇ Apri qui</button>
                `
              }
            </div>
          </div>`;
        container.appendChild(card);

        if (type !== "in attesa") {
          watchUnreadBadgeForDriver(uid);
          ensureThreadForDriver(uid, u.name || "", u.email || "");
        }
      });

      // attach handlers
      attachInlineChatHandlers(container);

      // azioni
      container.querySelectorAll(".approve").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const uid = e.currentTarget.getAttribute("data-uid");
          await updateDoc(doc(db,"users", uid), { approved: true, role: "driver" });
          setStatus("ok","‚úÖ Utente approvato.");
        });
      });
      container.querySelectorAll(".revoke").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const uid = e.currentTarget.getAttribute("data-uid");
          if (!confirm("Revocare l'accesso?")) return;
          await updateDoc(doc(db,"users", uid), { approved: false });
          setStatus("ok","‚úÖ Accesso revocato.");
        });
      });
      container.querySelectorAll(".remove").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const uid = e.currentTarget.getAttribute("data-uid");
          if (!confirm("Eliminare il record utente in Firestore?")) return;
          await deleteDoc(doc(db,"users", uid));
          setStatus("ok","üóëÔ∏è Record utente eliminato.");
        });
      });
    }

    function startListeners(){
      if (!pendingUnsub) {
        const qPending = query(collection(db,"users"),
                               where("role","==","driver"),
                               where("approved","==",false));
        pendingUnsub = onSnapshot(qPending, (snap) => renderUsers("pending","count-pending",snap,"in attesa"));
      }
      if (!approvedUnsub) {
        const qApproved = query(collection(db,"users"),
                                where("role","==","driver"),
                                where("approved","==",true));
        approvedUnsub = onSnapshot(qApproved, (snap) => renderUsers("approved","count-approved",snap,"approvati"));
      }
      if (!contactsUnsub) {
        const qContacts = query(collection(db,"rubrica"), orderBy("nome","asc"));
        contactsUnsub = onSnapshot(qContacts, renderContacts);
      }
      // Mostra sezione rubrica
      $("rubrica-section").style.display = "block";
    }
    function stopListeners(){
      if (pendingUnsub) { pendingUnsub(); pendingUnsub=null; }
      if (approvedUnsub) { approvedUnsub(); approvedUnsub=null; }
      if (contactsUnsub) { contactsUnsub(); contactsUnsub=null; }
      $("count-pending").textContent = "0";
      $("count-approved").textContent = "0";
      $("count-contacts").textContent = "0";
      $("pending").innerHTML  = "<div class='muted'>Effettua il login come admin per vedere gli utenti in attesa.</div>";
      $("approved").innerHTML = "<div class='muted'>Effettua il login come admin per vedere gli utenti approvati.</div>";
      $("contacts-list").innerHTML = "";
      // Nascondi sezione rubrica
      $("rubrica-section").style.display = "none";
      cancelEditContact();
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) { setStatus("warn","üîí Non loggato."); stopListeners(); setLoginDisabled(false); return; }
      setLoginDisabled(true);
      if (user.uid === ADMIN_UID) { setStatus("ok",`‚úÖ Loggato come ${user.email} (ADMIN)`); startListeners(); }
      else { setStatus("warn",`‚ö†Ô∏è Loggato come ${user.email}, ma non sei admin.`); stopListeners(); }
    });
  </script>

</body>
</html>
