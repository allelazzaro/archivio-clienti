<!DOCTYPE html>

<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Chat</title>
  <!-- viewport senza user-scalable=no per accessibilità -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover" />
  <style>
    :root {
      --header-height: 52px;
      --composer-height: 60px;
      --brand: #128c7e;
      --bg: #e8edf2;
      --mine: #dcf8c6;
      --their: #fff;
      --line: #dde3ea;
    }

```
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* APPROCCIO SEMPLIFICATO - NO TRICKS COMPLESSI */
html {
  height: 100%;
  position: fixed;
  width: 100%;
}

body {
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  background: var(--bg);
  overflow: hidden;
  position: relative;
}

/* Container principale */
.app {
  height: 100vh;
  display: flex;
  flex-direction: column;
  position: relative;
}

/* Header */
.header {
  height: var(--header-height);
  background: var(--brand);
  color: white;
  display: flex;
  align-items: center;
  padding: 0 16px;
  flex-shrink: 0;
}

.header-title {
  flex: 1;
  font-weight: 600;
  text-align: center;
}

.header-btn {
  color: white;
  text-decoration: none;
  padding: 8px;
}

/* Container chat */
.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}

/* Area messaggi */
.messages {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 12px;
  background: linear-gradient(to bottom, #dfe7ee, #eef3f8);
}

/* Bubble messaggi */
.message {
  margin-bottom: 8px;
  display: flex;
}

.message.mine {
  justify-content: flex-end;
}

.bubble {
  max-width: 75%;
  padding: 8px 12px;
  border-radius: 18px;
  position: relative;
  word-wrap: break-word;
}

.bubble.mine {
  background: var(--mine);
  border-bottom-right-radius: 4px;
}

.bubble.theirs {
  background: var(--their);
  border-bottom-left-radius: 4px;
}

.time {
  font-size: 11px;
  color: #667781;
  margin-top: 2px;
  text-align: right;
}

/* Composer */
.composer {
  background: #fff;
  border-top: 1px solid var(--line);
  padding: 8px;
  display: flex;
  gap: 8px;
  align-items: flex-end;
  min-height: var(--composer-height);
  flex-shrink: 0;
}

.input-wrapper {
  flex: 1;
  background: #f0f2f5;
  border-radius: 24px;
  display: flex;
  align-items: center;
  padding: 0 12px;
}

.message-input {
  flex: 1;
  border: none;
  background: none;
  outline: none;
  padding: 10px 0;
  font-size: 16px; /* Previene zoom iOS */
  line-height: 20px;
  max-height: 100px;
  resize: none;
}

.send-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--brand);
  border: none;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
}

.send-btn:disabled {
  opacity: 0.5;
}

/* Day separator */
.day-separator {
  text-align: center;
  margin: 16px 0;
  color: #667781;
  font-size: 12px;
  position: relative;
}

.day-separator span {
  background: #e9edef;
  padding: 4px 12px;
  border-radius: 8px;
  display: inline-block;
}

/* Sidebar per desktop */
.sidebar {
  display: none;
}

@media (min-width: 768px) {
  .app {
    flex-direction: row;
  }

  .sidebar {
    display: block;
    width: 320px;
    background: #fff;
    border-right: 1px solid var(--line);
    overflow-y: auto;
  }

  .chat-section {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .header {
    border-radius: 0;
  }
}

/* Gestione iOS tastiera - SEMPLICE */
@supports (-webkit-touch-callout: none) {
  /* Quando input ha focus, sistema aggiusta viewport automaticamente */
  .message-input:focus {
    /* iOS gestirà il viewport */
  }
}

/* Loader */
.loading {
  display: flex;
  justify-content: center;
  padding: 20px;
  color: #667781;
}
```

  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar" id="sidebar">
      <!-- Lista chat per desktop -->
    </div>

```
<div class="chat-section">
  <header class="header">
    <a href="#" class="header-btn" id="backBtn">←</a>
    <div class="header-title">Chat</div>
    <a href="#" class="header-btn" id="menuBtn">⋮</a>
  </header>

  <div class="chat-container">
    <div class="messages" id="messages">
      <!-- I messaggi verranno inseriti qui -->
    </div>

    <div class="composer">
      <div class="input-wrapper">
        <textarea 
          class="message-input" 
          id="messageInput"
          placeholder="Scrivi un messaggio"
          rows="1"
        ></textarea>
      </div>
      <button class="send-btn" id="sendBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
        </svg>
      </button>
    </div>
  </div>
</div>
```

  </div>

  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc,
      query, onSnapshot, orderBy, serverTimestamp, arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyBbjK5sgQ70-p8jODaK_PnLIzPxgfrqQ34",
      authDomain: "archivio-clienti-trasporti.firebaseapp.com",
      projectId: "archivio-clienti-trasporti",
      storageBucket: "archivio-clienti-trasporti.firebasestorage.app",
      messagingSenderId: "773533170263",
      appId: "1:773533170263:web:d05e2b00e991b0294c0112"
    };
    
    const ADMIN_UID = "0dCvHDcVp1PHuWVNIN9i6ZvEVBt2";
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Elements
    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const backBtn = document.getElementById('backBtn');

    // State
    let currentUser = null;
    let currentThreadId = null;
    let unsubscribe = null;
    let sending = false;

    // APPROCCIO SEMPLICE PER iOS
    // Non cerchiamo di controllare la tastiera, lasciamo che Safari gestisca tutto

    // Auto-resize textarea
    function autoResize() {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
    }

    messageInput.addEventListener('input', autoResize);

    // Scroll to bottom
    function scrollToBottom(smooth = false) {
      messages.scrollTo({
        top: messages.scrollHeight,
        behavior: smooth ? 'smooth' : 'auto'
      });
    }

    // Check if at bottom
    function isAtBottom() {
      return messages.scrollHeight - messages.scrollTop - messages.clientHeight < 50;
    }

    // Format time
    function formatTime(date) {
      if (!date) return '';
      const d = date.toDate ? date.toDate() : date;
      return d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    }

    // Format day
    function formatDay(date) {
      if (!date) return '';
      const d = date.toDate ? date.toDate() : date;
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (d.toDateString() === today.toDateString()) return 'Oggi';
      if (d.toDateString() === yesterday.toDateString()) return 'Ieri';
      return d.toLocaleDateString('it-IT');
    }

    // Render message
    function renderMessage(msg) {
      const isMine = msg.sender === currentUser.uid;
      const msgEl = document.createElement('div');
      msgEl.className = `message ${isMine ? 'mine' : 'theirs'}`;
      
      const bubble = document.createElement('div');
      bubble.className = `bubble ${isMine ? 'mine' : 'theirs'}`;
      
      const text = document.createElement('div');
      text.textContent = msg.text;
      
      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = formatTime(msg.createdAt);
      
      bubble.appendChild(text);
      bubble.appendChild(time);
      msgEl.appendChild(bubble);
      
      return msgEl;
    }

    // Load messages
    function loadMessages(threadId) {
      if (unsubscribe) unsubscribe();
      
      messages.innerHTML = '<div class="loading">Caricamento...</div>';
      currentThreadId = threadId;
      
      const q = query(
        collection(db, 'threads', threadId, 'messages'),
        orderBy('createdAt', 'asc')
      );
      
      unsubscribe = onSnapshot(q, (snapshot) => {
        const wasAtBottom = isAtBottom();
        messages.innerHTML = '';
        let lastDay = '';
        
        snapshot.forEach(doc => {
          const msg = doc.data();
          const msgDate = msg.createdAt?.toDate?.() || new Date();
          const day = msgDate.toDateString();
          
          // Day separator
          if (day !== lastDay) {
            const sep = document.createElement('div');
            sep.className = 'day-separator';
            sep.innerHTML = `<span>${formatDay(msgDate)}</span>`;
            messages.appendChild(sep);
            lastDay = day;
          }
          
          // Message
          messages.appendChild(renderMessage(msg));
          
          // Mark as read
          if (msg.sender !== currentUser.uid && !msg.readBy?.includes(currentUser.uid)) {
            updateDoc(doc.ref, {
              readBy: arrayUnion(currentUser.uid)
            }).catch(console.error);
          }
        });
        
        // Mantieni posizione scroll
        if (wasAtBottom || snapshot.size <= 1) {
          scrollToBottom();
        }
      });
    }

    // Send message
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !currentThreadId || sending) return;
      
      sending = true;
      sendBtn.disabled = true;
      
      try {
        await addDoc(collection(db, 'threads', currentThreadId, 'messages'), {
          text,
          sender: currentUser.uid,
          createdAt: serverTimestamp(),
          readBy: [currentUser.uid]
        });
        
        await updateDoc(doc(db, 'threads', currentThreadId), {
          lastMessage: text,
          updatedAt: serverTimestamp()
        });
        
        messageInput.value = '';
        autoResize();
        scrollToBottom();
        
      } catch (error) {
        console.error('Errore invio:', error);
        alert('Errore nell\'invio del messaggio');
      } finally {
        sending = false;
        sendBtn.disabled = false;
        messageInput.focus();
      }
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Focus management semplice
    let lastFocusTime = 0;
    messageInput.addEventListener('focus', () => {
      lastFocusTime = Date.now();
      // Su iOS, dopo 300ms scrolla se necessario
      setTimeout(() => {
        if (Date.now() - lastFocusTime > 250 && isAtBottom()) {
          scrollToBottom();
        }
      }, 300);
    });

    // Initialize thread
    async function initThread(uid) {
      const threadRef = doc(db, 'threads', uid);
      const threadSnap = await getDoc(threadRef);
      
      if (!threadSnap.exists()) {
        await setDoc(threadRef, {
          participants: [ADMIN_UID, uid],
          lastMessage: '',
          updatedAt: serverTimestamp()
        });
      }
      
      return uid;
    }

    // Auth check
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      currentUser = user;
      const isAdmin = user.uid === ADMIN_UID;
      
      // Setup navigation
      backBtn.href = isAdmin ? 'home.html' : 'index.html';
      
      // Get thread ID
      const params = new URLSearchParams(location.search);
      const targetUid = params.get('uid');
      const threadId = isAdmin ? (targetUid || user.uid) : user.uid;
      
      // Initialize and load
      await initThread(threadId);
      loadMessages(threadId);
    });

    // Prevent zoom on double tap (iOS)
    let lastTap = 0;
    document.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - lastTap < 300) {
        e.preventDefault();
      }
      lastTap = now;
    }, { passive: false });
  </script>

</body>
</html>
