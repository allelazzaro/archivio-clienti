<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Chat Admin â†” Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#007bff;
      --bg:#f5f7fb;
      --card:#fff;
      --line:#e5e7eb;
      --muted:#667;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
    header {
      background:var(--brand); color:#fff; padding:10px 12px;
      display:flex; align-items:center; gap:8px; position:sticky; top:0; z-index:20;
    }
    .title { font-weight:700; flex:1; }
    .btn-h {
      color:#fff; background:transparent; border:1px solid rgba(255,255,255,.35);
      padding:6px 10px; border-radius:8px; cursor:pointer; text-decoration:none; white-space:nowrap;
    }
    .wrap { display:grid; grid-template-columns: 300px 1fr; height: calc(100vh - 52px); }
    .sidebar { border-right:1px solid var(--line); background:var(--card); overflow:auto; }
    .chat { display:flex; flex-direction:column; height:100%; }
    .empty { padding:16px; color:var(--muted); }

    #messages { flex:1; overflow:auto; padding:12px; background:#eef3fb; }
    .msg { max-width:77%; padding:10px 12px; margin:6px 0; border-radius:12px; background:var(--card); box-shadow:0 1px 2px rgba(0,0,0,.05); }
    .mine { background:#dff1ff; margin-left:auto; }
    .meta { font-size:12px; color:var(--muted); margin-top:4px; }

    #composer { display:flex; gap:8px; padding:10px; background:var(--card); border-top:1px solid var(--line); }
    #composer input { flex:1; padding:12px; border:1px solid #cbd5e1; border-radius:10px; }
    #composer button { padding:12px 14px; border:none; border-radius:10px; background:var(--brand); color:#fff; cursor:pointer; }
    #composer button:disabled { opacity:.5; cursor:not-allowed; }

    /* Lista chat (sidebar) */
    .item { display:flex; gap:10px; padding:12px 14px; border-bottom:1px solid #f1f5f9; cursor:pointer; align-items:center; }
    .item:hover { background:#f8fafc; }
    .item.active { background:#eaf2ff; }
    .item .avatar { width:36px; height:36px; border-radius:999px; background:#e6f0ff; display:flex; align-items:center; justify-content:center; font-weight:700; color:#245; }
    .item .col { flex:1; min-width:0; }
    .item .name { font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item .preview { font-size:13px; color:#667; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item .right { text-align:right; }
    .item .time { font-size:12px; color:#778; }
    .item .badge { display:inline-block; min-width:18px; padding:2px 6px; border-radius:999px; background:#ff4757; color:#fff; font-size:12px; text-align:center; margin-top:4px; }

    /* --- MOBILE --- */
    #btnList { display:none; }
    @media (max-width: 768px){
      .wrap { grid-template-columns: 1fr; }
      .sidebar {
        position: fixed; top:52px; left:0; height: calc(100vh - 52px); width: 100%;
        max-width: 420px; transform: translateX(-100%); transition: transform .25s ease;
        box-shadow: 6px 0 18px rgba(0,0,0,.1); z-index:30;
      }
      .sidebar.open { transform: translateX(0); }
      #overlay {
        position: fixed; inset:52px 0 0 0; background: rgba(0,0,0,.3); display:none; z-index:25;
      }
      #overlay.show { display:block; }
      #btnList { display:inline-block; }
    }

    /* Toast notifica (driver) */
    .toast {
      position: fixed; left:50%; transform: translateX(-50%);
      bottom: 16px; background:#111; color:#fff; padding:10px 14px;
      border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,.25);
      font-size:14px; z-index: 1000; opacity:0; pointer-events:none; transition: opacity .2s, bottom .2s;
      max-width: 92vw; text-align:center;
    }
    .toast.show { opacity:1; bottom: 24px; }
  </style>
</head>
<body>
  <header>
    <button id="btnList" class="btn-h">â˜° Chat</button>
    <div class="title">ðŸ’¬ Chat</div>
    <a id="navBtn" href="#" class="btn-h">...</a>
  </header>

  <div id="overlay"></div>

  <div class="wrap">
    <aside class="sidebar" id="sidebar"><div class="empty">Caricamentoâ€¦</div></aside>

    <section class="chat">
      <div id="topbar" class="empty" style="padding:10px 12px;">Seleziona una chatâ€¦</div>
      <div id="messages"></div>
      <div id="composer">
        <input id="input" placeholder="Scrivi un messaggioâ€¦" />
        <button id="send">Invia</button>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc,
      query, onSnapshot, orderBy, serverTimestamp, limit
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbjK5sgQ70-p8jODaK_PnLIzPxgfrqQ34",
      authDomain: "archivio-clienti-trasporti.firebaseapp.com",
      projectId: "archivio-clienti-trasporti",
      storageBucket: "archivio-clienti-trasporti.firebasestorage.app",
      messagingSenderId: "773533170263",
      appId: "1:773533170263:web:d05e2b00e991b0294c0112"
    };
    // âš ï¸ Metti il TUO UID admin reale
    const ADMIN_UID = "0dCvHDcVp1PHuWVNIN9i6ZvEVBt2";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    const $ = (id) => document.getElementById(id);
    const sidebar = $("sidebar");
    const messagesDiv = $("messages");
    const input = $("input");
    const sendBtn = $("send");
    const topbar = $("topbar");
    const btnList = $("btnList");
    const overlay = $("overlay");
    const navBtn = $("navBtn");
    const toastEl = $("toast");

    let currentUser = null;
    let currentThreadId = null;
    let unsubMsgs = null;

    const fmtTime = (d)=> new Date(d).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    const fmtDT = (t)=> t?.toDate?.() ? t.toDate() : (t instanceof Date ? t : null);
    function scrollBottom(){ messagesDiv.scrollTop = messagesDiv.scrollHeight; }

    function openSidebar(){ sidebar.classList.add("open"); overlay.classList.add("show"); }
    function closeSidebar(){ sidebar.classList.remove("open"); overlay.classList.remove("show"); }
    btnList.addEventListener("click", openSidebar);
    overlay.addEventListener("click", closeSidebar);

    function renderMessage(m){
      const wrapper = document.createElement("div");
      wrapper.className = "msg" + (m.sender === currentUser.uid ? " mine" : "");
      const ts = fmtDT(m.createdAt) || new Date();
      wrapper.innerHTML = `<div>${(m.text || "").replace(/</g,"&lt;")}</div><div class="meta">${ts.toLocaleString()}</div>`;
      messagesDiv.appendChild(wrapper);
    }

    async function ensureThread(driverUid, driverName, driverEmail){
      const tref = doc(db, "threads", driverUid);
      const snap = await getDoc(tref);
      if (!snap.exists()) {
        await setDoc(tref, {
          participants: [ADMIN_UID, driverUid],
          driverName: driverName || "",
          driverEmail: driverEmail || "",
          lastMessage: "",
          updatedAt: serverTimestamp()
        });
      }
      return tref;
    }

    function markActive(threadId){
      document.querySelectorAll(".item").forEach(el => el.classList.remove("active"));
      const el = document.getElementById(`item-${threadId}`);
      if (el) el.classList.add("active");
    }

    function openThread(driverUid, headerLabel){
      currentThreadId = driverUid;
      markActive(driverUid);
      topbar.textContent = headerLabel || "Chat";
      messagesDiv.innerHTML = "";
      if (unsubMsgs) { unsubMsgs(); unsubMsgs=null; }

      const msgsRef = collection(db, "threads", currentThreadId, "messages");
      const qMsgs = query(msgsRef, orderBy("createdAt", "asc"));
      unsubMsgs = onSnapshot(qMsgs, (snap) => {
        messagesDiv.innerHTML = "";
        const toMark = [];
        snap.forEach(d => {
          const m = d.data();
          renderMessage(m);
          const rb = Array.isArray(m.readBy) ? m.readBy : [];
          if (!rb.includes(currentUser.uid)) toMark.push(d.id);
        });
        scrollBottom();
        toMark.forEach(async (id) => {
          const mref = doc(db, "threads", currentThreadId, "messages", id);
          try { await updateDoc(mref, { readBy: arrayUnion(currentUser.uid) }); } catch {}
        });
      });
      closeSidebar();
    }

    function enableComposer(on){ input.disabled = !on; sendBtn.disabled = !on; }

    async function sendMessage(){
      const text = input.value.trim();
      if (!text || !currentThreadId) return;
      const msgsRef = collection(db, "threads", currentThreadId, "messages");
      await addDoc(msgsRef, { text, sender: currentUser.uid, createdAt: serverTimestamp(), readBy: [currentUser.uid] });
      await updateDoc(doc(db,"threads", currentThreadId), { lastMessage: text, updatedAt: serverTimestamp() });
      input.value = ""; scrollBottom();
    }
    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

    // Sidebar helpers
    function makeItemEl(threadOrFake){
      const uid = threadOrFake.id;
      const d = typeof threadOrFake.data === "function" ? threadOrFake.data() : threadOrFake;
      const name = d.driverName || uid;
      const initials = (name || uid).substring(0,2).toUpperCase();
      const el = document.createElement("div");
      el.id = `item-${uid}`;
      el.className = "item";
      el.innerHTML = `
        <div class="avatar">${initials}</div>
        <div class="col">
          <div class="name">${name}</div>
          <div class="preview" id="pv-${uid}">${d.lastMessage || "â€”"}</div>
        </div>
      `;
      el.addEventListener("click", () => openThread(uid, `Driver: ${name}`));
      return el;
    }

    // --- Notifiche in-app lato driver ---
    function showToast(msg, ms=2500){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=> toastEl.classList.remove("show"), ms);
    }
    function beep(){
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.08, ctx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
        o.connect(g); g.connect(ctx.destination);
        o.start(); o.stop(ctx.currentTime + 0.2);
      } catch {}
    }
    function vibrate(){ if (navigator.vibrate) navigator.vibrate(60); }
    function notifyIncoming(text){
      showToast(`ðŸ“© Nuovo messaggio: ${text}`);
      beep(); vibrate();
    }
    function watchIncomingForDriver(threadId, adminUid, myUid){
      const msgsRef = collection(db, "threads", threadId, "messages");
      const qLast = query(msgsRef, orderBy("createdAt","desc"), limit(1));
      let initialized = false;
      return onSnapshot(qLast, (snap) => {
        if (snap.empty) { initialized = true; return; }
        const doc = snap.docs[0];
        const m = doc.data();
        const rb = Array.isArray(m.readBy) ? m.readBy : [];
        const isFromAdmin = m.sender === adminUid;
        const iHaveNotRead = !rb.includes(myUid);
        if (initialized && isFromAdmin && iHaveNotRead) {
          notifyIncoming(m.text || "Nuovo messaggio");
        }
        initialized = true;
      });
    }

    // Header nav: Home solo per admin, "Torna allâ€™app" per driver
    function setHeaderForRole(isAdmin){
      if (isAdmin){
        navBtn.textContent = "ðŸ  Home";
        navBtn.href = "home.html";
      } else {
        navBtn.textContent = "â¬… Torna allâ€™app";
        navBtn.href = "index.html"; // pagina principale driver
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "index.html"; return; }
      currentUser = user;
      enableComposer(true);

      const isAdmin = user.uid === ADMIN_UID;
      setHeaderForRole(isAdmin);

      if (!isAdmin) {
        // DRIVER
        await ensureThread(user.uid, "", "");
        sidebar.innerHTML = "";
        const meItem = makeItemEl({ id: user.uid, data: () => ({ driverName: "Chat con Admin" }) });
        sidebar.appendChild(meItem);
        openThread(user.uid, "Chat con Admin");
        // attiva notifiche
        watchIncomingForDriver(user.uid, ADMIN_UID, user.uid);
      } else {
        // ADMIN: mostra tutte le chat
        const threadsRef = collection(db,"threads");
        const qThreads = query(threadsRef, orderBy("updatedAt","desc"));
        onSnapshot(qThreads, (snap) => {
          sidebar.innerHTML = "";
          if (snap.empty) { sidebar.innerHTML = `<div class="empty">Nessuna chat aperta.</div>`; return; }
          snap.forEach(t => { const item = makeItemEl(t); sidebar.appendChild(item); });
          if (!currentThreadId && !snap.empty) {
            const first = snap.docs[0];
            openThread(first.id, `Driver: ${(first.data().driverName || first.id)}`);
          }
        });
      }
    });
  </script>
</body>
</html>
