<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîî Test Notifiche - Diagnosi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
            line-height: 1.6;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .check {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
            border-left: 5px solid;
        }
        .ok {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        .big-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        .big-button:hover {
            background: #0056b3;
        }
        .step {
            background: #e9ecef;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .device-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Diagnosi Notifiche - Per Non Programmatori</h1>
        
        <div class="step">
            <h3>üì± Il Tuo Dispositivo</h3>
            <div id="device-info" class="device-info">Caricamento info dispositivo...</div>
        </div>

        <div class="step">
            <h3>üîç Controlli Automatici</h3>
            <div id="checks">Controllo in corso...</div>
        </div>

        <div class="step">
            <h3>üß™ Test Pratico</h3>
            <p>Clicca questo pulsante per testare se le notifiche funzionano:</p>
            <button class="big-button" onclick="testNotification()">
                üîî PROVA NOTIFICA ADESSO
            </button>
            <div id="test-result"></div>
        </div>

        <div class="step">
            <h3>üìã Cosa Fare Ora</h3>
            <div id="instructions">In attesa dei risultati dei test...</div>
        </div>
    </div>

    <script>
        // Funzione per identificare il dispositivo
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const isAndroid = /Android/.test(ua);
            const isChrome = /Chrome/.test(ua);
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            
            return {
                isIOS,
                isAndroid,
                isChrome,
                isSafari,
                isPWA,
                userAgent: ua
            };
        }

        // Controlli automatici
        function runChecks() {
            const device = getDeviceInfo();
            const checks = [];
            
            // Info dispositivo
            document.getElementById('device-info').innerHTML = `
                üì± Dispositivo: ${device.isIOS ? 'iPhone/iPad' : device.isAndroid ? 'Android' : 'Desktop/Altro'}<br>
                üåê Browser: ${device.isChrome ? 'Chrome' : device.isSafari ? 'Safari' : 'Altro'}<br>
                üì≤ PWA Mode: ${device.isPWA ? 'S√å (perfetto!)' : 'NO'}<br>
                üîí HTTPS: ${location.protocol === 'https:' ? 'S√å' : 'NO'}
            `;

            // Check 1: HTTPS
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                checks.push({
                    type: 'ok',
                    message: '‚úÖ HTTPS: Il sito √® sicuro (ottimo!)'
                });
            } else {
                checks.push({
                    type: 'error',
                    message: '‚ùå HTTPS: Il sito NON √® sicuro. Le notifiche non funzioneranno mai!'
                });
            }

            // Check 2: Supporto notifiche
            if ('Notification' in window) {
                checks.push({
                    type: 'ok',
                    message: '‚úÖ SUPPORTO: Il browser supporta le notifiche'
                });
            } else {
                checks.push({
                    type: 'error',
                    message: '‚ùå SUPPORTO: Il browser NON supporta le notifiche'
                });
            }

            // Check 3: Permessi
            const permission = Notification.permission;
            if (permission === 'granted') {
                checks.push({
                    type: 'ok',
                    message: '‚úÖ PERMESSI: Notifiche autorizzate'
                });
            } else if (permission === 'denied') {
                checks.push({
                    type: 'error',
                    message: '‚ùå PERMESSI: Notifiche bloccate. Devi sbloccarle nelle impostazioni!'
                });
            } else {
                checks.push({
                    type: 'warning',
                    message: '‚ö†Ô∏è PERMESSI: Non ancora richiesti (normale)'
                });
            }

            // Check 4: iOS specifico
            if (device.isIOS) {
                if (device.isPWA) {
                    checks.push({
                        type: 'ok',
                        message: '‚úÖ iOS: App aperta in modalit√† PWA (perfetto!)'
                    });
                } else {
                    checks.push({
                        type: 'error',
                        message: '‚ùå iOS: Devi aggiungere l\'app alla Home Screen e aprirla da l√¨!'
                    });
                }
            }

            // Mostra risultati
            const checksDiv = document.getElementById('checks');
            checksDiv.innerHTML = checks.map(check => 
                `<div class="check ${check.type}">${check.message}</div>`
            ).join('');

            // Istruzioni personalizzate
            generateInstructions(device, checks);
        }

        // Test notifica pratico
        async function testNotification() {
            const resultDiv = document.getElementById('test-result');
            
            try {
                // Richiedi permessi se necessario
                let permission = Notification.permission;
                if (permission === 'default') {
                    permission = await Notification.requestPermission();
                }

                if (permission !== 'granted') {
                    resultDiv.innerHTML = '<div class="check error">‚ùå Permessi negati! Vai nelle impostazioni del browser e abilita le notifiche per questo sito.</div>';
                    return;
                }

                // Crea notifica di test
                const notification = new Notification('üéâ FUNZIONA!', {
                    body: 'Le notifiche del tuo browser funzionano correttamente!',
                    icon: '/icon192.png',
                    tag: 'test'
                });

                // Chiudi dopo 3 secondi
                setTimeout(() => notification.close(), 3000);

                resultDiv.innerHTML = '<div class="check ok">‚úÖ SUCCESSO! Hai visto la notifica? Se s√¨, il problema √® nella configurazione Firebase.</div>';

            } catch (error) {
                resultDiv.innerHTML = `<div class="check error">‚ùå ERRORE: ${error.message}</div>`;
            }
        }

        // Genera istruzioni personalizzate
        function generateInstructions(device, checks) {
            const instructionsDiv = document.getElementById('instructions');
            let instructions = [];

            const hasErrors = checks.some(check => check.type === 'error');

            if (!hasErrors) {
                instructions.push('üéâ <strong>Ottimo!</strong> Tutti i controlli di base sono OK.');
                instructions.push('üëÜ <strong>Ora clicca "PROVA NOTIFICA"</strong> sopra per il test finale.');
                instructions.push('');
                instructions.push('Se il test funziona ma le notifiche della chat non arrivano:');
                instructions.push('‚Ä¢ Il problema √® nella configurazione Firebase');
                instructions.push('‚Ä¢ Controlla che le Cloud Functions siano attive');
                instructions.push('‚Ä¢ Verifica che il token FCM sia salvato correttamente');
            } else {
                instructions.push('‚ùå <strong>Ci sono problemi da risolvere:</strong>');
                instructions.push('');

                if (device.isIOS && !device.isPWA) {
                    instructions.push('üçé <strong>PROBLEMA IPHONE:</strong>');
                    instructions.push('1. Apri la tua app in Safari');
                    instructions.push('2. Tocca il pulsante "Condividi" (quadrato con freccia)');
                    instructions.push('3. Scorri e tocca "Aggiungi a Home"');
                    instructions.push('4. Chiudi Safari');
                    instructions.push('5. Apri l\'app SOLO dalla Home Screen');
                    instructions.push('');
                }

                if (location.protocol !== 'https:') {
                    instructions.push('üîí <strong>PROBLEMA HTTPS:</strong>');
                    instructions.push('‚Ä¢ Il tuo sito deve essere su HTTPS');
                    instructions.push('‚Ä¢ Configura il certificato SSL');
                    instructions.push('‚Ä¢ Le notifiche non funzioneranno MAI su HTTP');
                    instructions.push('');
                }

                if (Notification.permission === 'denied') {
                    instructions.push('üö´ <strong>PERMESSI BLOCCATI:</strong>');
                    if (device.isAndroid) {
                        instructions.push('‚Ä¢ Chrome: 3 puntini ‚Üí Impostazioni sito ‚Üí Notifiche ‚Üí Consenti');
                    } else if (device.isIOS) {
                        instructions.push('‚Ä¢ Impostazioni iPhone ‚Üí Safari ‚Üí Impostazioni siti web ‚Üí Notifiche');
                    }
                    instructions.push('');
                }
            }

            instructions.push('üìû <strong>Serve aiuto?</strong>');
            instructions.push('Fai uno screenshot di questa pagina e invialo al tuo sviluppatore.');

            instructionsDiv.innerHTML = instructions.map(line => 
                line === '' ? '<br>' : `<p style="margin: 5px 0;">${line}</p>`
            ).join('');
        }

        // Esponi la funzione globalmente
        window.testNotification = testNotification;

        // Avvia controlli al caricamento
        document.addEventListener('DOMContentLoaded', runChecks);
    </script>
</body>
</html>