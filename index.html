<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archivio Clienti - Trasporti</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      margin: 0;
      background-color: #f9f9f9;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 10px;
    }
    input, textarea, button {
      margin: 6px 0;
      width: 100%;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    #clienti {
      margin-top: 20px;
    }
    .cliente {
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
      background-color: #fff;
    }
    .btn-azione {
      margin-top: 8px;
      margin-right: 5px;
      font-size: 14px;
      padding: 6px 10px;
    }
    .avviso {
      background-color: #fff3cd;
      padding: 10px;
      border-left: 5px solid #ffc107;
      margin-bottom: 20px;
      border-radius: 5px;
      font-size: 14px;
    }
    @media (min-width: 600px) {
      h1 { font-size: 24px; }
      input, textarea, button { font-size: 16px; }
    }
  </style>
</head>
<body>
  <h1>Archivio Clienti - Trasporti</h1>

  <div class="avviso">
    ‚ö†Ô∏è <strong>Attenzione:</strong> Questa app contiene dati riservati dei clienti ed √® destinata esclusivamente all'uso operativo da parte di trasportatori autorizzati. √à vietata la copia, diffusione o qualsiasi utilizzo non legato all'attivit√† di consegna.
  </div>

  <div>
    <input id="nome" placeholder="Nome cliente">
    <input id="indirizzo" placeholder="Indirizzo">
    <input id="coordinate" placeholder="Coordinate (es: 44.8015, 10.3274)">
    <button id="btn-gps" type="button">üìç Usa la mia posizione attuale</button>
    <textarea id="note" placeholder="Note per la consegna"></textarea>
    <button id="btn-aggiungi">Aggiungi cliente</button>
    <button id="btn-annulla" style="display:none; background-color: #eee;">Annulla modifica</button>
  </div>

  <div>
    <input id="cerca" placeholder="Cerca cliente">
  </div>

  <div id="clienti"></div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBbjK5sgQ70-p8jODaK_PnLIzPxgfrqQ34",
      authDomain: "archivio-clienti-trasporti.firebaseapp.com",
      projectId: "archivio-clienti-trasporti",
      storageBucket: "archivio-clienti-trasporti.firebasestorage.app",
      messagingSenderId: "773533170263",
      appId: "1:773533170263:web:d05e2b00e991b0294c0112"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const clientiRef = collection(db, "clienti");

    let clienteDaModificare = null;

    async function aggiungiOmodificaCliente() {
      const nome = document.getElementById("nome").value;
      const indirizzo = document.getElementById("indirizzo").value;
      const coordinate = document.getElementById("coordinate").value;
      const note = document.getElementById("note").value;

      if (!nome || !indirizzo) {
        alert("Inserisci almeno nome e indirizzo.");
        return;
      }

      if (clienteDaModificare) {
        const docRef = doc(db, "clienti", clienteDaModificare);
        try {
          await updateDoc(docRef, { nome, indirizzo, coordinate, note });
          clienteDaModificare = null;
          document.getElementById("btn-aggiungi").innerText = "Aggiungi cliente";
          document.getElementById("btn-annulla").style.display = "none";
        } catch (error) {
          alert("Impossibile salvare le modifiche: il cliente non esiste pi√π.");
          console.error(error);
        }
      } else {
        await addDoc(clientiRef, { nome, indirizzo, coordinate, note, timestamp: new Date() });
      }

      document.getElementById("nome").value = "";
      document.getElementById("indirizzo").value = "";
      document.getElementById("coordinate").value = "";
      document.getElementById("note").value = "";
    }

    async function eliminaCliente(id) {
      if (confirm("Sei sicuro di voler eliminare questo cliente?")) {
        await deleteDoc(doc(db, "clienti", id));
      }
    }

    function preparaModificaCliente(id, cliente) {
      document.getElementById("nome").value = cliente.nome;
      document.getElementById("indirizzo").value = cliente.indirizzo;
      document.getElementById("coordinate").value = cliente.coordinate;
      document.getElementById("note").value = cliente.note;
      clienteDaModificare = id;
      document.getElementById("btn-aggiungi").innerText = "Salva modifiche";
      document.getElementById("btn-annulla").style.display = "inline-block";
    }

    function annullaModifica() {
      clienteDaModificare = null;
      document.getElementById("nome").value = "";
      document.getElementById("indirizzo").value = "";
      document.getElementById("coordinate").value = "";
      document.getElementById("note").value = "";
      document.getElementById("btn-aggiungi").innerText = "Aggiungi cliente";
      document.getElementById("btn-annulla").style.display = "none";
    }

    function mostraClienti(snapshot) {
      const clientiDiv = document.getElementById("clienti");
      clientiDiv.innerHTML = "";
      snapshot.forEach(docSnap => {
        const c = docSnap.data();
        const div = document.createElement("div");
        div.className = "cliente";
        div.innerHTML = `<strong>${c.nome}</strong><br>
                         ${c.indirizzo}<br>
                         ${c.coordinate ? `<a href='https://maps.google.com/?q=${c.coordinate}' target='_blank'>Vai a Google Maps</a><br>` : ""}
                         ${c.note ? `<em>${c.note}</em><br>` : ""}
                         <button class='btn-azione' onclick='eliminaCliente("${docSnap.id}")'>üóëÔ∏è Elimina</button>
                         <button class='btn-azione' onclick='preparaModificaCliente("${docSnap.id}", ${JSON.stringify(c).replace(/"/g, '&quot;')})'>‚úèÔ∏è Modifica</button>`;
        clientiDiv.appendChild(div);
      });
    }

    function filtraClienti() {
      const queryTxt = document.getElementById("cerca").value.toLowerCase();
      const clienti = document.querySelectorAll(".cliente");
      clienti.forEach(c => {
        c.style.display = c.innerText.toLowerCase().includes(queryTxt) ? "block" : "none";
      });
    }

    document.getElementById("btn-aggiungi").addEventListener("click", aggiungiOmodificaCliente);
    document.getElementById("btn-annulla").addEventListener("click", annullaModifica);
    document.getElementById("cerca").addEventListener("input", filtraClienti);

    document.getElementById("btn-gps").addEventListener("click", () => {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const coords = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
            document.getElementById("coordinate").value = coords;
          },
          error => {
            alert("Impossibile ottenere la posizione. Assicurati che il GPS sia attivo.");
            console.error(error);
          }
        );
      } else {
        alert("Geolocalizzazione non supportata dal browser.");
      }
    });

    const q = query(clientiRef);
    onSnapshot(q, mostraClienti);

    window.eliminaCliente = eliminaCliente;
    window.preparaModificaCliente = preparaModificaCliente;
  </script>
</body>
</html>