<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Archivio Clienti - Trasporti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="./manifest.json">

  <style>
    :root { --bg:#f9f9f9; --card:#fff; --txt:#222; --muted:#666; --brand:#007bff; }
    body { font-family: Arial, sans-serif; padding: 15px; margin: 0; background-color: var(--bg); color:var(--txt); }
    h1 { font-size: 22px; margin-bottom: 10px; }
    input, textarea, button, select { margin: 6px 0; width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; }
    #clienti { margin-top: 20px; }
    .cliente { border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 8px; background-color: var(--card); }
    .btn-azione { margin-top: 8px; margin-right: 5px; font-size: 14px; padding: 6px 10px; }
    .avviso { background-color: #fff3cd; padding: 10px; border-left: 5px solid #ffc107; margin-bottom: 20px; border-radius: 5px; font-size: 14px; }
    #auth-overlay, #awaiting-approval { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: none; align-items: center; justify-content: center; padding: 20px; }
    #auth-box { width: 100%; max-width: 420px; background: var(--card); border: 1px solid #ddd; border-radius: 12px; padding: 0; box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
    #auth-header { padding: 14px 16px; border-bottom:1px solid #eee; font-weight:700; display:flex; gap:8px; align-items:center; }
    #auth-header::before { content:"üîê"; }
    .tabs { display:flex; gap:0; border-bottom:1px solid #eee; }
    .tab { flex:1; padding:10px 12px; background:#fafafa; border:none; border-right:1px solid #eee; cursor:pointer; font-weight:600; }
    .tab:last-child { border-right:none; }
    .tab.active { background:#fff; color:#000; border-bottom:2px solid var(--brand); }
    .pane { padding: 14px 16px; }
    .muted { color: var(--muted); font-size: 13px; }

    #status { margin-top: 10px; font-size: 14px; font-style: italic; }
    button { cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .userbar{ background:#eef6ff; border:1px solid #cfe3ff; color:#0b3d91; padding:8px 12px; border-radius:8px; margin:8px 0 12px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; font-size:14px; }
.userbar .pill{ background:#fff; border:1px solid #cfe3ff; padding:2px 8px; border-radius:999px; font-size:12px; color:#1b3c6b; }

/* ‚úÖ PULSANTI PRINCIPALI CON DIMENSIONI UNIFORMI */
/* ‚úÖ PULSANTI PRINCIPALI SEMPRE AFFIANCATI */
.main-actions {
  display: flex;
  gap: 6px;
  margin-bottom: 16px;
}

.link-pill {
  display: inline-block;
  padding: 12px 16px;
  border: 2px solid #007bff;  /* ‚úÖ Bordo pi√π spesso e colorato */
  border-radius: 10px;
  background: linear-gradient(135deg, #eef6ff, #d6e9ff);  /* ‚úÖ Sfondo gradiente */
  color: #0b3d6b;
  text-decoration: none;
  position: relative;
  box-shadow: 0 2px 4px rgba(0, 123, 255, 0.15);  /* ‚úÖ Ombra leggera */
  transition: all 0.2s ease;  /* ‚úÖ Animazione hover */
}

.link-pill:hover {
  transform: translateY(-2px);  /* ‚úÖ Effetto sollevamento */
  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.25);
  border-color: #0056b3;
}

.main-actions .link-pill {
  flex: 1;
  min-width: 0;
  padding: 14px 10px;  /* ‚úÖ Pi√π padding */
  font-size: 15px;      /* ‚úÖ Font pi√π grande */
  font-weight: 600;     /* ‚úÖ Testo in grassetto */
  min-height: 52px;     /* ‚úÖ Altezza minima */
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  text-align: center;
  overflow: hidden;
}

@media (max-width: 600px) {
  .main-actions .link-pill {
    font-size: 13px;
    padding: 12px 6px;
    min-height: 48px;
    gap: 4px;
  }
}
.chat-counter {
  position: absolute; 
  top: -0px !important; 
  right: -0px !important;
  background-color: #f44336; 
  color: #fff; 
  border-radius: 60%;
  width: 16px !important; 
  height: 16px !important; 
  min-width: 16px !important;
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-size: 10px !important; 
  font-weight: bold; 
  border: 1px solid #fff !important; 
  box-shadow: 0 1px 3px rgba(0,0,0,.2) !important;
}    
.chat-counter.hidden { display:none; }
    @keyframes bounce { 0%,20%,60%,100%{transform:translateY(0)} 40%{transform:translateY(-10px)} 80%{transform:translateY(-5px)} }
    .chat-counter.new-message { animation: bounce 1s ease-in-out; }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 320px; }
    .toast {
      background:#fff; border:1px solid #e0e0e0; border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.15);
      padding:16px; margin-bottom:12px;
      transform:translateX(100%); transition:all .3s cubic-bezier(.4,0,.2,1);
      cursor:pointer; position:relative; overflow:hidden;
    }
    .toast.show { transform:translateX(0); }
    .toast.hide { transform:translateX(100%); opacity:0; }
    .toast::before { content:""; position:absolute; top:0; left:0; width:4px; height:100%; background:var(--brand); }
    .toast-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; font-weight:600; font-size:14px; color:var(--brand); }
    .toast-body { color:#333; font-size:14px; line-height:1.4; margin-left:24px; }
    .toast-close {
      position:absolute; top:8px; right:8px; width:24px; height:24px;
      background:none; border:none; font-size:18px; color:#999; cursor:pointer;
      display:flex; align-items:center; justify-content:center; border-radius:50%;
      transition: background-color .2s;
    }
    .toast-close:hover { background-color:#f0f0f0; }

    .advanced-toast {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-left: 4px solid var(--brand);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.15);
      padding: 0;
      margin-bottom: 12px;
      transform: translateX(100%);
      transition: all .3s cubic-bezier(.4,0,.2,1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      min-width: 320px;
      max-width: 400px;
    }

    .advanced-toast.show {
      transform: translateX(0);
    }

    .advanced-toast.hide {
      transform: translateX(100%);
      opacity: 0;
    }

    .advanced-toast .toast-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--brand);
      border-bottom: 1px solid #f0f0f0;
    }

    .advanced-toast .toast-body {
      color: #333;
      font-size: 14px;
      line-height: 1.4;
      padding: 8px 16px;
    }

    .advanced-toast .toast-actions {
      padding: 8px 16px 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .advanced-toast .toast-action-btn {
      background: var(--brand);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .advanced-toast .toast-action-btn:hover {
      background: #0056b3;
    }

    .advanced-toast .toast-close {
      position: absolute;
      top: 8px;
      right: 12px;
      width: 20px;
      height: 20px;
      background: none;
      border: none;
      font-size: 16px;
      color: #999;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color .2s;
    }

    .advanced-toast .toast-close:hover {
      background-color: #f0f0f0;
    }

    .address-note {
      font-size: 12px; 
      color: #666; 
      margin-top: 4px; 
      margin-bottom: 8px; 
      display: flex; 
      align-items: center; 
      flex-wrap: wrap;
      gap: 8px;
    }
    .toggle-btn {
      padding: 3px 8px; 
      font-size: 11px; 
      background: #e9ecef; 
      border: 1px solid #adb5bd; 
      border-radius: 4px; 
      cursor: pointer;
      white-space: nowrap;
    }
    .toggle-btn:hover {
      background: #dee2e6;
    }

    .client-list-header {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 16px 0 8px 0;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }

    .client-list-header:hover {
      background: linear-gradient(135deg, #0056b3, #004085);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .client-list-title {
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .client-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      min-width: 24px;
      text-align: center;
    }

    .expand-icon {
      font-size: 18px;
      transition: transform 0.3s ease;
      font-weight: bold;
    }

    .expand-icon.expanded {
      transform: rotate(180deg);
    }

    .client-list-container {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out, opacity 0.3s ease;
      opacity: 0;
    }

    .client-list-container.expanded {
      max-height: calc(100vh - 300px);
      opacity: 1;
      overflow-y: auto;
      overflow-x: hidden;
      transition: opacity 0.3s ease;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
      padding: 8px;
      -webkit-overflow-scrolling: touch;
    }

    .cliente {
      border: 1px solid #e0e0e0;
      padding: 14px;
      margin-bottom: 8px;
      border-radius: 8px;
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      position: relative;
    }

    .cliente:hover {
      border-color: #007bff;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
      transform: translateY(-1px);
    }

    .cliente strong {
      color: #2c3e50;
      font-size: 16px;
      display: block;
      margin-bottom: 6px;
    }

    .btn-azione {
      margin: 4px 2px;
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .alphabet-divider {
      background: #f8f9fa;
      color: #6c757d;
      padding: 8px 12px;
      margin: 12px 0 8px 0;
      border-left: 4px solid #007bff;
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 1px;
    }

    .loading-clients {
      text-align: center;
      padding: 20px;
      color: #6c757d;
      font-style: italic;
    }

    .client-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 12px;
      padding: 0 4px;
    }

    .stat-item {
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 6px;
      text-align: center;
      font-size: 12px;
      color: #495057;
      border: 1px solid rgba(0, 123, 255, 0.1);
    }

    .stat-number {
      display: block;
      font-weight: bold;
      font-size: 16px;
      color: #007bff;
    }

    #app-wrapper {
      min-height: 100vh;
      overflow: visible;
    }

    @media (max-width: 768px) {
      .client-list-container.expanded {
        max-height: calc(100vh - 400px);
      }
    }

    .client-list-container.expanded::-webkit-scrollbar {
      width: 6px;
    }

    .client-list-container.expanded::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .client-list-container.expanded::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    .client-list-container.expanded::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    .search-container {
      position: relative;
      margin-bottom: 8px;
    }

    .search-container input {
      background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
      border: 2px solid #ffc107;
      border-radius: 12px;
      color: #856404;
      font-size: 16px;
      font-weight: 500;
      padding: 12px 45px 12px 45px;
      width: 100%;
      box-sizing: border-box;
      transition: all 0.3s ease;
      margin: 0;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
    }

    .search-container input:focus {
      outline: none;
      border-color: #ff9800;
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2);
      background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
    }

    .search-container input::placeholder {
      color: #856404;
      font-weight: 500;
    }

    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      opacity: 0.6;
      pointer-events: none;
      z-index: 1;
    }

    .search-icon svg {
      width: 100%;
      height: 100%;
      fill: #ff9800;
    }

    .clear-search-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(108, 155, 209, 0.3);
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      color: #6c9bd1;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      margin: 0;
      padding: 0;
    }

    .clear-search-btn:hover {
      background: rgba(108, 155, 209, 0.5);
      color: #0b3d91;
    }

    .clear-search-btn:active {
      transform: translateY(-50%) scale(0.95);
    }

    .input-container {
      position: relative;
      display: flex;
      align-items: center;
      margin: 6px 0;
    }

    .input-container input {
      background: #ffffff;
      border: 1px solid #cfe3ff;
      border-radius: 12px;
      color: #0b3d91;
      font-size: 16px;
      padding: 12px 45px 12px 15px;
      width: 100%;
      box-sizing: border-box;
      transition: all 0.3s ease;
      margin: 0;
    }

    .input-container input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .input-container input::placeholder {
      color: #666;
    }

    .clear-input-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(108, 155, 209, 0.3);
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      color: #6c9bd1;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      margin: 0;
      padding: 0;
    }

    .clear-input-btn:hover {
      background: rgba(108, 155, 209, 0.5);
      color: #0b3d91;
    }

    .clear-input-btn:active {
      transform: translateY(-50%) scale(0.95);
    }

    .form-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-reset {
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      min-width: 40px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      margin: 6px 0;
    }

    .btn-reset:hover {
      background-color: #5a6268;
      transform: scale(1.1);
    }

    .btn-reset:active {
      transform: scale(0.95);
    }

    #nome {
      flex: 1;
    }

  </style>
</head>
<body>

  <div id="auth-overlay">
    <div id="auth-box">
      <div id="auth-header">Accesso</div>
      <div class="tabs">
        <button id="tab-login" class="tab active">Accedi</button>
        <button id="tab-register" class="tab">Registrati</button>
      </div>
      <div id="pane-login" class="pane">
        <input id="log-email" placeholder="Email">
        <input id="log-password" placeholder="Password" type="password">
        <button id="btn-login">Accedi</button>
      </div>
      <div id="pane-register" class="pane" style="display:none;">
        <input id="reg-name" placeholder="Nome (Es: Camion Alessio)" required>
        <input id="reg-email" placeholder="Email" required>
        <input id="reg-password" placeholder="Password (min 6 caratteri)" type="password" required>
        <button id="btn-register">Crea account</button>
        <div class="muted" style="margin-top:8px;">Dopo la registrazione l'account deve essere approvato dall'amministratore.</div>
      </div>
    </div>
  </div>

  <div id="awaiting-approval" class="avviso" style="display:none; flex-direction:column; gap:8px; align-items:center; text-align:center;">
    <h3 style="margin:0;">‚è≥ Account in attesa di approvazione</h3>
    <div>Sei registrato ma non ancora approvato. Quando l'amministratore ti abilita, questa pagina si aggiorner√† automaticamente.</div>
    <button id="btn-logout-while-waiting" style="margin-top:6px; max-width:200px;">Esci</button>
  </div>

  <div id="rubrica-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:999; display:none; align-items:center; justify-content:center; padding:20px;">
    <div style="width:100%; max-width:500px; background:white; border-radius:12px; max-height:80vh; overflow:hidden; display:flex; flex-direction:column;">
      <div style="padding:16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">üìû Rubrica Aziendale</h3>
        <button id="close-rubrica" style="background:none; border:none; font-size:18px; cursor:pointer; padding:4px;">‚úñ</button>
      </div>
      <div style="padding:16px; flex:1; overflow:auto;">
        <input id="cerca-rubrica" placeholder="Cerca nella rubrica..." style="width:100%; margin-bottom:16px; box-sizing:border-box;">
        <div id="rubrica-container"></div>
      </div>
    </div>
  </div>

  <div id="comunicazioni-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:999; display:none; align-items:center; justify-content:center; padding:20px;">
    <div style="width:100%; max-width:700px; background:white; border-radius:12px; max-height:85vh; overflow:hidden; display:flex; flex-direction:column;">
      <div style="padding:16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background: linear-gradient(135deg, #007bff, #0056b3); color: white;">
        <h3 style="margin:0;">üì¢ Comunicazioni Aziendali</h3>
        <button id="close-comunicazioni" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3); color:white; font-size:18px; cursor:pointer; padding:4px 8px; border-radius:4px;">‚úñ</button>
      </div>
      <div style="padding:16px; flex:1; overflow:auto;" id="comunicazioni-driver-container">
        <div style="text-align:center; padding:40px 20px; color:#999;">
          <div style="font-size:48px; margin-bottom:16px;">üì≠</div>
          <div>Caricamento comunicazioni...</div>
        </div>
      </div>
    </div>
  </div>

  <div id="app-wrapper" style="display:none;">
    <h1>Archivio Clienti - Trasporti</h1>
    <div id="userbar" class="userbar"></div>

    <div id="push-activation-wrapper" style="display:none; margin-bottom:12px;">
      <button id="btn-enable-push" style="background-color:#ffdb58; border:1px solid #dcae1d; color:#1b3c6b; padding:6px 12px; border-radius:8px; font-size:14px;">üì± Attiva notifiche push</button>
    </div>

    <div class="avviso">
      ‚ö†Ô∏è <strong>Attenzione:</strong> Questa app contiene dati riservati dei clienti ed √® destinata esclusivamente all'uso operativo da parte di trasportatori autorizzati.
    </div>

    <!-- ‚úÖ PULSANTI PRINCIPALI -->
<div class="main-actions">
  <a class="link-pill" href="chat.html" id="chat-link">
    üí¨ Chat con Admin
    <span class="chat-counter hidden" id="chat-counter">0</span>
  </a>
  <button id="btn-comunicazioni" class="link-pill" style="border:none; cursor:pointer; position:relative;">
    üì¢ Comunicazioni
    <span class="chat-counter hidden" id="comunicazioni-counter">0</span>
  </button>
  <button id="btn-rubrica" class="link-pill" style="border:none; cursor:pointer;">
    üìû Rubrica agenti
  </button>
</div>

    <div>
      <div class="input-container">
        <input id="nome" placeholder="Inserisci nuovo cliente">
        <button id="clear-nome" class="clear-input-btn">√ó</button>
      </div>
      
      <input id="indirizzo" 
             placeholder="Clicca 'Usa la mia posizione attuale' per compilare automaticamente" 
             readonly
             style="background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;">
      
      <div class="address-note">
        üí° L'indirizzo viene compilato automaticamente quando usi la geolocalizzazione
        <button id="btn-manual-address" type="button" class="toggle-btn">
          Inserimento manuale
        </button>
      </div>
      
      <input id="coordinate" placeholder="Coordinate (es: 44.8015, 10.3274)">
      <button id="btn-gps" type="button">üìç Usa la mia posizione attuale</button>
      
      <textarea id="note" placeholder="Note per la consegna"></textarea>
      <button id="btn-aggiungi">Aggiungi cliente</button>
      <button id="btn-annulla" style="display:none; background-color: #eee;">Annulla modifica</button>
    </div>

    <div>
      <div class="search-container">
        <div class="search-icon">
          <svg viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
        </div>
        <input id="cerca" placeholder="Cerca cliente">
        <button id="clear-search" class="clear-search-btn">√ó</button>
      </div>
      
      <div id="client-list-header" class="client-list-header" onclick="toggleClientList()">
        <div class="client-list-title">
          üìã Lista Clienti
          <span id="client-count" class="client-count">0</span>
        </div>
        <span id="expand-icon" class="expand-icon">‚ñº</span>
      </div>
      
      <div id="client-list-container" class="client-list-container">
        <div id="client-stats" class="client-stats" style="display: none;">
          <div class="stat-item">
            <span class="stat-number" id="stat-total">0</span>
            Totale
          </div>
          <div class="stat-item">
            <span class="stat-number" id="stat-with-coords">0</span>
            Con GPS
          </div>
          <div class="stat-item">
            <span class="stat-number" id="stat-with-notes">0</span>
            Con Note
          </div>
          <div class="stat-item">
            <span class="stat-number" id="stat-recent">0</span>
            Recenti
          </div>
        </div>
        
        <div id="clienti"></div>
      </div>
    </div>

  <div id="toast-container" class="toast-container"></div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyBbjK5sgQ70-p8jODaK_PnLIzPxgfrqQ34",
    authDomain: "archivio-clienti-trasporti.firebaseapp.com",
    projectId: "archivio-clienti-trasporti",
    storageBucket: "archivio-clienti-trasporti.firebasestorage.app",
    messagingSenderId: "773533170263",
    appId: "1:773533170263:web:d05e2b00e991b0294c0112"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, deleteDoc, doc, setDoc, updateDoc,
    onSnapshot, query, getDocs, getDoc, orderBy, serverTimestamp, limit,
    enableIndexedDbPersistence  // ‚úÖ AGGIUNTO!
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    onAuthStateChanged, signOut, updateProfile
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js";
  import { arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  // ‚úÖ CACHE OFFLINE
  try {
    await enableIndexedDbPersistence(db);
    console.log('‚úÖ Cache attiva');
  } catch (e) {
    console.warn('Cache non disponibile:', e.code);
  }

    const ADMIN_UID = "0dCvHDcVp1PHuWVNIN9i6ZvEVBt2";
    const clientiRef = collection(db, "clienti");

    let nomeUtente = "";
    let clienteDaModificare = null;
    let chatUnsub = null;
    let currentUserId = null;
    let lastMessageCount = 0;
    let clientiUnsub = null;
    let rubricaUnsub = null;
    let comunicazioniUnsub = null;
    let isClientListExpanded = false;

    function createToast(title, message, onClick) {
      const container = document.getElementById('toast-container');
      if (!container) return;
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        <div class="toast-header"><span>üí¨</span>${title}</div>
        <div class="toast-body">${message}</div>
      `;
      if (onClick) {
        toast.addEventListener('click', (e) => {
          if (e.target.classList.contains('toast-close')) return;
          onClick(); hideToast(toast);
        });
      }
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => hideToast(toast), 6000);
      return toast;
    }
    function hideToast(toast){ toast.classList.add('hide'); setTimeout(()=>{ if(toast.parentElement) toast.remove(); },300); }
    function showMessageToast(senderName, messageText){
      const truncated = messageText.length>80 ? messageText.substring(0,80)+'‚Ä¶' : messageText;
      createToast(`Nuovo messaggio da ${senderName}`, truncated, ()=>{ window.location.href='chat.html'; });
    }

    function showNewMessageNotification(senderName, messageText) {
      if (Notification.permission === 'granted' && (document.hidden || !document.hasFocus())) {
        const notification = new Notification(`Nuovo messaggio da ${senderName}`, {
          body: messageText.length > 100 ? messageText.substring(0, 97) + '...' : messageText,
          icon: './icon192.png',
          tag: 'new-chat-message',
          requireInteraction: false,
          silent: false
        });
        
        notification.onclick = () => {
          window.focus();
          window.location.href = 'chat.html';
          notification.close();
        };
        
        setTimeout(() => notification.close(), 8000);
      }
      
      createAdvancedToast(
        `üí¨ Nuovo messaggio da ${senderName}`, 
        messageText, 
        () => { window.location.href = 'chat.html'; }
      );
      
      playNotificationSound();
    }

    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (error) {
        console.log('Suono notifica non disponibile');
      }
    }

    function createAdvancedToast(title, message, onClick) {
      const container = document.getElementById('toast-container') || createToastContainer();
      
      const toast = document.createElement('div');
      toast.className = 'toast advanced-toast';
      toast.innerHTML = `
        <div class="toast-header">
          <span>üîî</span>
          <strong>${title}</strong>
          <button class="toast-close">√ó</button>
        </div>
        <div class="toast-body">${message.length > 150 ? message.substring(0, 147) + '...' : message}</div>
        <div class="toast-actions">
          <button class="toast-action-btn">Apri Chat</button>
        </div>
      `;
      
      const closeBtn = toast.querySelector('.toast-close');
      const actionBtn = toast.querySelector('.toast-action-btn');
      
      closeBtn.onclick = () => hideAdvancedToast(toast);
      actionBtn.onclick = () => { if (onClick) onClick(); hideAdvancedToast(toast); };
      
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => hideAdvancedToast(toast), 10000);
      
      return toast;
    }

    function createToastContainer() {
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container';
        document.body.appendChild(container);
      }
      return container;
    }

    function hideAdvancedToast(toast) {
      toast.classList.remove('show');
      toast.classList.add('hide');
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 300);
    }

    function requestNotificationPermissionOnFirstLogin() {
      if (Notification.permission === 'default') {
        const userWantsNotifications = confirm(
          "Vuoi ricevere notifiche quando arrivano nuovi messaggi dall'admin?\n\n" +
          "Le notifiche ti aiuteranno a non perdere comunicazioni importanti."
        );
        
        if (userWantsNotifications) {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              console.log('‚úÖ Notifiche autorizzate');
              createToast('üîî Notifiche attivate', 'Riceverai notifiche per i nuovi messaggi dall\'admin');
            } else {
              console.log('‚åõ Notifiche rifiutate');
            }
          });
        }
      }
    }

    function toggleClientList() {
      const container = document.getElementById('client-list-container');
      const icon = document.getElementById('expand-icon');
      
      isClientListExpanded = !isClientListExpanded;
      
      if (isClientListExpanded) {
        container.classList.add('expanded');
        icon.classList.add('expanded');
        updateClientStats();
      } else {
        container.classList.remove('expanded');
        icon.classList.remove('expanded');
      }
    }

    function updateClientStats() {
      const clientiDiv = document.getElementById("clienti");
      const clientCards = clientiDiv.querySelectorAll('.cliente');
      
      const total = clientCards.length;
      let withCoords = 0;
      let withNotes = 0;
      let recent = 0;
      
      const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
      
      clientCards.forEach(card => {
        const content = card.innerHTML;
        if (content.includes('maps.google.com')) withCoords++;
        if (content.includes('üìù Note:')) withNotes++;
        
        const timeText = card.textContent;
        if (timeText.includes('ore fa') || timeText.includes('minuti fa') || 
            timeText.includes('oggi') || timeText.includes('ieri')) {
          recent++;
        }
      });
      
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-with-coords').textContent = withCoords;
      document.getElementById('stat-with-notes').textContent = withNotes;
      document.getElementById('stat-recent').textContent = recent;
      
      document.getElementById('client-stats').style.display = total > 0 ? 'grid' : 'none';
    }

    function formatDateRelative(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      
      if (diffMinutes < 60) {
        return `${diffMinutes} minuti fa`;
      } else if (diffHours < 24) {
        return `${diffHours} ore fa`;
      } else if (diffDays === 1) {
        return "ieri";
      } else if (diffDays < 7) {
        return `${diffDays} giorni fa`;
      } else {
        return date.toLocaleDateString('it-IT');
      }
    }

    function startClientiListener(){
      if (clientiUnsub) return;
      const q = query(clientiRef);
      clientiUnsub = onSnapshot(q, mostraClienti, (err)=>console.error(err));
    }
    function stopClientiListener(){ if (clientiUnsub){ clientiUnsub(); clientiUnsub=null; } }

    function startRubricaListener(){
      if (rubricaUnsub) return;
      const qRubrica = query(collection(db, "rubrica"), orderBy("nome", "asc"));
      rubricaUnsub = onSnapshot(qRubrica, mostraRubrica, (err)=>console.error("Errore rubrica:", err));
    }
    function stopRubricaListener(){ if (rubricaUnsub){ rubricaUnsub(); rubricaUnsub=null; } }

    function startComunicazioniListener(){
      if (comunicazioniUnsub) return;
      const qComunicazioni = query(collection(db, "comunicazioni"), orderBy("createdAt", "desc"));
      comunicazioniUnsub = onSnapshot(qComunicazioni, mostraComunicazioni, (err)=>console.error("Errore comunicazioni:", err));
    }
    function stopComunicazioniListener(){ 
      if (comunicazioniUnsub){ 
        comunicazioniUnsub(); 
        comunicazioniUnsub=null; 
        updateComunicazioniCounter(0);
      } 
    }

    function mostraComunicazioni(snapshot) {
      const container = el("comunicazioni-driver-container");
      const counter = el("comunicazioni-counter");
      
      container.innerHTML = "";
      
      if (snapshot.empty) {
        container.innerHTML = `
          <div style="text-align:center; padding:40px 20px; color:#999;">
            <div style="font-size:48px; margin-bottom:16px;">üì≠</div>
            <div>Nessuna comunicazione disponibile</div>
          </div>
        `;
        counter.classList.add('hidden');
        return;
      }

      // Conta solo le comunicazioni NON lette
      let unreadCount = 0;
      snapshot.forEach(docSnap => {
        const comunicazione = docSnap.data();
        const readBy = Array.isArray(comunicazione.readBy) ? comunicazione.readBy : [];
        if (!readBy.includes(currentUserId)) {
          unreadCount++;
        }
      });

      // Aggiorna il counter con le non lette
      if (unreadCount > 0) {
        counter.textContent = unreadCount > 99 ? '99+' : unreadCount;
        counter.classList.remove('hidden');
      } else {
        counter.classList.add('hidden');
      }

      snapshot.forEach(docSnap => {
        const comunicazione = docSnap.data();
        const comunicazioneId = docSnap.id;
        const readBy = Array.isArray(comunicazione.readBy) ? comunicazione.readBy : [];
        const isRead = readBy.includes(currentUserId);
        
        const dataCreazione = comunicazione.createdAt?.toDate?.() 
          ? comunicazione.createdAt.toDate().toLocaleDateString('it-IT', { 
              year: 'numeric', month: 'long', day: 'numeric',
              hour: '2-digit', minute: '2-digit'
            })
          : "Data non disponibile";
        
        const fileSize = comunicazione.fileSize 
          ? (comunicazione.fileSize / 1024).toFixed(0) + ' KB'
          : '';
        
        const card = document.createElement("div");
        card.className = "cliente";
        card.style.background = isRead 
          ? "linear-gradient(135deg, #f8f9fa, #e9ecef)" 
          : "linear-gradient(135deg, #ffffff, #f8f9fa)";
        card.style.borderLeft = isRead ? "4px solid #6c757d" : "4px solid #007bff";
        card.innerHTML = `
          <div style="display:flex; align-items:start; gap:12px; margin-bottom:12px;">
            <div style="font-size:32px; line-height:1;">${isRead ? 'üìÑ' : 'üì©'}</div>
            <div style="flex:1;">
              <strong style="font-size:18px; color:${isRead ? '#6c757d' : '#007bff'}; display:block; margin-bottom:6px;">
                ${comunicazione.titolo || "(senza titolo)"}
                ${!isRead ? '<span style="background:#ff4757; color:white; font-size:11px; padding:2px 6px; border-radius:10px; margin-left:8px;">NUOVO</span>' : ''}
              </strong>
              ${comunicazione.descrizione ? `
                <div style="color:#495057; font-size:14px; line-height:1.5; margin-bottom:8px;">
                  ${comunicazione.descrizione}
                </div>
              ` : ""}
              <div style="font-size:12px; color:#6c757d; margin-top:8px;">
                üìÖ ${dataCreazione}
                ${comunicazione.fileName ? ` ‚Ä¢ üìé ${comunicazione.fileName}` : ''}
                ${fileSize ? ` ‚Ä¢ üíæ ${fileSize}` : ''}
              </div>
            </div>
          </div>
          ${comunicazione.fileUrl ? `
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
              <a href="${comunicazione.fileUrl}" target="_blank" 
                 onclick="segnaComeLetta('${comunicazioneId}')"
                 style="flex:1; min-width:140px; text-align:center; padding:10px 16px; background:#007bff; color:white; text-decoration:none; border-radius:8px; font-weight:500; transition:all 0.2s;">
                üëÅÔ∏è Visualizza PDF
              </a>
              <a href="${comunicazione.fileUrl}" download="${comunicazione.fileName || 'comunicazione.pdf'}" 
                 style="flex:1; min-width:140px; text-align:center; padding:10px 16px; background:#28a745; color:white; text-decoration:none; border-radius:8px; font-weight:500; transition:all 0.2s;">
                ‚¨áÔ∏è Scarica
              </a>
            </div>
          ` : ''}
        `;
        container.appendChild(card);
      });
    }

    // Funzione per segnare la comunicazione come letta
async function segnaComeLetta(comunicazioneId) {
  if (!currentUserId) return;
  
  try {
    const comunicazioneRef = doc(db, "comunicazioni", comunicazioneId);
    await updateDoc(comunicazioneRef, {
      readBy: arrayUnion(currentUserId)
    });
    console.log('‚úÖ Comunicazione segnata come letta');
  } catch (error) {
    console.error('Errore nel segnare come letta:', error);
  }
}

window.segnaComeLetta = segnaComeLetta;

    function updateComunicazioniCounter(count) {
      const counter = document.getElementById('comunicazioni-counter');
      if (!counter) return;
      
      if (count > 0) {
        counter.textContent = count > 99 ? '99+' : count;
        counter.classList.remove('hidden');
      } else {
        counter.classList.add('hidden');
      }
    }

    function mostraRubrica(snapshot) {
      const container = el("rubrica-container");
      container.innerHTML = "";
      if (snapshot.empty) {
        container.innerHTML = "<div class='muted'>Nessun contatto in rubrica.</div>";
        return;
      }
      snapshot.forEach(docSnap => {
        const contact = docSnap.data();
        const card = document.createElement("div");
        card.className = "cliente";
        card.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
            <strong>${contact.nome || "(senza nome)"}</strong>
          </div>
          ${contact.telefono ? `üìû <a href="tel:${contact.telefono}">${contact.telefono}</a>` : ""}
          ${contact.telefono && contact.email ? " ‚Ä¢ " : ""}
          ${contact.email ? `üìß <a href="mailto:${contact.email}">${contact.email}</a>` : ""}
          ${contact.note ? `<br><em style="color:#666; font-size:13px; margin-top:6px; display:block;">${contact.note}</em>` : ""}
        `;
        container.appendChild(card);
      });
    }

    function filtraRubrica() {
      const queryTxt = el("cerca-rubrica").value.toLowerCase();
      document.querySelectorAll("#rubrica-container .cliente").forEach(c=>{
        const text = c.innerText.toLowerCase();
        c.style.display = text.includes(queryTxt) ? "block" : "none";
      });
    }

    function startChatListener(userId){
      if (chatUnsub) return;
      const threadMessagesRef = collection(db, "threads", userId, "messages");
      const q = query(threadMessagesRef, orderBy("createdAt","desc"), limit(20));
      
      chatUnsub = onSnapshot(q, (snapshot)=>{
        let unreadCount = 0; 
        let latestUnreadMessage = null; 
        const now = Date.now();
        
        snapshot.forEach(doc => {
          const msg = doc.data();
          if (msg.sender !== userId) {
            const readBy = Array.isArray(msg.readBy) ? msg.readBy : [];
            if (!readBy.includes(userId)) {
              unreadCount++;
              if (!latestUnreadMessage) {
                const msgTime = msg.createdAt?.toDate?.()?.getTime() || 0;
                if (now - msgTime < 30000) {
                  latestUnreadMessage = msg;
                }
              }
            }
          }
        });
        
        if (latestUnreadMessage && lastMessageCount < unreadCount && lastMessageCount > 0) {
          showNewMessageNotification('Admin', latestUnreadMessage.text || 'Nuovo messaggio');
        }
        
        lastMessageCount = unreadCount;
        updateChatCounter(unreadCount);
        console.log(`üì± Messaggi non letti: ${unreadCount}`);
      }, (err) => console.error("Errore listener chat:", err));
    }
    
    function stopChatListener(){ if (chatUnsub){ chatUnsub(); chatUnsub=null; lastMessageCount=0; } }
    function updateChatCounter(count){
      const counter = document.getElementById('chat-counter');
      if (count>0){
        counter.textContent = count>99 ? '99+' : count;
        counter.classList.remove('hidden');
        counter.classList.add('new-message'); setTimeout(()=>counter.classList.remove('new-message'),1000);
        document.title = `(${count}) Archivio Clienti - Trasporti`;
      } else {
        counter.classList.add('hidden'); document.title='Archivio Clienti - Trasporti';
      }
    }

    document.getElementById('chat-link').addEventListener('click', async ()=>{
      if (!currentUserId) return;
      try{
        const threadMessagesRef = collection(db, "threads", currentUserId, "messages");
        const q = query(threadMessagesRef);
        const snapshot = await getDocs(q);
        const batch = [];
        snapshot.forEach((d)=>{
          const msg = d.data();
          if (msg.sender !== currentUserId){
            const readBy = Array.isArray(msg.readBy) ? msg.readBy : [];
            if (!readBy.includes(currentUserId)){
              batch.push(updateDoc(d.ref, { readBy: arrayUnion(currentUserId) }));
            }
          }
        });
        if (batch.length>0){ await Promise.all(batch); console.log('‚úÖ Messaggi segnati come letti'); }
      }catch(e){ console.error('Errore nel segnare messaggi come letti:', e); }
    });

    let userUnsub = null;
    const el = (id)=>document.getElementById(id);
    const show = (node)=>{ node.style.display = (node.id==='auth-overlay' || node.id==='awaiting-approval') ? 'flex' : 'block'; };
    const hide = (node)=> node.style.display = 'none';
    function enableAppUI(){ show(el("app-wrapper")); hide(el("auth-overlay")); hide(el("awaiting-approval")); }
    function disableAppUI(){ hide(el("app-wrapper")); }
    function authErrorMsg(e){
      switch(e?.code){
        case 'auth/weak-password': return 'La password deve avere almeno 6 caratteri.';
        case 'auth/email-already-in-use': return 'Questa email √® gi√† registrata. Prova ad accedere.';
        case 'auth/invalid-email': return 'Email non valida.';
        case 'auth/invalid-credential': return 'Credenziali non valide.';
        case 'auth/network-request-failed': return 'Problema di rete. Controlla la connessione.';
        default: return e?.message || 'Errore imprevisto.';
      }
    }
    const disableBtn = (btn,on)=> btn.disabled=!!on;

// ‚úÖ USERBAR CON PULSANTE ESCI INTEGRATO
function renderUserBar(uAuth,uData){
  const box = document.getElementById("userbar"); if(!box) return;
  const name  = (uData?.name || uAuth?.displayName || (uAuth?.email ? uAuth.email.split("@")[0] : "")).trim();
  const email = uAuth?.email || "";
  const role  = (uData?.role) || (uAuth?.uid === ADMIN_UID ? "admin" : "driver");
  
  box.innerHTML = `
    üë§ <strong>${name || "(senza nome)"}</strong>
    <span class="pill">${email}</span>
    <span class="pill">${role}</span>
    <button id="btn-logout-inline" class="pill" style="cursor: pointer; background: #fff; border: 1px solid #cfe3ff; padding: 4px 10px; border-radius: 999px; font-size: 12px; color: #dc2626; font-weight: 600;">
      üö™ Esci
    </button>
  `;
  
  const logoutBtn = document.getElementById('btn-logout-inline');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => signOut(auth));
  }
}

    const tabLogin = el("tab-login");
    const tabRegister = el("tab-register");
    const paneLogin = el("pane-login");
    const paneRegister = el("pane-register");
    const authHeader = el("auth-header");
    function switchAuth(mode){
      if (mode==="login"){ paneLogin.style.display="block"; paneRegister.style.display="none"; tabLogin.classList.add("active"); tabRegister.classList.remove("active"); authHeader.textContent="Accesso"; }
      else { paneLogin.style.display="none"; paneRegister.style.display="block"; tabRegister.classList.add("active"); tabLogin.classList.remove("active"); authHeader.textContent="Registrazione"; }
    }
    tabLogin.addEventListener("click", ()=>switchAuth("login"));
    tabRegister.addEventListener("click", ()=>switchAuth("register"));
    function showAuth(defaultTab="login"){ disableAppUI(); show(el("auth-overlay")); switchAuth(defaultTab); }

    el("btn-register").addEventListener("click", async ()=>{
      const name = el("reg-name").value.trim();
      const email = el("reg-email").value.trim();
      const password = el("reg-password").value;
      if (!name || !email || !password){ alert("Compila nome, email e password."); return; }
      if (password.length<6){ alert("La password deve avere almeno 6 caratteri."); return; }
      disableBtn(el("btn-register"), true);
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(cred.user, { displayName:name });
        await setDoc(doc(db, "users", cred.user.uid), {
          name, email, role:"driver", approved:false, createdAt: serverTimestamp()
        });
        alert("Registrazione completata! Ora attendi l'approvazione dell'amministratore.");
      }catch(e){ alert("Registrazione non riuscita: " + authErrorMsg(e)); }
      finally{ disableBtn(el("btn-register"), false); }
    });

    el("btn-login").addEventListener("click", async ()=>{
      const email = el("log-email").value.trim();
      const password = el("log-password").value;
      if (!email || !password){ alert("Inserisci email e password."); return; }
      disableBtn(el("btn-login"), true);
      try{ await signInWithEmailAndPassword(auth, email, password); }
      catch(e){ alert("Accesso non riuscito: " + authErrorMsg(e)); }
      finally{ disableBtn(el("btn-login"), false); }
    });

el("btn-logout-while-waiting").addEventListener("click", ()=>signOut(auth));
    const messaging = getMessaging(app);
    const VAPID_PUBLIC_KEY = "BG1pU9CLPvIoAwBKbUFtveLXiX8EgSqzUyuoVl465d5zuSzyQZN043nfnN1xamZuDa9gZZEbsNpT-Vs_m_x-nS0";

    async function enablePushForUser(user){
      try{
        if (!('Notification' in window) || !('serviceWorker' in navigator)) return;

        const reg = await navigator.serviceWorker.ready;

        const perm = await Notification.requestPermission();
        if (perm!=='granted'){ console.warn('Permesso notifiche negato'); return; }

        const token = await getToken(messaging, {
          vapidKey: VAPID_PUBLIC_KEY,
          serviceWorkerRegistration: reg
        });
        if (!token){ console.warn('Nessun token FCM ricevuto'); return; }

        await setDoc(doc(db,"users",user.uid), { fcmTokens: { [token]: true } }, { merge:true });
        console.log('‚úÖ FCM token salvato per', user.uid);
      }catch(e){ console.warn('Errore enablePushForUser', e); }
    }

    async function handlePushPermission(user){
      if (!('Notification' in window) || !('serviceWorker' in navigator)) return;
      const wrapper = document.getElementById('push-activation-wrapper');
      const btn = document.getElementById('btn-enable-push');
      if (Notification.permission==='granted'){
        if (wrapper) wrapper.style.display='none';
        await enablePushForUser(user);
      } else {
        if (wrapper) wrapper.style.display='block';
        if (btn){
          btn.onclick = async ()=>{
            btn.disabled = true;
            try{ await enablePushForUser(user); }
            finally{ if (wrapper) wrapper.style.display='none'; btn.disabled=false; }
          };
        }
      }
    }

    onMessage(messaging, (payload)=>{
      console.log('üì® Push in foreground:', payload);
      if (payload.notification){
        const title = payload.notification.title || 'Nuovo messaggio';
        const body  = payload.notification.body  || '';
        createToast(title, body, ()=>{ window.location.href='chat.html'; });
      }
    });

    onAuthStateChanged(auth, async (user)=>{
      if (!user){
        showAuth("login");
        stopClientiListener(); stopRubricaListener(); stopComunicazioniListener(); stopChatListener(); currentUserId=null; updateChatCounter(0);
        if (userUnsub){ userUnsub(); userUnsub=null; }
        const ub = document.getElementById("userbar"); if (ub) ub.innerHTML="";
        return;
      }
      currentUserId = user.uid;

      const uref = doc(db,"users",user.uid);
      const snap = await getDoc(uref);
      if (!snap.exists()){
        await setDoc(uref, {
          name: user.displayName || "", email: user.email,
          role: (user.uid===ADMIN_UID) ? "admin":"driver",
          approved: (user.uid===ADMIN_UID) ? true:false, createdAt: serverTimestamp()
        }, { merge:true });
      } else {
        const dataNow = snap.data() || {};
        if (!("role" in dataNow)){ await updateDoc(uref, { role: (user.uid===ADMIN_UID) ? "admin" : "driver" }); }
        await setDoc(uref, {
          name: dataNow.name || user.displayName || "", email: dataNow.email || user.email || ""
        }, { merge:true });
      }

      if (userUnsub){ userUnsub(); userUnsub=null; }
      userUnsub = onSnapshot(uref, (usnap)=>{
        const data = usnap.data() || {};
        nomeUtente = (data.name || (user.email ? user.email.split("@")[0] : "")).trim();
        renderUserBar(user, data);

        if (data.role==="driver" && data.approved===true){
          enableAppUI(); 
          startClientiListener(); 
          startRubricaListener(); 
          startComunicazioniListener();
          startChatListener(user.uid);
          handlePushPermission(user);
          requestNotificationPermissionOnFirstLogin();
          
        } else if (data.role==="admin"){
          disableAppUI(); hide(el("auth-overlay")); show(el("awaiting-approval"));
          el("awaiting-approval").innerHTML =
            "<h3>üëë Sei loggato come admin</h3><div>L'app operativa √® solo per gli autisti approvati. Vai su <a href='admin.html'>admin.html</a>.</div><button id='btn-logout-while-waiting' style='margin-top:6px; max-width:200px;'>Esci</button>";
          document.getElementById('btn-logout-while-waiting').onclick = ()=>signOut(auth);
          stopClientiListener(); stopRubricaListener(); stopComunicazioniListener(); stopChatListener(); handlePushPermission(user);
        } else {
          disableAppUI(); hide(el("auth-overlay")); show(el("awaiting-approval"));
          const nomeUtentePendente = data.name || user.displayName || user.email?.split("@")[0] || "Utente";
          el("awaiting-approval").innerHTML = `
            <h3 style="margin:0;">‚è≥ Account in attesa di approvazione</h3>
            <div>Ciao <strong>${nomeUtentePendente}</strong>! Sei registrato ma non ancora approvato. Quando l'amministratore ti abiliter√†, questa pagina si aggiorner√† automaticamente.</div>
            <button id="btn-logout-while-waiting" style="margin-top:6px; max-width:200px;">Esci</button>
          `;
          document.getElementById('btn-logout-while-waiting').onclick = ()=>signOut(auth);
          stopClientiListener(); stopRubricaListener(); stopComunicazioniListener(); stopChatListener();
        }
      });
    });

    async function aggiungiOmodificaCliente() {
      const nome = el("nome").value.trim();
      const indirizzo = el("indirizzo").value.trim();
      const coordinate = el("coordinate").value.trim();
      const note = el("note").value.trim();
      if (!nome) { alert("Inserisci almeno il nome del cliente."); return; }

      const user = auth.currentUser;
      const autore = {
        uid: user?.uid || null,
        name: (nomeUtente || user?.displayName || (user?.email ? user.email.split("@")[0] : "")) || "",
        email: user?.email || ""
      };

      const payload = { nome, indirizzo, coordinate, note };

      if (clienteDaModificare) {
        const docRef = doc(db, "clienti", clienteDaModificare);
        try {
          await updateDoc(docRef, payload);
          clienteDaModificare = null;
          el("btn-aggiungi").innerText = "Aggiungi cliente";
          el("btn-annulla").style.display = "none";
        } catch (error) {
          alert("Impossibile salvare le modifiche: il cliente non esiste pi√π.");
          console.error(error);
        }
      } else {
        await addDoc(clientiRef, {
          ...payload,
          createdAt: serverTimestamp(),
          createdBy: autore
        });
      }

      resetForm();
    }

    function resetForm() {
      el("nome").value=""; 
      el("indirizzo").value=""; 
      el("coordinate").value=""; 
      el("note").value="";
      
      const indirizzoField = el("indirizzo");
      const toggleBtn = el("btn-manual-address");
      indirizzoField.readOnly = true;
      indirizzoField.style.backgroundColor = '#f8f9fa';
      indirizzoField.style.color = '#6c757d';
      indirizzoField.style.cursor = 'not-allowed';
      indirizzoField.placeholder = "Clicca 'Usa la mia posizione attuale' per compilare automaticamente";
      toggleBtn.textContent = 'Inserimento manuale';
      toggleBtn.style.backgroundColor = '#e9ecef';
      
      clienteDaModificare = null;
      el("btn-aggiungi").innerText = "Aggiungi cliente";
      el("btn-annulla").style.display = "none";
    }

    async function eliminaCliente(id) {
      if (confirm("Sei sicuro di voler eliminare questo cliente?")) {
        await deleteDoc(doc(db, "clienti", id));
      }
    }

    function preparaModificaCliente(id, cliente) {
      el("nome").value = cliente.nome; el("indirizzo").value = cliente.indirizzo;
      el("coordinate").value = cliente.coordinate || ""; el("note").value = cliente.note || "";
      clienteDaModificare = id; el("btn-aggiungi").innerText = "Salva modifiche"; el("btn-annulla").style.display = "inline-block";
      
      const indirizzoField = el("indirizzo");
      const toggleBtn = el("btn-manual-address");
      indirizzoField.readOnly = false;
      indirizzoField.style.backgroundColor = '#fff';
      indirizzoField.style.color = '#000';
      indirizzoField.style.cursor = 'text';
      toggleBtn.textContent = 'Blocca modifica';
      toggleBtn.style.backgroundColor = '#fff3cd';
    }

    function annullaModifica() {
      resetForm();
    }

function mostraClienti(snapshot) {
  const clientiDiv = el("clienti");
  const countElement = el("client-count");
  const searchInput = el("cerca");
  
  // ‚úÖ SALVA IL VALORE DELLA RICERCA PRIMA DI RIGENERARE
  const currentSearchQuery = searchInput ? searchInput.value.trim() : '';
  
  clientiDiv.innerHTML = "";
  
  if (snapshot.empty) {
    clientiDiv.innerHTML = '<div class="loading-clients">Nessun cliente trovato</div>';
    countElement.textContent = "0";
    document.getElementById('client-stats').style.display = 'none';
    return;
  }
  
  const clientiArray = [];
  snapshot.forEach(docSnap => {
    const cliente = docSnap.data();
    cliente.id = docSnap.id;
    clientiArray.push(cliente);
  });
  
  clientiArray.sort((a, b) => {
    const nomeA = (a.nome || "").toLowerCase().trim();
    const nomeB = (b.nome || "").toLowerCase().trim();
    return nomeA.localeCompare(nomeB, 'it', { numeric: true });
  });
  
  countElement.textContent = clientiArray.length.toString();
  
  const gruppi = {};
  clientiArray.forEach(cliente => {
    const primaLettera = (cliente.nome || "?").charAt(0).toUpperCase();
    if (!gruppi[primaLettera]) {
      gruppi[primaLettera] = [];
    }
    gruppi[primaLettera].push(cliente);
  });
  
  const lettereOrdinate = Object.keys(gruppi).sort();
  
  lettereOrdinate.forEach(lettera => {
    if (clientiArray.length > 10) {
      const divider = document.createElement("div");
      divider.className = "alphabet-divider";
      divider.textContent = `${lettera} (${gruppi[lettera].length})`;
      clientiDiv.appendChild(divider);
    }
    
    gruppi[lettera].forEach(cliente => {
      const div = document.createElement("div");
      div.className = "cliente";
      
      const inseritoDa = cliente.createdBy ? 
        `<div style="font-size: 12px; color: #666; margin-top: 8px;">
          üìù Inserito da: <strong>${cliente.createdBy.name || "sconosciuto"}</strong>
          ${cliente.createdAt?.toDate ? " ‚Ä¢ " + formatDateRelative(cliente.createdAt.toDate()) : ""}
        </div>` : "";
      
      const noteCliente = cliente.note || cliente.notes || "";
      const noteHtml = noteCliente && String(noteCliente).trim() ? 
        `<div style="margin: 6px 0;">
          <strong style="color: #007bff;">üìù Note:</strong><br>
          <em style="color: #495057; font-size: 13px; background: #f8f9fa; padding: 4px 8px; border-radius: 4px; display: block; margin-top: 4px;">
            ${String(noteCliente).trim()}
          </em>
        </div>` : "";
      
      div.innerHTML = `
        <strong>${cliente.nome || "(senza nome)"}</strong><br>
        <div style="color: #6c757d; font-size: 14px; margin: 4px 0;">
          ${cliente.indirizzo || ""}
        </div>
        ${cliente.coordinate ? 
          `<div style="margin: 6px 0;">
            <a href='https://maps.google.com/?q=${cliente.coordinate}' target='_blank' 
               style="color: #007bff; text-decoration: none; font-size: 13px;">
              üó∫Ô∏è Vai a Google Maps
            </a>
          </div>` : ""
        }
        ${noteHtml}
        ${inseritoDa}
        <div style="margin-top: 10px;">
          <button class='btn-azione' onclick='eliminaCliente("${cliente.id}")' 
                  style="background-color: #dc3545; color: white; border: none;">
            üóëÔ∏è Elimina
          </button>
          <button class='btn-azione' onclick='preparaModificaCliente("${cliente.id}", ${JSON.stringify(cliente).replace(/"/g, '&quot;')})' 
                  style="background-color: #28a745; color: white; border: none;">
            ‚úèÔ∏è Modifica
          </button>
        </div>
      `;
      clientiDiv.appendChild(div);
    });
  });
  
  // ‚úÖ RIAPPLICA IL FILTRO SE C'ERA UNA RICERCA ATTIVA
  if (currentSearchQuery) {
    setTimeout(() => {
      filtraClienti();
      
      // ‚úÖ Mantieni visibile il pulsante X se c'√® testo
      const clearBtn = document.getElementById('clear-search');
      if (clearBtn) {
        clearBtn.style.display = 'flex';
      }
    }, 50);
  }
  
  if (isClientListExpanded) {
    updateClientStats();
  }
}
    function filtraClienti() {
      const queryTxt = el("cerca").value.toLowerCase().trim();
      
      if (!queryTxt) {
        document.querySelectorAll(".alphabet-divider").forEach(divider => {
          divider.style.display = "block";
        });
        document.querySelectorAll(".cliente").forEach(cliente => {
          cliente.style.display = "block";
        });
        return;
      }
      
      document.querySelectorAll(".alphabet-divider").forEach(divider => {
        divider.style.display = "none";
      });
      
      document.querySelectorAll(".cliente").forEach(cliente => {
        const nomeElement = cliente.querySelector('strong');
        const nomeCliente = nomeElement ? nomeElement.textContent.toLowerCase() : '';
        
        const visible = nomeCliente.includes(queryTxt);
        cliente.style.display = visible ? "block" : "none";
      });
      
      if (!isClientListExpanded) {
        toggleClientList();
      }
    }

    el("btn-aggiungi").addEventListener("click", aggiungiOmodificaCliente);
    el("btn-annulla").addEventListener("click", annullaModifica);
    
    el("cerca").addEventListener("input", function() {
      filtraClienti();
      const clearBtn = document.getElementById('clear-search');
      if (this.value.trim()) {
        clearBtn.style.display = 'flex';
      } else {
        clearBtn.style.display = 'none';
      }
    });

    document.getElementById('clear-search').addEventListener('click', function() {
      const searchInput = document.getElementById('cerca');
      searchInput.value = '';
      this.style.display = 'none';
      filtraClienti();
    });

    el("nome").addEventListener("input", function() {
      const clearBtn = document.getElementById('clear-nome');
      if (this.value.trim()) {
        clearBtn.style.display = 'flex';
      } else {
        clearBtn.style.display = 'none';
      }
    });

    document.getElementById('clear-nome').addEventListener('click', function() {
      const nomeInput = document.getElementById('nome');
      nomeInput.value = '';
      this.style.display = 'none';
      nomeInput.focus();
    });
    
    el("cerca-rubrica").addEventListener("input", filtraRubrica);

    el("btn-rubrica").addEventListener("click", () => {
      el("rubrica-overlay").style.display = "flex";
      el("cerca-rubrica").value = "";
      filtraRubrica();
    });
    el("close-rubrica").addEventListener("click", () => { el("rubrica-overlay").style.display = "none"; });
    el("rubrica-overlay").addEventListener("click", (e) => { if (e.target === el("rubrica-overlay")) el("rubrica-overlay").style.display = "none"; });

el("btn-comunicazioni").addEventListener("click", async () => {
  el("comunicazioni-overlay").style.display = "flex";
  
  // ‚úÖ Segna tutte le comunicazioni come lette quando si apre il pannello
  if (currentUserId) {
    try {
      const comunicazioniSnapshot = await getDocs(collection(db, "comunicazioni"));
      const batchUpdates = [];
      
      comunicazioniSnapshot.forEach(docSnap => {
        const comunicazione = docSnap.data();
        const readBy = Array.isArray(comunicazione.readBy) ? comunicazione.readBy : [];
        
        // Solo se non √® gi√† stata letta
        if (!readBy.includes(currentUserId)) {
          const comunicazioneRef = doc(db, "comunicazioni", docSnap.id);
          batchUpdates.push(
            updateDoc(comunicazioneRef, {
              readBy: arrayUnion(currentUserId)
            })
          );
        }
      });
      
      if (batchUpdates.length > 0) {
        await Promise.all(batchUpdates);
        console.log('‚úÖ Comunicazioni segnate come lette');
      }
    } catch (error) {
      console.error('Errore nel segnare comunicazioni come lette:', error);
    }
  }
});    el("close-comunicazioni").addEventListener("click", () => { 
      el("comunicazioni-overlay").style.display = "none"; 
    });
    el("comunicazioni-overlay").addEventListener("click", (e) => { 
      if (e.target === el("comunicazioni-overlay")) {
        el("comunicazioni-overlay").style.display = "none"; 
      }
    });

    el("btn-gps").addEventListener("click", async () => {
      if (!auth.currentUser) { alert("Devi essere loggato."); return; }
      if (!('geolocation' in navigator)) { alert("Geolocalizzazione non supportata."); return; }

      const mezzoNome = (nomeUtente || auth.currentUser.displayName || (auth.currentUser.email?.split("@")[0] ?? "")).trim() || 'Senza nome';
      const docRef = doc(db, 'posizioniMezzo', auth.currentUser.uid);

      el("btn-gps").textContent = "üìç Ottenendo posizione...";
      el("btn-gps").disabled = true;

      navigator.geolocation.getCurrentPosition(async position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        el("coordinate").value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        
        try {
          el("btn-gps").textContent = "üè† Ottenendo indirizzo...";
          
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
            {
              headers: {
                'User-Agent': 'ArchivioClienti-Trasporti/1.0'
              }
            }
          );
          
          if (response.ok) {
            const data = await response.json();
            
            if (data && data.address) {
              const addr = data.address;
              const parts = [];
              
              if (addr.house_number && addr.road) {
                parts.push(`${addr.road} ${addr.house_number}`);
              } else if (addr.road) {
                parts.push(addr.road);
              }
              
              if (addr.city || addr.town || addr.village) {
                parts.push(addr.city || addr.town || addr.village);
              }
              
              if (addr.state || addr.province) {
                parts.push(addr.state || addr.province);
              }
              
              if (addr.country && addr.country !== 'Italia' && addr.country !== 'Italy') {
                parts.push(addr.country);
              }
              
              if (parts.length > 0) {
                el("indirizzo").value = parts.join(', ');
              } else {
                el("indirizzo").value = data.display_name || `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
              }
            } else {
              el("indirizzo").value = `Posizione: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
          } else {
            el("indirizzo").value = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
          }
        } catch (error) {
          console.warn("Errore reverse geocoding:", error);
          el("indirizzo").value = `Coordinate: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        }

        try {
          await setDoc(docRef, {
            uid: auth.currentUser.uid,
            mezzo: mezzoNome,
            lat, lng,
            accuracy: position.coords.accuracy,
            online: true,
            updatedAt: serverTimestamp()
          }, { merge: true });
        } catch (error) {
          console.warn("Errore salvataggio posizione:", error);
        }
        
        el("btn-gps").textContent = "üìç Usa la mia posizione attuale";
        el("btn-gps").disabled = false;
        
      }, err => {
        alert("Impossibile ottenere la posizione. Assicurati che il GPS sia attivo.");
        console.error(err);
        
        el("btn-gps").textContent = "üìç Usa la mia posizione attuale";
        el("btn-gps").disabled = false;
      }, { 
        enableHighAccuracy: true, 
        maximumAge: 5000, 
        timeout: 15000 
      });
    });

    el("btn-manual-address").addEventListener("click", () => {
      const indirizzoField = el("indirizzo");
      const toggleBtn = el("btn-manual-address");
      
      if (indirizzoField.readOnly) {
        indirizzoField.readOnly = false;
        indirizzoField.style.backgroundColor = '#fff';
        indirizzoField.style.color = '#000';
        indirizzoField.style.cursor = 'text';
        indirizzoField.placeholder = 'Inserisci indirizzo manualmente';
        toggleBtn.textContent = 'Blocca modifica';
        toggleBtn.style.backgroundColor = '#fff3cd';
        indirizzoField.focus();
      } else {
        indirizzoField.readOnly = true;
        indirizzoField.style.backgroundColor = '#f8f9fa';
        indirizzoField.style.color = '#6c757d';
        indirizzoField.style.cursor = 'not-allowed';
        indirizzoField.placeholder = "Clicca 'Usa la mia posizione attuale' per compilare automaticamente";
        toggleBtn.textContent = 'Inserimento manuale';
        toggleBtn.style.backgroundColor = '#e9ecef';
      }
    });




    window.eliminaCliente = eliminaCliente;
    window.preparaModificaCliente = preparaModificaCliente;
    window.toggleClientList = toggleClientList;
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./firebase-messaging-sw.js', {
        scope: './'
      })
      .then(() => console.log('‚úÖ SW registrato per Netlify'))
      .catch(err => console.warn('SW registration failed', err));
    }
  </script>
</body>
</html>