<!DOCTYPE html>
<html>
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archivio Clienti - Trasporti</title>
  <style>
    :root { --bg:#f9f9f9; --card:#fff; --txt:#222; --muted:#666; --brand:#007bff; }
    body { font-family: Arial, sans-serif; padding: 15px; margin: 0; background-color: var(--bg); color:var(--txt); }
    h1 { font-size: 22px; margin-bottom: 10px; }
    input, textarea, button, select { margin: 6px 0; width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; }
    #clienti { margin-top: 20px; }
    .cliente { border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 8px; background-color: var(--card); }
    .btn-azione { margin-top: 8px; margin-right: 5px; font-size: 14px; padding: 6px 10px; }
    .avviso { background-color: #fff3cd; padding: 10px; border-left: 5px solid #ffc107; margin-bottom: 20px; border-radius: 5px; font-size: 14px; }
    #auth-overlay, #awaiting-approval { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: none; align-items: center; justify-content: center; padding: 20px; }
    #auth-box { width: 100%; max-width: 420px; background: var(--card); border: 1px solid #ddd; border-radius: 12px; padding: 0; box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
    #auth-header { padding: 14px 16px; border-bottom:1px solid #eee; font-weight:700; display:flex; gap:8px; align-items:center; }
    #auth-header::before { content:"üîí"; }
    .tabs { display:flex; gap:0; border-bottom:1px solid #eee; }
    .tab { flex:1; padding:10px 12px; background:#fafafa; border:none; border-right:1px solid #eee; cursor:pointer; font-weight:600; }
    .tab:last-child { border-right:none; }
    .tab.active { background:#fff; color:#000; border-bottom:2px solid var(--brand); }
    .pane { padding: 14px 16px; }
    .muted { color: var(--muted); font-size: 13px; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    #status { margin-top: 10px; font-size: 14px; font-style: italic; }
    button { cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .userbar{ background:#eef6ff; border:1px solid #cfe3ff; color:#0b3d91; padding:8px 12px; border-radius:8px; margin:8px 0 12px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; font-size:14px; }
    .userbar .pill{ background:#fff; border:1px solid #cfe3ff; padding:2px 8px; border-radius:999px; font-size:12px; color:#1b3c6b; }
    .link-pill{ display:inline-block; padding:8px 12px; border:1px solid #cfe3ff; border-radius:8px; background:#eef6ff; color:#0b3d91; text-decoration:none; }
  </style>
</head>
<body>

  <!-- OVERLAY AUTH -->
  <div id="auth-overlay">
    <div id="auth-box">
      <div id="auth-header">Accesso</div>

      <div class="tabs">
        <button id="tab-login" class="tab active">Accedi</button>
        <button id="tab-register" class="tab">Registrati</button>
      </div>

      <div id="pane-login" class="pane">
        <input id="log-email" placeholder="Email">
        <input id="log-password" placeholder="Password" type="password">
        <button id="btn-login">Accedi</button>
      </div>

      <div id="pane-register" class="pane" style="display:none;">
        <input id="reg-name" placeholder="Nome (Es: Camion Alessio)">
        <input id="reg-email" placeholder="Email">
        <input id="reg-password" placeholder="Password (min 6 caratteri)" type="password">
        <button id="btn-register">Crea account</button>
        <div class="muted" style="margin-top:8px;">Dopo la registrazione l‚Äôaccount deve essere approvato dall‚Äôamministratore.</div>
      </div>
    </div>
  </div>

  <!-- ATTESA APPROVAZIONE / BLOCCO ADMIN -->
  <div id="awaiting-approval" class="avviso" style="display:none; flex-direction:column; gap:8px; align-items:center; text-align:center;">
    <h3 style="margin:0;">‚è≥ Account in attesa di approvazione</h3>
    <div>Sei registrato ma non ancora approvato. Quando l‚Äôamministratore ti abilita, questa pagina si aggiorner√† automaticamente.</div>
    <button id="btn-logout-while-waiting" style="margin-top:6px; max-width:200px;">Esci</button>
  </div>

  <!-- APP -->
  <div id="app-wrapper" style="display:none;">
    <h1>Archivio Clienti - Trasporti</h1>
    <div id="userbar" class="userbar"></div>

    <div class="avviso">
      ‚ö†Ô∏è <strong>Attenzione:</strong> Questa app contiene dati riservati dei clienti ed √® destinata esclusivamente all'uso operativo da parte di trasportatori autorizzati.
    </div>

    <div class="row" style="align-items:center;">
      <a class="link-pill" href="chat.html">üí¨ Chat con Admin</a>
      <button id="btn-logout" style="max-width:160px;">Esci</button>
    </div>

    <div>
      <input id="nome" placeholder="Nome cliente">
      <input id="indirizzo" placeholder="Indirizzo">
      <input id="coordinate" placeholder="Coordinate (es: 44.8015, 10.3274)">
      <button id="btn-gps" type="button">üìç Usa la mia posizione attuale</button>
      <textarea id="note" placeholder="Note per la consegna"></textarea>
      <button id="btn-aggiungi">Aggiungi cliente</button>
      <button id="btn-annulla" style="display:none; background-color: #eee;">Annulla modifica</button>
    </div>

    <div><input id="cerca" placeholder="Cerca cliente"></div>
    <div id="clienti"></div>

    <hr>
    <h2>üì° Tracciamento automatico</h2>
    <button id="btn-tracciamento" onclick="avviaTracciamento()">‚ñ∂Ô∏è Attiva tracciamento automatico</button>
    <div id="status"></div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBbjK5sgQ70-p8jODaK_PnLIzPxgfrqQ34",
      authDomain: "archivio-clienti-trasporti.firebaseapp.com",
      projectId: "archivio-clienti-trasporti",
      storageBucket: "archivio-clienti-trasporti.firebasestorage.app",
      messagingSenderId: "773533170263",
      appId: "1:773533170263:web:d05e2b00e991b0294c0112"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc, setDoc, updateDoc,
      onSnapshot, query, getDocs, getDoc, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      onAuthStateChanged, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    const ADMIN_UID = "0dCvHDcVp1PHuWVNIN9i6ZvEVBt2";

    const clientiRef   = collection(db, "clienti");
    const posizioniRef = collection(db, "posizioniMezzo");

    let nomeUtente = ""; // letto da Firestore o email
    let clienteDaModificare = null;

    let clientiUnsub = null;
    function startClientiListener() {
      if (clientiUnsub) return;
      const q = query(clientiRef);
      clientiUnsub = onSnapshot(q, mostraClienti, (err) => console.error(err));
    }
    function stopClientiListener() { if (clientiUnsub) { clientiUnsub(); clientiUnsub = null; } }

    let userUnsub = null;
    const el = (id) => document.getElementById(id);
    const show = (node) => { node.style.display = (node.id === 'auth-overlay' || node.id === 'awaiting-approval') ? 'flex' : 'block'; };
    const hide = (node) => node.style.display = 'none';
    function enableAppUI() { show(el("app-wrapper")); hide(el("auth-overlay")); hide(el("awaiting-approval")); }
    function disableAppUI() { hide(el("app-wrapper")); }
    function authErrorMsg(e) {
      switch (e?.code) {
        case 'auth/weak-password': return 'La password deve avere almeno 6 caratteri.';
        case 'auth/email-already-in-use': return 'Questa email √® gi√† registrata. Prova ad accedere.';
        case 'auth/invalid-email': return 'Email non valida.';
        case 'auth/invalid-credential': return 'Credenziali non valide.';
        case 'auth/network-request-failed': return 'Problema di rete. Controlla la connessione.';
        default: return e?.message || 'Errore imprevisto.';
      }
    }
    const disableBtn = (btn, on) => btn.disabled = !!on;

    function renderUserBar(uAuth, uData) {
      const box = document.getElementById("userbar");
      if (!box) return;
      const name  = (uData?.name || uAuth?.displayName || (uAuth?.email ? uAuth.email.split("@")[0] : "")).trim();
      const email = uAuth?.email || "";
      const role  = (uData?.role) || (uAuth?.uid === ADMIN_UID ? "admin" : "driver");
      nomeUtente = name;
      box.innerHTML = `üë§ <strong>${name || "(senza nome)"}</strong>
                       <span class="pill">${email}</span>
                       <span class="pill">${role}</span>`;
    }

    const tabLogin = el("tab-login");
    const tabRegister = el("tab-register");
    const paneLogin = el("pane-login");
    const paneRegister = el("pane-register");
    const authHeader = el("auth-header");

    function switchAuth(mode) {
      if (mode === "login") {
        paneLogin.style.display = "block";
        paneRegister.style.display = "none";
        tabLogin.classList.add("active");
        tabRegister.classList.remove("active");
        authHeader.textContent = "Accesso";
      } else {
        paneLogin.style.display = "none";
        paneRegister.style.display = "block";
        tabRegister.classList.add("active");
        tabLogin.classList.remove("active");
        authHeader.textContent = "Registrazione";
      }
    }
    tabLogin.addEventListener("click", () => switchAuth("login"));
    tabRegister.addEventListener("click", () => switchAuth("register"));
    function showAuth(defaultTab = "login") { disableAppUI(); show(el("auth-overlay")); switchAuth(defaultTab); }

    // REGISTRAZIONE
    el("btn-register").addEventListener("click", async () => {
      const name = el("reg-name").value.trim();
      const email = el("reg-email").value.trim();
      const password = el("reg-password").value;
      if (!name || !email || !password) { alert("Compila nome, email e password."); return; }
      if (password.length < 6) { alert("La password deve avere almeno 6 caratteri."); return; }
      disableBtn(el("btn-register"), true);
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(cred.user, { displayName: name });
        await setDoc(doc(db, "users", cred.user.uid), {
          name, email, role: "driver", approved: false, createdAt: serverTimestamp()
        });
        alert("Registrazione completata! Ora attendi l'approvazione dell'amministratore.");
      } catch (e) {
        alert("Registrazione non riuscita: " + authErrorMsg(e));
      } finally {
        disableBtn(el("btn-register"), false);
      }
    });

    // LOGIN
    el("btn-login").addEventListener("click", async () => {
      const email = el("log-email").value.trim();
      const password = el("log-password").value;
      if (!email || !password) { alert("Inserisci email e password."); return; }
      disableBtn(el("btn-login"), true);
      try { await signInWithEmailAndPassword(auth, email, password); }
      catch (e) { alert("Accesso non riuscito: " + authErrorMsg(e)); }
      finally { disableBtn(el("btn-login"), false); }
    });

    // LOGOUT
    el("btn-logout").addEventListener("click", () => signOut(auth));
    el("btn-logout-while-waiting").addEventListener("click", () => signOut(auth));

    // üîî --- PUSH MESSAGING (FCM) ---
    const messaging = getMessaging(app);
    const VAPID_PUBLIC_KEY = "BG1pU9CLPvIoAwBKbUFtveLXiX8EgSqzUyuoVl465d5zuSzyQZN043nfnN1xamZuDa9gZZEbsNpT-Vs_m_x-nS0";

    async function enablePushForUser(user){
      try {
        if (!('Notification' in window) || !('serviceWorker' in navigator)) return;
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') return;
        const token = await getToken(messaging, { vapidKey: VAPID_PUBLIC_KEY });
        if (!token) return;
        await setDoc(doc(db, "users", user.uid), { fcmTokens: { [token]: true } }, { merge: true });
      } catch (e) {
        console.warn('Errore permission/token', e);
      }
    }

    onMessage(messaging, (payload) => {
      console.log('Push in foreground:', payload);
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        showAuth("login");
        stopClientiListener();
        if (userUnsub) { userUnsub(); userUnsub = null; }
        const ub = document.getElementById("userbar"); if (ub) ub.innerHTML = "";
        return;
      }

      const uref = doc(db, "users", user.uid);
      const snap = await getDoc(uref);

      if (!snap.exists()) {
        await setDoc(uref, {
          name: user.displayName || "",
          email: user.email,
          role: (user.uid === ADMIN_UID) ? "admin" : "driver",
          approved: (user.uid === ADMIN_UID) ? true : false,
          createdAt: serverTimestamp()
        }, { merge: true });
      } else {
        const dataNow = snap.data() || {};
        if (!("role" in dataNow)) {
          await updateDoc(uref, { role: (user.uid === ADMIN_UID) ? "admin" : "driver" });
        }
        await setDoc(uref, {
          name: dataNow.name || user.displayName || "",
          email: dataNow.email || user.email || ""
        }, { merge: true });
      }

      if (userUnsub) { userUnsub(); userUnsub = null; }
      userUnsub = onSnapshot(uref, (usnap) => {
        const data = usnap.data() || {};
        renderUserBar(user, data);

        if (data.role === "driver" && data.approved === true) {
          enableAppUI(); startClientiListener();
          enablePushForUser(user);
        } else if (data.role === "admin") {
          disableAppUI(); hide(el("auth-overlay")); show(el("awaiting-approval"));
          el("awaiting-approval").innerHTML =
            "<h3>üëë Sei loggato come admin</h3><div>L‚Äôapp operativa √® solo per gli autisti approvati. Vai su <a href='admin.html'>admin.html</a>.</div><button id='btn-logout-while-waiting' style='margin-top:6px; max-width:200px;'>Esci</button>";
          document.getElementById('btn-logout-while-waiting').onclick = () => signOut(auth);
          stopClientiListener();
          enablePushForUser(user);
        } else {
          disableAppUI(); hide(el("auth-overlay")); show(el("awaiting-approval"));
          el("awaiting-approval").querySelector("h3").textContent = "‚è≥ Account in attesa di approvazione";
          stopClientiListener();
        }
      });
    });

    async function aggiungiOmodificaCliente() {
      const nome = el("nome").value;
      const indirizzo = el("indirizzo").value;
      const coordinate = el("coordinate").value;
      const note = el("note").value;
      if (!nome || !indirizzo) { alert("Inserisci almeno nome e indirizzo."); return; }

      if (clienteDaModificare) {
        const docRef = doc(db, "clienti", clienteDaModificare);
        try {
          await updateDoc(docRef, { nome, indirizzo, coordinate, note });
          clienteDaModificare = null;
          el("btn-aggiungi").innerText = "Aggiungi cliente";
          el("btn-annulla").style.display = "none";
        } catch (error) {
          alert("Impossibile salvare le modifiche: il cliente non esiste pi√π.");
          console.error(error);
        }
      } else {
        await addDoc(clientiRef, { nome, indirizzo, coordinate, note, timestamp: serverTimestamp() });
      }
      el("nome").value = ""; el("indirizzo").value = ""; el("coordinate").value = ""; el("note").value = "";
    }

    async function eliminaCliente(id) {
      if (confirm("Sei sicuro di voler eliminare questo cliente?")) {
        await deleteDoc(doc(db, "clienti", id));
      }
    }

    function preparaModificaCliente(id, cliente) {
      el("nome").value = cliente.nome; el("indirizzo").value = cliente.indirizzo;
      el("coordinate").value = cliente.coordinate || ""; el("note").value = cliente.note || "";
      clienteDaModificare = id; el("btn-aggiungi").innerText = "Salva modifiche"; el("btn-annulla").style.display = "inline-block";
    }

    function annullaModifica() {
      clienteDaModificare = null;
      el("nome").value = ""; el("indirizzo").value = ""; el("coordinate").value = ""; el("note").value = "";
      el("btn-aggiungi").innerText = "Aggiungi cliente"; el("btn-annulla").style.display = "none";
    }

    function mostraClienti(snapshot) {
      const clientiDiv = el("clienti"); clientiDiv.innerHTML = "";
      snapshot.forEach(docSnap => {
        const c = docSnap.data();
        const div = document.createElement("div");
        div.className = "cliente";
        div.innerHTML = `<strong>${c.nome || "(senza nome)"}</strong><br>
                         ${c.indirizzo || ""}<br>
                         ${c.coordinate ? `<a href='https://maps.google.com/?q=${c.coordinate}' target='_blank'>Vai a Google Maps</a><br>` : ""}
                         ${c.note ? `<em>${c.note}</em><br>` : ""}
                         <button class='btn-azione' onclick='eliminaCliente("${docSnap.id}")'>üóëÔ∏è Elimina</button>
                         <button class='btn-azione' onclick='preparaModificaCliente("${docSnap.id}", ${JSON.stringify(c).replace(/"/g, '&quot;')})'>‚úèÔ∏è Modifica</button>`;
        clientiDiv.appendChild(div);
      });
    }

    function filtraClienti() {
      const queryTxt = el("cerca").value.toLowerCase();
      const clienti = document.querySelectorAll(".cliente");
      clienti.forEach(c => { c.style.display = c.innerText.toLowerCase().includes(queryTxt) ? "block" : "none"; });
    }

    el("btn-aggiungi").addEventListener("click", aggiungiOmodificaCliente);
    el("btn-annulla").addEventListener("click", annullaModifica);
    el("cerca").addEventListener("input", filtraClienti);

    // ================== GEO ==================

    // Bottone "Usa la mia posizione attuale" -> aggiorna campo e salva ultimo fix in posizioniMezzo/{uid}
    el("btn-gps").addEventListener("click", () => {
      if (!("geolocation" in navigator)) { alert("Geolocalizzazione non supportata."); return; }
      navigator.geolocation.getCurrentPosition(
        async position => {
          const { latitude, longitude, accuracy } = position.coords;
          const coords = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
          el("coordinate").value = coords;

          if (auth.currentUser) {
            const posRef = doc(db, "posizioniMezzo", auth.currentUser.uid);
            await setDoc(posRef, {
              uid: auth.currentUser.uid,
              mezzo: nomeUtente || (auth.currentUser.email || auth.currentUser.uid),
              latitudine: latitude,
              longitudine: longitude,
              accuracy: accuracy ?? null,
              timestamp: serverTimestamp()
            }, { merge: true });

            await setDoc(doc(db, "users", auth.currentUser.uid), {
              lastSeen: serverTimestamp(),
              lastPos: { lat: latitude, lng: longitude, accuracy: accuracy ?? null }
            }, { merge: true });
          }
        },
        error => {
          alert("Impossibile ottenere la posizione. Controlla i permessi GPS.");
          console.error(error);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });

    // Tracciamento automatico: un solo doc per mezzo, + flag users/{uid}.tracking
    let trackingWatchId = null;
    const GEO = { accuracyMaxM: 150, minIntervalMs: 30000 };
    let lastSaveTs = 0;

    async function setTrackingState(on) {
      if (!auth.currentUser) return;
      await setDoc(doc(db, "users", auth.currentUser.uid), { tracking: !!on }, { merge: true });
    }

    window.avviaTracciamento = function(){
      const status = document.getElementById('status');

      if (!('geolocation' in navigator)) {
        status.textContent = 'Geolocalizzazione non supportata.';
        return;
      }

      // Spegni se gi√† attivo
      if (trackingWatchId) {
        navigator.geolocation.clearWatch(trackingWatchId);
        trackingWatchId = null;
        status.textContent = 'Tracciamento disattivato.';
        setTrackingState(false);
        return;
      }

      // Accendi
      status.textContent = 'Tracciamento attivo. Tieni la pagina in primo piano.';
      setTrackingState(true);

      trackingWatchId = navigator.geolocation.watchPosition(async pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        const now = Date.now();

        if ((accuracy ?? Infinity) > GEO.accuracyMaxM) {
          status.textContent = `Fix impreciso (¬±${Math.round(accuracy)} m). Attendo‚Ä¶`;
          return;
        }
        if ((now - lastSaveTs) < GEO.minIntervalMs) {
          status.textContent = 'In attesa (rate limit)‚Ä¶';
          return;
        }

        if (auth.currentUser) {
          const posRef = doc(db, "posizioniMezzo", auth.currentUser.uid);
          await setDoc(posRef, {
            uid: auth.currentUser.uid,
            mezzo: nomeUtente || (auth.currentUser.email || auth.currentUser.uid),
            latitudine: latitude,
            longitudine: longitude,
            accuracy: accuracy ?? null,
            timestamp: serverTimestamp()
          }, { merge: true });

          await setDoc(doc(db, "users", auth.currentUser.uid), {
            tracking: true,
            lastSeen: serverTimestamp(),
            lastPos: { lat: latitude, lng: longitude, accuracy: accuracy ?? null }
          }, { merge: true });
        }

        lastSaveTs = now;
        status.textContent = `Ultimo ping: ${latitude.toFixed(5)}, ${longitude.toFixed(5)} (¬±${Math.round(accuracy)} m)`;
      }, err => {
        status.textContent = 'Errore GPS: ' + err.message;
      }, { enableHighAccuracy: true, maximumAge: 0, timeout: 30000 });
    }

  </script>

  <!-- Service Worker FCM -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .catch(err => console.warn('SW (FCM) registration failed', err));
    }
  </script>
</body>
</html>
