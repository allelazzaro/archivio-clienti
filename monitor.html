
<!DOCTYPE html>
<html>
  <head>
    <title>Monitoraggio Mezzi - Archivio Clienti</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body { font-family: Arial, sans-serif; padding: 0; margin: 0; }
      #map { height: 60vh; width: 100%; }
      #log { padding: 10px; font-size: 14px; }
      .entry { border-bottom: 1px solid #ccc; padding: 6px 0; }
    </style>
  </head>
  <body>
    <h2 style="padding: 10px; background: #007bff; color: white; margin: 0;">üìç Monitoraggio Mezzi</h2>
    <div id="map"></div>
    <div id="log"></div>

    <!-- Firebase -->
    <script type="module">
      const firebaseConfig = {
        apiKey: "AIzaSyAn7oM-P0Dzq4hSze79L2cYnmL8kQiohBk",
        authDomain: "archivio-clienti-trasporti.firebaseapp.com",
        projectId: "archivio-clienti-trasporti",
        storageBucket: "archivio-clienti-trasporti.firebasestorage.app",
        messagingSenderId: "773533170263",
        appId: "1:773533170263:web:d05e2b00e991b0294c0112"
      };

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import { getFirestore, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const posizioniRef = collection(db, "posizioniMezzo");

      let map;
      const markers = new Map();

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 44.8, lng: 10.3 },
          zoom: 7,
        });

        onSnapshot(posizioniRef, snapshot => {
          document.getElementById("log").innerHTML = "";
          const latest = new Map();
          snapshot.forEach(doc => {
            const data = doc.data();
            if (!data.latitudine || !data.longitudine || !data.timestamp) return;
            latest.set(data.mezzo, data);
          });

          latest.forEach((data, mezzo) => {
            const pos = { lat: data.latitudine, lng: data.longitudine };
            if (markers.has(mezzo)) {
              markers.get(mezzo).setPosition(pos);
            } else {
              const marker = new google.maps.Marker({
                position: pos,
                map,
                title: mezzo,
                label: mezzo[0],
              });
              markers.set(mezzo, marker);
            }

            const time = data.timestamp.toDate ? data.timestamp.toDate().toLocaleString() : new Date().toLocaleString();
            const entry = `<div class="entry"><strong>${mezzo}</strong><br>üìç ${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}<br>üïí ${time}</div>`;
            document.getElementById("log").innerHTML += entry;
          });
        });
      }

      window.initMap = initMap;
    </script>

    <!-- Google Maps API (sostituire YOUR_API_KEY) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script>
  </body>
</html>
